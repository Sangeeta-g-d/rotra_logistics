{% extends "admin_base.html" %}
{% load static %}
{% block title %}Edit Driver - {{ driver.full_name }}{% endblock %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>Edit Driver - {{ driver.full_name }}</title>

  <!-- Font Awesome -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Google Fonts: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    body {
      background-color: #f3f4f6;
      color: #111827;
    }

    .dashboard {
      padding: 24px;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* TOP BAR */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding: 16px 24px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .top-bar h2 {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .top-bar h2 i {
      color: #dc2626;
    }

    .back-button {
      padding: 10px 20px;
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .back-button:hover {
      background: #e5e7eb;
    }

    /* FORM CARD */
    .form-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      padding: 32px;
      margin-top: 16px;
    }

    .form-header {
      margin-bottom: 32px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .form-header h3 {
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }

    .form-header p {
      color: #6b7280;
      font-size: 14px;
    }

    /* Form Grid */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 24px;
    }

    .full-width {
      grid-column: 1 / -1;
    }

    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-weight: 500;
      color: #374151;
      margin-bottom: 6px;
      font-size: 14px;
    }

    .required {
      color: #dc2626;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #dc2626;
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
    }

    /* File Upload Area */
    .file-upload-area {
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      background-color: #f9fafb;
      transition: all 0.3s ease;
      cursor: pointer;
      margin-top: 8px;
    }
    
    .file-upload-area:hover,
    .file-upload-area.dragover {
      border-color: #dc2626;
      background-color: #fef2f2;
    }
    
    .file-upload-area i {
      font-size: 24px;
      color: #dc2626;
      margin-bottom: 8px;
    }
    
    .file-upload-area p {
      margin: 0;
      color: #6b7280;
      font-size: 14px;
    }
    
    .browse-link {
      color: #dc2626;
      cursor: pointer;
      text-decoration: underline;
    }
    
    .file-name {
      display: block;
      margin-top: 8px;
      font-size: 12px;
      color: #6b7280;
    }

    .file-name.uploaded {
      color: #16a34a;
      font-weight: 500;
    }

    /* Current Files Section */
    .current-files {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      margin-top: 8px;
    }

    .current-file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #e2e8f0;
    }

    .current-file-item:last-child {
      border-bottom: none;
    }

    .file-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .file-icon {
      color: #6b7280;
    }

    .file-link {
      color: #2563eb;
      text-decoration: none;
      font-size: 13px;
    }

    .file-link:hover {
      text-decoration: underline;
    }

    .file-remove {
      color: #dc2626;
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
    }

    .file-remove:hover {
      background: #fee2e2;
    }

    /* Document Status */
    .document-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      margin-top: 4px;
    }

    .document-status.uploaded {
      background: #dcfce7;
      color: #166534;
    }

    .document-status.not-uploaded {
      background: #fee2e2;
      color: #991b1b;
    }

    /* Form Actions */
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 40px;
      padding-top: 24px;
      border-top: 1px solid #e5e7eb;
    }

    .cancel-btn {
      padding: 10px 20px;
      border: 1px solid #d1d5db;
      background: white;
      color: #374151;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .cancel-btn:hover {
      background: #f9fafb;
    }

    .save-btn {
      padding: 10px 24px;
      background: #dc2626;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .save-btn:hover:not(:disabled) {
      background: #b91c1c;
    }

    .save-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Alert Messages */
    .alert {
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: none;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .alert-success {
      background-color: #dcfce7;
      border: 1px solid #bbf7d0;
      color: #166534;
    }

    .alert-error {
      background-color: #fee2e2;
      border: 1px solid #fecaca;
      color: #991b1b;
    }
  </style>
</head>
<body>
<div class="dashboard">
  <!-- TOP BAR -->
  

  <!-- Alert Messages -->
  <div id="successAlert" class="alert alert-success" style="display: none;"></div>
  <div id="errorAlert" class="alert alert-error" style="display: none;"></div>

  <!-- FORM CARD -->
  <div class="form-card">
    <div class="form-header">
      <h3>Update Driver Details</h3>
      <p>Edit the information below for driver {{ driver.full_name }}</p>
    </div>

    <form id="editDriverForm" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" name="driver_id" value="{{ driver.id }}">

      <!-- Personal Information -->
      <div class="form-grid">
        <div class="form-group">
          <label>Full Name <span class="required">*</span></label>
          <input type="text" name="fullname" 
                 value="{{ driver.full_name }}" 
                 placeholder="Enter full name" required>
        </div>

        <div class="form-group">
          <label>Phone Number <span class="required">*</span></label>
          <input type="tel" name="phonenumber" 
                 value="{{ driver.phone_number }}" 
                 placeholder="Enter phone number" required>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>Owner <span class="required">*</span></label>
          <select name="owner" required>
            <option value="" disabled>Select Owner</option>
            {% for vendor in vendors %}
            <option value="{{ vendor.id }}"
                    {% if driver.owner.id == vendor.id %}selected{% endif %}>
              {{ vendor.full_name }} ({{ vendor.phone_number }})
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label>Status</label>
          <input type="text" value="{{ driver.get_status_display }}" readonly
                 style="background-color: #f3f4f6;">
          <small style="color: #6b7280; font-size: 12px;">
            Status can be changed from the drivers list
          </small>
        </div>
      </div>

      <!-- Documents Section -->
      <div class="form-grid full-width">
        <div class="form-group">
          <label>PAN Card Document</label>
          
          <!-- Current File Display -->
          {% if driver.pan_document %}
          <div class="current-files">
            <div class="current-file-item">
              <div class="file-info">
                <i class="fas fa-file-pdf file-icon"></i>
                <a href="{{ driver.pan_document.url }}" target="_blank" class="file-link">
                  View Current PAN Document
                </a>
              </div>
              <button type="button" class="file-remove" data-field="pan_document">
                <i class="fas fa-times"></i> Remove
              </button>
            </div>
          </div>
          <div class="document-status uploaded">
            <i class="fas fa-check-circle"></i>
            Document uploaded
          </div>
          {% else %}
          <div class="document-status not-uploaded">
            <i class="fas fa-times-circle"></i>
            No document uploaded
          </div>
          {% endif %}
          
          <!-- File Upload -->
          <div class="file-upload-area" id="panUploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Drag & drop or <span class="browse-link" data-input="panDocument">Browse</span> to upload new file</p>
            <input type="file" id="panDocument" name="pan_document" 
                   accept=".pdf,.jpg,.jpeg,.png" style="display:none;">
            <span id="panFileName" class="file-name"></span>
          </div>
          <small style="color: #6b7280; font-size: 12px;">
            Upload new file to replace current document. Accepted formats: PDF, JPG, PNG
          </small>
        </div>

        <div class="form-group">
          <label>Aadhar Card Document</label>
          
          <!-- Current File Display -->
          {% if driver.aadhar_document %}
          <div class="current-files">
            <div class="current-file-item">
              <div class="file-info">
                <i class="fas fa-file-pdf file-icon"></i>
                <a href="{{ driver.aadhar_document.url }}" target="_blank" class="file-link">
                  View Current Aadhar Document
                </a>
              </div>
              <button type="button" class="file-remove" data-field="aadhar_document">
                <i class="fas fa-times"></i> Remove
              </button>
            </div>
          </div>
          <div class="document-status uploaded">
            <i class="fas fa-check-circle"></i>
            Document uploaded
          </div>
          {% else %}
          <div class="document-status not-uploaded">
            <i class="fas fa-times-circle"></i>
            No document uploaded
          </div>
          {% endif %}
          
          <!-- File Upload -->
          <div class="file-upload-area" id="aadharUploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Drag & drop or <span class="browse-link" data-input="aadharDocument">Browse</span> to upload new file</p>
            <input type="file" id="aadharDocument" name="aadhar_document" 
                   accept=".pdf,.jpg,.jpeg,.png" style="display:none;">
            <span id="aadharFileName" class="file-name"></span>
          </div>
        </div>
      </div>

      <div class="form-grid full-width">
        <div class="form-group">
          <label>Driving License / RC Document</label>
          
          <!-- Current File Display -->
          {% if driver.rc_document %}
          <div class="current-files">
            <div class="current-file-item">
              <div class="file-info">
                <i class="fas fa-file-pdf file-icon"></i>
                <a href="{{ driver.rc_document.url }}" target="_blank" class="file-link">
                  View Current RC Document
                </a>
              </div>
              <button type="button" class="file-remove" data-field="rc_document">
                <i class="fas fa-times"></i> Remove
              </button>
            </div>
          </div>
          <div class="document-status uploaded">
            <i class="fas fa-check-circle"></i>
            Document uploaded
          </div>
          {% else %}
          <div class="document-status not-uploaded">
            <i class="fas fa-times-circle"></i>
            No document uploaded
          </div>
          {% endif %}
          
          <!-- File Upload -->
          <div class="file-upload-area" id="rcUploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Drag & drop or <span class="browse-link" data-input="rcDocument">Browse</span> to upload new file</p>
            <input type="file" id="rcDocument" name="rc_document" 
                   accept=".pdf,.jpg,.jpeg,.png" style="display:none;">
            <span id="rcFileName" class="file-name"></span>
          </div>
        </div>

        
      </div>

     

      <!-- Form Actions -->
      <div class="form-actions">
        <a href="{% url 'driver_list' %}" class="cancel-btn">Cancel</a>
        <button type="submit" class="save-btn">
          <i class="fas fa-save"></i> Update Driver
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Toastify -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const editDriverForm = document.getElementById('editDriverForm');
  const successAlert = document.getElementById('successAlert');
  const errorAlert = document.getElementById('errorAlert');
  const saveBtn = editDriverForm.querySelector('.save-btn');

  // ====================== FILE UPLOAD HANDLING ======================
  const fileFields = [
    { inputId: 'panDocument', areaId: 'panUploadArea', nameId: 'panFileName' },
    { inputId: 'aadharDocument', areaId: 'aadharUploadArea', nameId: 'aadharFileName' },
    { inputId: 'rcDocument', areaId: 'rcUploadArea', nameId: 'rcFileName' },
    { inputId: 'profilePhoto', areaId: 'photoUploadArea', nameId: 'photoFileName' }
  ];

  fileFields.forEach(field => {
    const input = document.getElementById(field.inputId);
    const area = document.getElementById(field.areaId);
    const display = document.getElementById(field.nameId);

    if (!input || !area || !display) return;

    const updateFileName = () => {
      if (input.files && input.files[0]) {
        display.textContent = input.files[0].name;
        display.className = 'file-name uploaded';
      } else {
        display.textContent = '';
        display.className = 'file-name';
      }
    };

    area.addEventListener('click', (e) => {
      e.stopPropagation();
      input.click();
    });

    input.addEventListener('change', updateFileName);

    area.addEventListener('dragover', e => {
      e.preventDefault();
      area.classList.add('dragover');
    });

    area.addEventListener('dragleave', () => area.classList.remove('dragover'));

    area.addEventListener('drop', e => {
      e.preventDefault();
      area.classList.remove('dragover');
      if (e.dataTransfer.files.length) {
        input.files = e.dataTransfer.files;
        updateFileName();
      }
    });
  });

  // Browse links
  document.querySelectorAll('.browse-link').forEach(link => {
    link.addEventListener('click', (e) => {
      e.stopPropagation();
      const input = document.getElementById(link.dataset.input);
      if (input) input.click();
    });
  });

  // Remove file buttons
  document.querySelectorAll('.file-remove').forEach(button => {
    button.addEventListener('click', function() {
      const field = this.dataset.field;
      const currentFilesDiv = this.closest('.current-files');
      
      if (confirm('Are you sure you want to remove this file? The file will be deleted permanently.')) {
        // Hide the current file display
        currentFilesDiv.style.display = 'none';
        
        // Show message that file will be removed
        const statusDiv = currentFilesDiv.nextElementSibling;
        if (statusDiv && statusDiv.classList.contains('document-status')) {
          statusDiv.innerHTML = '<i class="fas fa-info-circle"></i> File will be removed on save';
          statusDiv.className = 'document-status not-uploaded';
        }
        
        // Add hidden input to mark file for removal
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = `remove_${field}`;
        hiddenInput.value = 'true';
        editDriverForm.appendChild(hiddenInput);
      }
    });
  });

  // ====================== FORM VALIDATION ======================
  function validateForm() {
    const fullName = editDriverForm.querySelector('input[name="fullname"]').value.trim();
    const phone = editDriverForm.querySelector('input[name="phonenumber"]').value.trim();
    const owner = editDriverForm.querySelector('select[name="owner"]').value;

    if (!fullName) {
      showAlert('Full name is required', 'error');
      return false;
    }

    if (!phone) {
      showAlert('Phone number is required', 'error');
      return false;
    }

    // Validate phone number format
    const phoneRegex = /^[0-9]{10}$/;
    if (!phoneRegex.test(phone)) {
      showAlert('Please enter a valid 10-digit phone number', 'error');
      return false;
    }

    if (!owner) {
      showAlert('Please select an owner', 'error');
      return false;
    }

    return true;
  }

  // ====================== FORM SUBMISSION ======================
  editDriverForm.addEventListener('submit', async function (e) {
    e.preventDefault();
    
    if (!validateForm()) return;

    // Show loading state
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
    saveBtn.disabled = true;

    // Clear previous alerts
    successAlert.style.display = 'none';
    errorAlert.style.display = 'none';

    try {
      const formData = new FormData(this);
      
      // Get driver ID from hidden field
      const driverId = formData.get('driver_id');
      
      const response = await fetch(`/drivers/${driverId}/update/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
        },
        body: formData
      });

      const data = await response.json();

      if (data.success) {
     
        showToast('Driver updated successfully!', 'success');
        
        // Optional: Redirect after success
        setTimeout(() => {
          window.location.href = '{% url "driver_list" %}';
        }, 1500);
      } else {
        showAlert(data.error || 'Failed to update driver', 'error');
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
      }
    } catch (error) {
      console.error('Error:', error);
      showAlert('Network error. Please try again.', 'error');
      saveBtn.innerHTML = originalText;
      saveBtn.disabled = false;
    }
  });

  // ====================== HELPER FUNCTIONS ======================
  function showAlert(message, type) {
    const alertDiv = type === 'success' ? successAlert : errorAlert;
    alertDiv.textContent = message;
    alertDiv.style.display = 'block';
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
      alertDiv.style.display = 'none';
    }, 5000);
  }

  function showToast(text, type = 'info') {
    const colors = { 
      success: '#16a34a', 
      error: '#dc2626', 
      info: '#2563eb' 
    };
    
    Toastify({ 
      text, 
      duration: 3000, 
      gravity: "top", 
      position: "right", 
      backgroundColor: colors[type],
      close: true
    }).showToast();
  }

  // Prevent form submission on Enter key in input fields
  editDriverForm.querySelectorAll('input, select').forEach(field => {
    field.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
      }
    });
  });
});
</script>
</body>
</html>
{% endblock %}