{% extends "admin_base.html" %}
{% load static %}
{% block title %}Vehicle Management{% endblock %}
{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vehicle Management</title>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
    <link rel="stylesheet" href="{% static 'css/vehicle_management.css' %}" />

    <style>
        /* Updated Sidebar Styles - Match Driver Management */
        #profileSidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 320px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 15px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1001;
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
            display: flex;
            flex-direction: column;
        }

        #profileSidebar::-webkit-scrollbar {
            width: 0 !important;
        }

        #profileSidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .sidebar-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #111827;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background-color 0.2s;
            position: static;
        }

        .close-btn:hover {
            background-color: #f3f4f6;
        }

        .profile-avatar {
            display: flex;
            justify-content: center;
            padding: 24px 20px 16px;
        }

       .avatar-circle {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 22px;
      font-weight: 600;
      text-transform: uppercase;
    }

        .profile-info {
            text-align: center;
            padding: 0 20px 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .profile-name {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            margin: 0 0 8px 0;
        }

        .profile-phone {
            font-size: 14px;
            color: #6b7280;
            margin: 0 0 4px 0;
        }

        .profile-id {
            font-size: 13px;
            color: #9ca3af;
            margin: 0;
        }

        .info-section {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .info-section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #111827;
            margin: 0 0 16px 0;
        }

        .info-section-title i {
            color: #6b7280;
            font-size: 16px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .info-row:last-child {
            margin-bottom: 0;
        }

        .info-label {
            font-size: 13px;
            color: #6b7280;
        }

        .info-value {
            font-size: 13px;
            color: #111827;
            font-weight: 500;
        }

        .performance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .performance-item:last-child {
            margin-bottom: 0;
        }

        .performance-label {
            font-size: 13px;
            color: #6b7280;
        }

        .performance-value {
            font-size: 13px;
            font-weight: 600;
            color: #16a34a;
        }

        .documents-section {
            padding: 20px;
            flex-grow: 1;
        }

        .document-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .document-item:last-child {
            border-bottom: none;
        }

        .document-name {
            font-size: 13px;
            color: #374151;
            font-weight: 500;
        }

        .document-status {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .document-status.uploaded {
            background-color: #dcfce7;
            color: #16a34a;
        }

        .document-status.not-uploaded {
            background-color: #fee2e2;
            color: #dc2626;
        }

        .document-status i {
            font-size: 10px;
        }

        .sidebar-actions {
            padding: 16px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border-top: 1px solid #e5e7eb;
            background: white;
        }

        .sidebar-btn {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-view-history {
            background-color: #dc2626;
            color: white;
        }

        .btn-view-history:hover {
            background-color: #b91c1c;
        }

        .btn-edit {
            background-color: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-edit:hover {
            background-color: #f9fafb;
        }

        .btn-deactivate {
            background-color: white;
            color: #dc2626;
            border: 1px solid #dc2626;
        }

        .btn-deactivate:hover {
            background-color: #fef2f2;
        }

        /* Tags input styles */
        .tags-input-container {
            margin-top: 4px;
        }
        
        .tags-input-wrapper {
            position: relative;
            margin-bottom: 8px;
        }
        
        #toLocationInput {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        #toLocationInput:focus {
            outline: none;
            border-color: #dc2626;
        }
        
        .tags-display {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
            min-height: 34px;
        }
        
        .tag {
            background: #fee2e2;
            color: #dc2626;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .tag-remove {
            background: none;
            border: none;
            color: #dc2626;
            cursor: pointer;
            font-size: 12px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .field-hint {
            display: block;
            margin-top: 4px;
            font-size: 12px;
            color: #6b7280;
        }

        /* Additional info styles for sidebar */
        .info-section .info-row .info-value {
            max-width: 60%;
            text-align: right;
            word-break: break-word;
        }
    </style>
</head>
<body>
<div class="dashboard">
    <!-- TOP BAR -->
    <div class="top-bar">
        <h2>Vehicle Management</h2>
        <div class="search-add-container">
            <input type="text" id="searchInput" placeholder="Search vehicles..." class="search-input" />
            <button class="add-button" id="openAddModal">+ Add Vehicle</button>
        </div>
    </div>

    <!-- TABLE -->
    <div class="table-card">
        <table id="vehicleTable">
            <thead>
                <tr>
                    <th>Reg No</th>
                    <th>Owner</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th style="width:10%">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if vehicles %}
                    {% for vehicle in vehicles %}
                    <tr class="clickable-row" 
                        data-vehicle-id="{{ vehicle.id }}"
                        data-id="{{ vehicle.id }}"
                        data-reg-no="{{ vehicle.reg_no|escapejs }}"
                        data-owner-name="{{ vehicle.owner.full_name|escapejs }}"
                        data-owner-phone="{{ vehicle.owner.phone_number }}"
                        data-type="{{ vehicle.type|escapejs }}"
                        data-load-capacity="{{ vehicle.load_capacity|default:""|stringformat:"s" }}"
                        data-location="{{ vehicle.location|default:""|escapejs }}"
                        data-to-locations="{{ vehicle.to_location|safe|default_if_none:"[]" }}"
                        data-insurance-doc="{% if vehicle.insurance_doc %}{{ vehicle.insurance_doc.url }}{% endif %}"
                        data-rc-doc="{% if vehicle.rc_doc %}{{ vehicle.rc_doc.url }}{% endif %}"
                        data-has-insurance="{% if vehicle.insurance_doc %}true{% else %}false{% endif %}"
                        data-has-rc="{% if vehicle.rc_doc %}true{% else %}false{% endif %}"
                        data-status="{{ vehicle.status }}"
                        data-status-label="{{ vehicle.get_status_display }}">
                        <td>{{ vehicle.reg_no }}</td>
                        <td>
                            <div>{{ vehicle.owner.full_name }}</div>
                            <div style="font-size:12px;color:#6b7280;">{{ vehicle.owner.phone_number }}</div>
                        </td>
                        <td>{{ vehicle.type }}</td>
                        <td>
                            <span class="status-badge {% if vehicle.status == 'active' %}status-active{% else %}status-inactive{% endif %}">
                                {{ vehicle.get_status_display }}
                            </span>
                        </td>
                        <td class="action-col">
                            <div class="action-buttons">
                                <button class="action-view" title="View"><i class="fas fa-eye"></i></button>
                                <button class="action-edit" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="action-delete" data-vehicle-id="{{ vehicle.id }}" title="Delete"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="5" style="text-align:center;padding:40px;color:#6b7280;">
                            No vehicles found. Click "Add Vehicle" to get started.
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>

       <!-- Pagination -->
    <div class="pagination-container">
      <div class="entries-per-page">
        <span>Show</span>
        <select id="entriesPerPage">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="25">25</option>
          <option value="50">50</option>
        </select>
        <span>entries</span>
      </div>
      <div class="pagination-info">
        Showing <span id="showingStart">0</span> to <span id="showingEnd">0</span> of <span id="totalEntries">0</span> entries
      </div>
      <div class="pagination-controls">
        <button id="prevPage" disabled>Previous</button>
        <span id="currentPageInfo">Page 1</span>
        <button id="nextPage">Next</button>
      </div>
    </div>
    </div>

    <!-- ADD VEHICLE MODAL -->
    <div id="addModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Vehicle</h3>
                <button class="modal-close" id="closeAddModal">×</button>
            </div>
            <p class="modal-subtitle">Fill the details below to add a new vehicle.</p>
            <div class="modal-body-wrapper">
                <form id="addVehicleForm" class="modal-form" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="form-row">
                        <div class="form-group">
                            <label>Reg No <span class="required">*</span></label>
                            <input type="text" name="reg_no" placeholder="Enter Reg no" required />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Choose Owner <span class="required">*</span></label>
                            <select name="owner" required>
                                <option value="">Select Owner</option>
                                {% for vendor in vendors %}
                                <option value="{{ vendor.id }}">{{ vendor.full_name }} ({{ vendor.phone_number }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Vehicle Type <span class="required">*</span></label>
                            <select name="type" required>
                                <option value="">Select Vehicle Type</option>
                                {% for vehicle_type in vehicle_types %}
                                <option value="{{ vehicle_type.name }}">{{ vehicle_type.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Load Capacity (tons)</label>
                            <input type="number" name="load_capacity" placeholder="e.g., 5.5" step="0.01" min="0" />
                            <small class="field-hint">Optional - enter in tons</small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Current Location</label>
                            <input type="text" name="location" placeholder="e.g., Delhi, Mumbai" />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Destinations (To Locations)</label>
                            <div class="tags-input-container" id="toLocationsContainer">
                                <div class="tags-input-wrapper">
                                    <input type="text" id="toLocationInput" placeholder="Type destination and press Enter" />
                                </div>
                                <div class="tags-display" id="toLocationsDisplay"></div>
                                <input type="hidden" name="to_locations" id="toLocationsHidden" />
                            </div>
                            <small class="field-hint">Press Enter after each destination</small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Insurance Document</label>
                            <div class="file-upload-area">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Drag and drop files here or <span class="browse">Browse Files</span></p>
                                <input type="file" name="insurance_doc" accept=".pdf,.jpg,.jpeg,.png">
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>RC Document</label>
                            <div class="file-upload-area">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Drag and drop files here or <span class="browse">Browse Files</span></p>
                                <input type="file" name="rc_doc" accept=".pdf,.jpg,.jpeg,.png">
                            </div>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="submit" class="save-btn" id="saveVehicleBtn">Save Vehicle</button>
                        <button type="button" class="cancel-btn" id="cancelAddModal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- UPDATED PROFILE SIDEBAR -->
    <div id="profileSidebar">
        <div class="sidebar-header">
            <h3>Vehicle Profile</h3>
            <button class="close-btn" id="closeSidebar">×</button>
        </div>

        <div class="profile-avatar">
            <div class="avatar-circle" id="profileAvatar"></div>
        </div>

        <div class="profile-info">
            <h3 class="profile-name" id="profileRegNo"></h3>
            <p class="profile-phone" id="profileOwnerName"></p>
            <p class="profile-id" id="profileOwnerPhone"></p>
        </div>

        <div class="info-section" id="vehicleInfoSection">
            <h4 class="info-section-title">
                <i class="fas fa-user"></i>
                Vehicle Information
            </h4>
            <div class="info-row" id="vehicleTypeRow">
                <span class="info-label">Vehicle Type:</span>
                <span class="info-value" id="vehicleTypeValue"></span>
            </div>
            <div class="info-row" id="loadCapacityRow">
                <span class="info-label">Load Capacity:</span>
                <span class="info-value" id="loadCapacityValue"></span>
            </div>
            <div class="info-row" id="locationRow">
                <span class="info-label">Current Location:</span>
                <span class="info-value" id="locationValue"></span>
            </div>
            <div class="info-row" id="toLocationsRow">
                <span class="info-label">Destinations:</span>
                <span class="info-value" id="toLocationsValue"></span>
            </div>
        </div>

        <div class="info-section" id="ownerInfoSection">
            <h4 class="info-section-title">
                <i class="fas fa-user"></i>
                Owner Information
            </h4>
            <div class="info-row">
                <span class="info-label">Name:</span>
                <span class="info-value" id="ownerInfoName"></span>
            </div>
            <div class="info-row">
                <span class="info-label">Phone:</span>
                <span class="info-value" id="ownerInfoPhone"></span>
            </div>
        </div>

        <div class="info-section">
            <h4 class="info-section-title">
                <i class="fas fa-chart-line"></i>
                Performance
            </h4>
            <div class="performance-item">
                <span class="performance-label">Total Trips</span>
                <span class="performance-value" id="totalTrips">0 trips</span>
            </div>
            <div class="performance-item">
                <span class="performance-label">Completed Trips</span>
                <span class="performance-value" id="completedTrips">0 trips</span>
            </div>
            <div class="performance-item">
                <span class="performance-label">Pending Trips</span>
                <span class="performance-value" id="pendingTrips" style="color:#3b82f6;">0 trips</span>
            </div>
        </div>

        <div class="documents-section">
            <h4 class="info-section-title">
                <i class="fas fa-file-alt"></i>
                Documents
            </h4>
            <div class="document-item">
                <span class="document-name">RC Certificate</span>
                <div class="document-status" id="docRC">
                    <i class="fas fa-times"></i>
                </div>
            </div>
            <div class="document-item">
                <span class="document-name">Insurance</span>
                <div class="document-status" id="docInsurance">
                    <i class="fas fa-times"></i>
                </div>
            </div>
        </div>

        <div class="sidebar-actions">
            <button class="sidebar-btn btn-view-history">
                <i class="fas fa-history"></i>
                View Trip History
            </button>
            <button class="sidebar-btn btn-edit">
                <i class="fas fa-edit"></i>
                Edit
            </button>
            <button class="sidebar-btn btn-deactivate" id="toggleStatusBtn">
                <i class="fas fa-ban"></i>
                Deactivate
            </button>
        </div>
    </div>

    <div id="sidebarOverlay"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    /* --------------------------------------------------------------
       TOAST HELPER
    -------------------------------------------------------------- */
    function showToast(text, type = "info") {
        const colors = { success: "#16a34a", error: "#dc2626", info: "#2563eb", warning: "#d97706" };
        Toastify({ text, duration: 3500, close: true, gravity: "top", position: "right", backgroundColor: colors[type] }).showToast();
    }

    /* --------------------------------------------------------------
       CSRF TOKEN
    -------------------------------------------------------------- */
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === name + "=") {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie("csrftoken");

    /* --------------------------------------------------------------
       ELEMENTS
    -------------------------------------------------------------- */
    const table           = document.getElementById("vehicleTable");
    const tbody           = table.querySelector("tbody");
    const sidebar         = document.getElementById("profileSidebar");
    const overlay         = document.getElementById("sidebarOverlay");
    const closeBtn        = document.getElementById("closeSidebar");
    const searchInput     = document.getElementById("searchInput");
    const openAddModalBtn = document.getElementById("openAddModal");
    const addModal        = document.getElementById("addModal");
    const closeAddModalBtn= document.getElementById("closeAddModal");
    const cancelAddModalBtn=document.getElementById("cancelAddModal");
    const addForm         = document.getElementById("addVehicleForm");
    const saveVehicleBtn  = document.getElementById("saveVehicleBtn");
    const entriesSelect   = document.getElementById("entriesPerPage");
    const showingStart    = document.getElementById("showingStart");
    const showingEnd      = document.getElementById("showingEnd");
    const totalEntries    = document.getElementById("totalEntries");
    const prevBtn         = document.getElementById("prevPage");
    const nextBtn         = document.getElementById("nextPage");
    const currentPageInfo = document.getElementById("currentPageInfo");

    let currentVehicleId = null;
    let currentPage = 1;
    let perPage = parseInt(entriesSelect.value, 10);
    let allRows = [];
    let filteredRows = [];

    /* --------------------------------------------------------------
       FILE UPLOAD (drag & drop)
    -------------------------------------------------------------- */
    document.querySelectorAll('.file-upload-area').forEach(area => {
        const input = area.querySelector('input[type="file"]');
        const browse = area.querySelector('.browse');
        const p = area.querySelector('p');

        browse.addEventListener('click', () => input.click());
        area.addEventListener('click', e => { if (e.target !== browse) input.click(); });

        input.addEventListener('change', () => {
            const file = input.files[0];
            if (file) p.innerHTML = `<i class="fas fa-check-circle" style="color:#16a34a"></i> <span style="color:#16a34a;font-weight:500">${file.name}</span>`;
            else p.innerHTML = `Drag and drop files here or <span class="browse">Browse Files</span>`;
        });

        area.addEventListener('dragover', e => { e.preventDefault(); area.classList.add('active'); });
        area.addEventListener('dragleave', () => area.classList.remove('active'));
        area.addEventListener('drop', e => {
            e.preventDefault(); area.classList.remove('active');
            const file = e.dataTransfer.files[0];
            if (file && ['application/pdf','image/jpeg','image/jpg','image/png'].includes(file.type)) {
                const dt = new DataTransfer(); dt.items.add(file);
                input.files = dt.files; input.dispatchEvent(new Event('change'));
            }
        });
    });

    /* --------------------------------------------------------------
       TAGS INPUT FOR TO LOCATIONS
    -------------------------------------------------------------- */
    function initTagsInput() {
        const input = document.getElementById('toLocationInput');
        const display = document.getElementById('toLocationsDisplay');
        const hidden = document.getElementById('toLocationsHidden');
        let tags = [];
        
        function updateTags() {
            display.innerHTML = '';
            tags.forEach((tag, index) => {
                const tagEl = document.createElement('div');
                tagEl.className = 'tag';
                tagEl.innerHTML = `
                    ${tag}
                    <button type="button" class="tag-remove" data-index="${index}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                display.appendChild(tagEl);
            });
            hidden.value = JSON.stringify(tags);
        }
        
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && input.value.trim()) {
                e.preventDefault();
                const value = input.value.trim();
                if (value && !tags.includes(value)) {
                    tags.push(value);
                    updateTags();
                    input.value = '';
                }
            }
        });
        
        display.addEventListener('click', (e) => {
            if (e.target.closest('.tag-remove')) {
                const index = parseInt(e.target.closest('.tag-remove').dataset.index);
                tags.splice(index, 1);
                updateTags();
            }
        });
        
        // Also update hidden field on form submission
        document.getElementById('addVehicleForm').addEventListener('submit', () => {
            hidden.value = JSON.stringify(tags);
        });
        
        return { tags, updateTags };
    }

    let tagsHandler = null;

    /* --------------------------------------------------------------
       INITIALIZE TAGS INPUT ON MODAL OPEN
    -------------------------------------------------------------- */
    openAddModalBtn.addEventListener('click', () => {
        // Reset tags when opening modal
        document.getElementById('toLocationsDisplay').innerHTML = '';
        document.getElementById('toLocationsHidden').value = '[]';
        tagsHandler = initTagsInput();
    });

    /* --------------------------------------------------------------
       INITIAL ROWS + SEARCH
    -------------------------------------------------------------- */
    function initRows() {
        allRows = Array.from(tbody.querySelectorAll("tr.clickable-row"));
        filteredRows = [...allRows];
        renderPage();
    }

    searchInput.addEventListener("input", () => {
        const term = searchInput.value.toLowerCase();
        filteredRows = allRows.filter(r => r.textContent.toLowerCase().includes(term));
        currentPage = 1;
        renderPage();
    });

    /* --------------------------------------------------------------
       GET INITIALS
    -------------------------------------------------------------- */
    function getInitials(name) {
        const parts = name.trim().split(' ');
        if (parts.length >= 2) {
            return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        }
        return name.substring(0, 2).toUpperCase();
    }

    /* --------------------------------------------------------------
       SIDEBAR OPEN / CLOSE
    -------------------------------------------------------------- */
    function openSidebar(row) {
        // Extract data from row data attributes instead of JSON parsing
        // Handle to_locations - convert Python list format to proper JSON
        let toLocationsData = [];
        try {
            const toLocationsStr = (row.dataset.toLocations || '[]').trim();
            // Try to parse as JSON first
            toLocationsData = JSON.parse(toLocationsStr);
        } catch (e) {
            // If JSON parse fails, it's likely a Python list format ['item1', 'item2']
            // Try to convert Python list to JSON array
            try {
                const pythonListStr = (row.dataset.toLocations || '[]')
                    .replace(/'/g, '"')  // Replace single quotes with double quotes
                    .replace(/\bTrue\b/g, 'true')  // Replace Python True with JSON true
                    .replace(/\bFalse\b/g, 'false')  // Replace Python False with JSON false
                    .replace(/\bNone\b/g, 'null');  // Replace Python None with JSON null
                toLocationsData = JSON.parse(pythonListStr);
            } catch (parseErr) {
                console.error('Could not parse to_locations:', row.dataset.toLocations, parseErr);
                toLocationsData = [];
            }
        }

        const data = {
            id: parseInt(row.dataset.id),
            reg_no: row.dataset.regNo,
            owner_name: row.dataset.ownerName,
            owner_phone: row.dataset.ownerPhone,
            type: row.dataset.type,
            load_capacity: row.dataset.loadCapacity,
            location: row.dataset.location,
            to_locations: toLocationsData,
            insurance_doc: row.dataset.insuranceDoc,
            rc_doc: row.dataset.rcDoc,
            hasInsurance: row.dataset.hasInsurance === 'true',
            hasRC: row.dataset.hasRc === 'true',
            status: row.dataset.status,
            status_label: row.dataset.statusLabel
        };
        currentVehicleId = data.id;

        // Update avatar with vehicle reg no initials
        const avatarEl = document.getElementById("profileAvatar");
        avatarEl.textContent = getInitials(data.reg_no);

        // Update profile info from backend data
        document.getElementById("profileRegNo").textContent = data.reg_no;
        document.getElementById("profileOwnerName").textContent = data.owner_name;
        document.getElementById("profileOwnerPhone").textContent = data.owner_phone;

        // Update vehicle information section
        document.getElementById("vehicleTypeValue").textContent = data.type;
        
        // Update load capacity
        const loadCapacityRow = document.getElementById("loadCapacityRow");
        const loadCapacityValue = document.getElementById("loadCapacityValue");
        if (data.load_capacity && data.load_capacity.trim() !== '') {
            loadCapacityValue.textContent = `${data.load_capacity} tons`;
            loadCapacityRow.style.display = 'flex';
        } else {
            loadCapacityRow.style.display = 'none';
        }
        
        // Update current location
        const locationRow = document.getElementById("locationRow");
        const locationValue = document.getElementById("locationValue");
        if (data.location && data.location.trim() !== '') {
            locationValue.textContent = data.location;
            locationRow.style.display = 'flex';
        } else {
            locationRow.style.display = 'none';
        }
        
        // Update destinations
        const toLocationsRow = document.getElementById("toLocationsRow");
        const toLocationsValue = document.getElementById("toLocationsValue");
        if (data.to_locations && Array.isArray(data.to_locations) && data.to_locations.length > 0) {
            toLocationsValue.textContent = data.to_locations.join(', ');
            toLocationsRow.style.display = 'flex';
        } else {
            toLocationsRow.style.display = 'none';
        }

        // Update owner information section
        document.getElementById("ownerInfoName").textContent = data.owner_name;
        document.getElementById("ownerInfoPhone").textContent = data.owner_phone;

        // Update performance from backend data (placeholder - update when backend provides)
        document.getElementById("totalTrips").textContent = '0 trips';
        document.getElementById("completedTrips").textContent = '0 trips';
        document.getElementById("pendingTrips").textContent = '0 trips';

        // Update documents from backend data
        const docRC = document.getElementById("docRC");
        const docInsurance = document.getElementById("docInsurance");

        // RC Document
        if (data.hasRC) {
            docRC.className = 'document-status uploaded';
            docRC.innerHTML = '<i class="fas fa-check"></i>';
        } else {
            docRC.className = 'document-status not-uploaded';
            docRC.innerHTML = '<i class="fas fa-times"></i>';
        }

        // Insurance Document
        if (data.hasInsurance) {
            docInsurance.className = 'document-status uploaded';
            docInsurance.innerHTML = '<i class="fas fa-check"></i>';
        } else {
            docInsurance.className = 'document-status not-uploaded';
            docInsurance.innerHTML = '<i class="fas fa-times"></i>';
        }

        // Update toggle button based on backend status
        const toggleBtn = document.getElementById('toggleStatusBtn');
        if (data.status === 'active') {
            toggleBtn.innerHTML = '<i class="fas fa-ban"></i> Deactivate';
            toggleBtn.classList.remove('btn-activate');
            toggleBtn.classList.add('btn-deactivate');
        } else {
            toggleBtn.innerHTML = '<i class="fas fa-check-circle"></i> Activate';
            toggleBtn.classList.remove('btn-deactivate');
            toggleBtn.classList.add('btn-activate');
        }
        
        sidebar.classList.add('open');
        overlay.classList.add('show');
        document.querySelectorAll('.clickable-row').forEach(r => r.style.backgroundColor = '');
        row.style.backgroundColor = '#f0f9ff';
    }

    function closeSidebar() {
        sidebar.classList.remove('open');
        overlay.classList.remove('show');
        document.querySelectorAll('.clickable-row').forEach(r => r.style.backgroundColor = '');
        currentVehicleId = null;
    }

    table.addEventListener("click", e => {
        if (e.target.closest(".action-col")) return;
        const row = e.target.closest(".clickable-row");
        if (row) openSidebar(row);
    });

    closeBtn.addEventListener("click", closeSidebar);
    overlay.addEventListener("click", closeSidebar);

    // Toggle Status Button
    document.getElementById('toggleStatusBtn').addEventListener('click', function() {
        if (!currentVehicleId || !confirm('Change vehicle status?')) return;
        fetch(`/vehicle/${currentVehicleId}/toggle-status/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken }
        })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                showToast(d.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(d.error || 'Failed', 'error');
            }
        });
    });

    /* --------------------------------------------------------------
       ACTION BUTTONS (View / Edit / Delete)
    -------------------------------------------------------------- */
    function attachActionListeners(row) {
        row.querySelector(".action-view")?.addEventListener("click", e => {
            e.stopPropagation(); openSidebar(row);
        });

       row.querySelector('.action-edit')?.addEventListener('click', e => { 
            e.stopPropagation(); 
            window.location.href = `/vehicle/${row.dataset.vehicleId}/edit/`;
        });

        row.querySelector(".action-delete")?.addEventListener("click", e => {
            e.stopPropagation();
            const id = row.dataset.vehicleId;
            if (!confirm("Delete this vehicle?")) return;
            fetch(`/vehicle/${id}/delete/`, {
                method: "POST",
                headers: { "X-CSRFToken": csrftoken }
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, "success");
                    row.remove();
                    allRows = allRows.filter(r => r !== row);
                    filteredRows = filteredRows.filter(r => r !== row);
                    renderPage();
                    closeSidebar();
                } else showToast(data.error, "error");
            });
        });
    }
    document.querySelectorAll("#vehicleTable tbody tr.clickable-row").forEach(attachActionListeners);

    /* --------------------------------------------------------------
       ADD VEHICLE MODAL
    -------------------------------------------------------------- */
    const showModal = () => {
        addModal.style.display = "flex";
        addForm.reset();
        document.querySelectorAll('.file-upload-area p').forEach(p => {
            p.innerHTML = `Drag and drop files here or <span class="browse">Browse Files</span>`;
        });
        // Initialize tags input
        document.getElementById('toLocationsDisplay').innerHTML = '';
        document.getElementById('toLocationsHidden').value = '[]';
        tagsHandler = initTagsInput();
    };
    const hideModal = () => { addModal.style.display = "none"; };

    openAddModalBtn.addEventListener("click", showModal);
    closeAddModalBtn.addEventListener("click", hideModal);
    cancelAddModalBtn.addEventListener("click", hideModal);
    addModal.addEventListener("click", e => { if (e.target === addModal) hideModal(); });

    addForm.addEventListener("submit", function (e) {
        e.preventDefault();
        saveVehicleBtn.disabled = true;
        saveVehicleBtn.textContent = "Saving...";

        const formData = new FormData(addForm);
        fetch('{% url "add_vehicle" %}', {
            method: "POST",
            headers: { "X-CSRFToken": csrftoken },
            body: formData,
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, "success");
                const tr = document.createElement("tr");
                tr.className = "clickable-row";
                tr.dataset.vehicleId = data.vehicle.id;
                tr.dataset.vehicle = JSON.stringify(data.vehicle_data);
                tr.innerHTML = `
                    <td>${data.vehicle.reg_no}</td>
                    <td>
                        <div>${data.vehicle.owner_name}</div>
                        <div style="font-size:12px;color:#6b7280;">${data.vehicle_data.owner_phone}</div>
                    </td>
                    <td>${data.vehicle.type}</td>
                    <td><span class="status-badge status-active">Active</span></td>
                    <td class="action-col">
                        <div class="action-buttons">
                            <button class="action-view" title="View"><i class="fas fa-eye"></i></button>
                            <button class="action-edit" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="action-delete" data-vehicle-id="${data.vehicle.id}" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                tbody.prepend(tr);
                allRows.unshift(tr);
                filteredRows.unshift(tr);
                attachActionListeners(tr);
                currentPage = 1;
                renderPage();
                hideModal();
            } else {
                showToast(data.error || "Failed to add vehicle", "error");
            }
        })
        .finally(() => {
            saveVehicleBtn.disabled = false;
            saveVehicleBtn.textContent = "Save Vehicle";
        });
    });

    /* --------------------------------------------------------------
       PAGINATION
    -------------------------------------------------------------- */
    function renderPage() {
        const start = (currentPage - 1) * perPage;
        const end   = start + perPage;

        allRows.forEach(r => r.style.display = "none");
        filteredRows.slice(start, end).forEach(r => r.style.display = "");

        const visibleEnd = Math.min(end, filteredRows.length);
        showingStart.textContent = filteredRows.length ? start + 1 : 0;
        showingEnd.textContent   = visibleEnd;
        totalEntries.textContent = filteredRows.length;

        renderPaginationButtons();
    }

    function renderPaginationButtons() {
        const totalPages = Math.ceil(filteredRows.length / perPage);
        currentPageInfo.textContent = `Page ${currentPage}`;
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage >= totalPages || totalPages === 0;
    }

    entriesSelect.addEventListener("change", () => {
        perPage = +entriesSelect.value;
        currentPage = 1;
        renderPage();
    });
    prevBtn.addEventListener("click", () => {
        if (currentPage > 1) { currentPage--; renderPage(); }
    });
    nextBtn.addEventListener("click", () => {
        const totalPages = Math.ceil(filteredRows.length / perPage);
        if (currentPage < totalPages) { currentPage++; renderPage(); }
    });

    initRows();
});
</script>
</body>
</html>
{% endblock %}