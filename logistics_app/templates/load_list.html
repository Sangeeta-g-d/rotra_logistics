{% extends "admin_base.html" %}
{% load static %}
{% block title %}Load Management{% endblock %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>Load Management</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/load_management.css' %}">

</head>
<body>
<div class="dashboard">

  <!-- TOP BAR -->
  <div class="top-bar">
    <h2>Load Management</h2>
    <div class="search-add-container">
      <input type="text" id="searchInput" placeholder="Search loads..." class="search-input">
      <button class="add-button" id="openAddModal">+ Add Load</button>
    </div>
  </div>

  <!-- TABLE -->
  <div class="table-card">
    <table id="loadTable">
      <thead>
        <tr>
          <th>Load ID</th>
          <th>Route</th>
          <th>Date & Time</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if loads %}
          {% for load in loads %}
<tr class="clickable-row" data-load-id="{{ load.id }}"
    data-load='{
        "load_id": "{{ load.load_id }}",
        "pickup": "{{ load.pickup_location }}",
        "drop": "{{ load.drop_location }}",
        "vehicle_type": "{{ load.vehicle_type.name }}",
        "date": "{{ load.pickup_date|date:'M d, Y' }}",
        "time": "{{ load.time|default:'' }}",
        "material": "{{ load.material|default:'-' }}",
        "weight": "{{ load.weight }}",
        "driver_name": "{{ load.driver.full_name|default:'-' }}",
        "driver_phone": "{{ load.driver.phone_number|default:'-' }}",
        "status": "{{ load.status }}",
        "status_display": "{{ load.get_status_display }}",
        "customer_name": "{{ load.customer.customer_name }}",
        "customer_phone": "{{ load.customer.phone_number }}",
        "customer_location": "{{ load.customer.location|default:'-' }}",
        "contact_person_name": "{{ load.contact_person_name|default_if_none:''|default:'' }}{% if not load.contact_person_name and load.customer.contacts.all %}{{ load.customer.contacts.all.0.name }}{% elif not load.contact_person_name %}-{% endif %}",
        "contact_person_phone": "{{ load.contact_person_phone|default_if_none:''|default:'' }}{% if not load.contact_person_phone and load.customer.contacts.all %}{{ load.customer.contacts.all.0.phone_number }}{% elif not load.contact_person_phone %}-{% endif %}",
        "price_per_unit": "{{ load.price_per_unit }}",
        "final_payment": "{{ load.final_payment }}"
    }'>
    <td style="color:var(--primary); font-weight: 1000;">{{ load.load_id }}</td>
    <td>
        <div class="route-display">
            <span>{{ load.pickup_location }}</span>
            <i class="fas fa-arrow-right route-arrow"></i>
            <span>{{ load.drop_location }}</span>
        </div>
    </td>
    <td>
        <div class="datetime-display">
            <span class="date-display">{{ load.pickup_date|date:"M d, Y" }}</span>
            {% if load.time %}
                <span class="time-display">{{ load.time }}</span>
            {% endif %}
        </div>
    </td>
    <td>
        <span class="status-badge status-{{ load.status }}">{{ load.get_status_display }}</span>
    </td>
    <td class="action-col">
        <div class="action-buttons">
            <button class="action-view" title="View"><i class="fas fa-eye"></i></button>
            <button class="action-edit" title="Edit" onclick="window.location.href='{% url 'edit_load' load.id %}'">
  <i class="fas fa-edit"></i>
</button>
            <button class="action-delete" data-load-id="{{ load.id }}" title="Delete"><i class="fas fa-trash"></i></button>
        </div>
    </td>
</tr>
{% endfor %}
        {% else %}
          <tr><td colspan="5" style="text-align:center;padding:40px;color:#6b7280;">No loads found.</td></tr>
        {% endif %}
      </tbody>
    </table>

    <!-- Pagination -->
    <div class="pagination-container">
      <div class="entries-per-page">
        <span>Show</span>
        <select id="entriesPerPage">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="25">25</option>
          <option value="50">50</option>
        </select>
        <span>entries</span>
      </div>
      <div class="pagination-info">
        Showing <span id="showingStart">0</span> to <span id="showingEnd">0</span> of <span id="totalEntries">0</span> entries
      </div>
      <div class="pagination-controls">
        <button id="prevPage" disabled>Previous</button>
        <span id="currentPageInfo">Page 1</span>
        <button id="nextPage">Next</button>
      </div>
    </div>
  </div>

  <!-- RIGHT SIDEBAR - Reduced Width -->
  <div id="profileSidebar">
    <button class="close-btn" id="closeSidebar">×</button>

    <!-- Header -->
    <div class="sidebar-section">
      <div class="sidebar-header">
        <h3 id="sidebarLoadId"></h3>
        <p id="sidebarStatus"></p>
      </div>
    </div>

    <!-- Route -->
    <div class="sidebar-section">
      <div class="route-container">
        <div class="route-info">
          <div class="route-locations">
            <div id="sidebarPickup"></div>
            <i class="fas fa-arrow-right" style="color:#dc2626;font-size:14px;"></i>
            <div id="sidebarDrop"></div>
          </div>
          <i class="fas fa-truck" style="color:#dc2626;font-size:18px;"></i>
        </div>
        <div class="progress-container">
          <div class="progress-bar"></div>
          <i class="fas fa-car-side progress-icon"></i>
        </div>
      </div>
    </div>

    <!-- TRIP REQUESTS -->
    <div class="sidebar-section">
      <h4>Trip Requests By Owner</h4>
      <div id="tripRequestsContainer" class="trip-requests-container">
        <div style="text-align:center;padding:40px 20px;color:#6b7280;font-size:14px;">
          Select a load to view trip requests
        </div>
      </div>
    </div>

    <!-- CONFIRM ASSIGNMENT PANEL -->
    <div id="confirmAssignmentPanel" class="confirm-panel" style="display:none;">
      <h4>Assign Vehicle & Driver</h4>
      
      <!-- Dropdowns -->
      <div class="form-grid">
        <div class="form-group">
          <select id="vehicleTypeSelect"><option value="">Select vehicle</option></select>
          <button type="button" id="openAddVehicleModal" style="margin-top:6px;color:#dc2626;background:none;border:none;font-size:13px;font-weight:500;cursor:pointer;text-decoration:underline;">
            + New Vehicle
          </button>
        </div>
        <div class="form-group">
          <select id="driverSelect"><option value="">Select Driver</option></select>
          <button type="button" id="openAddDriverModalBtn" style="margin-top:6px;color:#dc2626;background:none;border:none;font-size:13px;font-weight:500;cursor:pointer;text-decoration:underline;">
            + New Driver
          </button>
        </div>
      </div>

      <!-- Confirm Button -->
      <button id="finalConfirmBtn" class="confirm-btn">
        Confirm Assignment
      </button>
    </div>

    <!-- Customer Details -->
    <div class="sidebar-section" style="background:#fef3c7; border-left: 4px solid #f59e0b;">
      <h4 style="color:#92400e; margin-top: 0;">Customer Details</h4>
      <div class="trip-info-grid">
        <div>
          <div class="trip-info-label" style="color:#92400e;">Customer Name</div>
          <div id="sidebarCustomerName" class="trip-info-value" style="color:#451a03;"></div>
        </div>
        <div>
          <div class="trip-info-label" style="color:#92400e;">Phone</div>
          <div id="sidebarCustomerPhone" class="trip-info-value" style="color:#451a03;"></div>
        </div>
        <div>
          <div class="trip-info-label" style="color:#92400e;">Location</div>
          <div id="sidebarCustomerLocation" class="trip-info-value" style="color:#451a03;"></div>
        </div>
                <div>
          <div class="trip-info-label" style="color:#92400e;">Customer Amount</div>
          <div id="sidebarCustomerAmount" class="trip-info-value" style="color:#451a03;"></div>
        </div>
                <div>
          <div class="trip-info-label" style="color:#92400e;">Vendor Amount</div>
          <div id="sidebarVendorAmount" class="trip-info-value" style="color:#451a03;"></div>
        </div>
      </div>
    </div>

    <!-- Contact Person Details -->
    <div class="sidebar-section" style="background:#dbeafe; border-left: 4px solid #3b82f6;">
      <h4 style="color:#1e3a8a; margin-top: 0;">Contact Person</h4>
      <div class="trip-info-grid">
        <div>
          <div class="trip-info-label" style="color:#1e3a8a;">Name</div>
          <div id="sidebarContactPersonName" class="trip-info-value" style="color:#0c2340;"></div>
        </div>
        <div>
          <div class="trip-info-label" style="color:#1e3a8a;">Phone</div>
          <div id="sidebarContactPersonPhone" class="trip-info-value" style="color:#0c2340;"></div>
        </div>
      </div>
    </div>

    <!-- Trip Info -->
    <div class="sidebar-section" style="background:#fafafa;">
      <h4>Trip Information</h4>
      <div class="trip-info-grid">
        <div>
          <div class="trip-info-label">Vehicle Type</div>
          <div id="sidebarVehicleType" class="trip-info-value"></div>
        </div>
        <div>
          <div class="trip-info-label">Date & Time</div>
          <div id="sidebarDateTime" class="trip-info-value"></div>
        </div>
        <div>
          <div class="trip-info-label">Material</div>
          <div id="sidebarMaterial" class="trip-info-value"></div>
        </div>
        <div>
          <div class="trip-info-label">Weight</div>
          <div id="sidebarWeight" class="trip-info-value"></div>
        </div>
      </div>
    </div>
<!-- Add this after the Trip Info section in your sidebar -->
<div class="sidebar-section">
  <button class="assign-vendor-btn" id="openAssignVendorModal">
    <i class="fas fa-user-plus"></i> Assign Vendor
  </button>
</div>

    <!-- Close Trip Button -->
    <div class="sidebar-section">
      <button class="close-trip-btn">
        Close Trip
      </button>
    </div>
  </div>
  <div id="sidebarOverlay"></div>
</div>

<!-- ====================== ADD LOAD MODAL (CORRECTED UI) ====================== -->
<div id="addLoadModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Create New Load</h3>
      <button class="modal-close" id="closeLoadModal">×</button>
    </div>
    <p class="modal-subtitle">Fill in the details below to create a new load request</p>

    <form id="addLoadForm" enctype="multipart/form-data">
      {% csrf_token %}

      <!-- Load Info Section -->
      <div class="section-header">
        <i class="fas fa-info-circle"></i> Load Information
      </div>

      <div class="form-row">
  <div class="form-group">
    <label>Customer <span class="required">*</span></label>
    <select name="customer" id="customerSelect" required>
      <option value="">Select Customer</option>
      {% for customer in customers %}
      <option value="{{ customer.id }}"
              data-phone="{{ customer.phone_number|default:'' }}"
              data-location="{{ customer.location|default:'' }}">
        {{ customer.customer_name }}
      </option>
      {% endfor %}
      <option value="__add_new__" style="font-weight: bold; color: #dc2626;">+ Add New Customer</option>
    </select>
  </div>
  <div class="form-group">
    <label>Contact Person <span class="required">*</span></label>
    <select name="contactPerson" id="contactPersonSelect" required>
      <option value="">Select Contact Person</option>
      <option value="__add_new__" style="font-weight: bold; color: #dc2626;">+ Add New Contact Person</option>
    </select>
  </div>
</div>

<div class="form-row">
  <div class="form-group">
    <label>Contact Phone</label>
    <input type="tel" name="contactPersonPhone" id="contactPersonPhone" placeholder="Phone number will auto-fill" readonly>
  </div>
  <div class="form-group">
    <label>Customer Amount (Optional)</label>
    <input type="number" 
           name="customer_amount" 
           id="customerAmountInput"
           step="0.01" 
           min="0" 
           placeholder="Enter customer-specific amount"
           style="font-size:14px; font-weight:600; padding: 10px;">
    <small style="color:#6b7280; font-size: 12px; margin-top: 4px;">Customer-specific amount for this load</small>
  </div>
</div>

<div class="form-row">
  <div class="form-group">
    <label>Vehicle Type <span class="required">*</span></label>
    <select name="vehicleType" required>
      <option value="">Select Vehicle Type</option>
      {% for vehicle_type in vehicle_types %}
      <option value="{{ vehicle_type.id }}">{{ vehicle_type.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="form-group">
    <label>Assign Traffic Person</label>
    <select name="assigned_traffic_person" id="trafficPersonSelect">
      <option value="">Select Traffic Person</option>
      {% for employee in employees %}
      <option value="{{ employee.id }}">{{ employee.full_name }}</option>
      {% endfor %}
    </select>
  </div>
</div>

      <!-- Route & Schedule Section -->
      <div class="section-header">
        <i class="fas fa-route"></i> Route & Schedule
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Pickup Location <span class="required">*</span></label>
          <input type="text" name="pickupLocation" required placeholder="e.g. Mumbai Port">
        </div>
        <div class="form-group">
          <label>Drop Location <span class="required">*</span></label>
          <input type="text" name="dropLocation" required placeholder="e.g. Delhi Warehouse">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Pickup Date <span class="required">*</span></label>
          <input type="date" name="pickupDate" id="pickupDate" required>
        </div>
        <div class="form-group">
          <label>Drop Date</label>
          <input type="date" name="dropDate" id="dropDate">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Time (Optional)</label>
          <div class="time-input-group">
            <input type="text" id="timeInput" placeholder="02:30" maxlength="5">
            <select id="ampmSelect">
              <option value="AM">AM</option>
              <option value="PM" selected>PM</option>
            </select>
            <input type="hidden" name="time" id="hiddenTimeInput">
          </div>
        </div>
        <div class="form-group">
          <label>Material</label>
          <input type="text" name="material" placeholder="e.g. Cement, Rice">
        </div>
      </div>

      <!-- Weight Section -->
      <div class="form-row">
        <div class="form-group">
          <label>Weight (Optional)</label>
          <input type="text" name="weight" placeholder="e.g. 20 Ton">
          <small style="color:#6b7280; font-size: 12px; margin-top: 4px;">Only for display purposes</small>
        </div>
        <div class="form-group"></div>
      </div>

      <div class="form-row">
        <div class="form-group full-width">
          <label>Total Trip Amount</label>
          <input type="number" 
                 name="total_amount" 
                 id="totalAmountInput"
                 step="1" 
                 min="1000" 
                  
                 placeholder="Enter full freight amount"
                 style="font-size:16px; font-weight:600; padding: 12px;">
          <small style="color:#6b7280; font-size: 12px; margin-top: 4px;">Enter the complete freight amount for the trip</small>
        </div>
      </div>

      <!-- Payment Split Section -->
      <div style="background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 16px; margin: 16px 0;">
        <div style="font-weight: 600; color: #1e40af; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
          <i class="fas fa-coins"></i> Payment Split (90% & 10%)
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>First Half Payment (90%)</label>
            <input type="number" id="firstHalfPaymentInput" name="first_half_payment" step="0.01" min="0" value="0.00" placeholder="Enter or auto-calculated" style="font-size: 14px; font-weight: 600; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
            <small style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">Edit this amount - second half will auto-adjust to match total</small>
          </div>
          <div class="form-group">
            <label>Second Half Payment (10%)</label>
            <input type="number" id="secondHalfPaymentInput" name="second_half_payment" step="0.01" min="0" value="0.00" placeholder="Enter or auto-calculated" style="font-size: 14px; font-weight: 600; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
            <small style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">Edit this amount - first half will auto-adjust to match total</small>
          </div>
        </div>
      </div>

      <!-- Final Payment -->
      <div class="form-row">
        <div class="form-group">
          <label>Final Payment</label>
          <div class="payment-display final-payment">
            <input type="text" id="finalPaymentDisplay" readonly value="₹ 0">
          </div>
          <input type="hidden" name="final_payment" id="hiddenFinalPayment">
        </div>
      </div>

      <!-- Notes Section -->
      <div class="section-header">
        <i class="fas fa-sticky-note"></i> Additional Notes
      </div>
      <div class="form-row single-column">
        <div class="form-group full-width">
          <label>Notes</label>
          <textarea name="notes" rows="3" placeholder="Any special instructions or additional information..."></textarea>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="modal-actions">
        <button type="button" class="cancel-btn" id="cancelLoadModal">Cancel</button>
        <button type="submit" class="save-btn">Create Load</button>
      </div>
    </form>
  </div>
</div>

<!-- ====================== ADD NEW CUSTOMER MODAL ====================== -->
<div id="addNewCustomerModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Add New Customer</h3>
      <button class="modal-close" id="closeNewCustomerModal">×</button>
    </div>
    <p class="modal-subtitle">Fill in the details below to add a new customer</p>

    <form id="addNewCustomerForm">
      {% csrf_token %}
      
      <div class="form-row">
        <div class="form-group">
          <label>Customer Name <span class="required">*</span></label>
          <input type="text" name="customer_name" required placeholder="Enter customer name" minlength="2">
        </div>
        <div class="form-group">
          <label>Phone Number <span class="required">*</span></label>
          <input type="tel" name="phone_number" required placeholder="10-digit mobile number" pattern="[0-9]{10}" title="Please enter a valid 10-digit phone number">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Location</label>
          <input type="text" name="location" placeholder="Enter customer location">
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="cancel-btn" id="cancelNewCustomerModal">Cancel</button>
        <button type="submit" class="save-btn">Save Customer</button>
      </div>
    </form>
  </div>
</div>

<!-- ====================== ADD NEW CONTACT PERSON MODAL ====================== -->
<div id="addNewContactPersonModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Add New Contact Person</h3>
      <button class="modal-close" id="closeNewContactPersonModal">×</button>
    </div>
    <p class="modal-subtitle">Fill in the details below to add a new contact person</p>

    <form id="addNewContactPersonForm">
      {% csrf_token %}
      <input type="hidden" name="customer_id" id="contactPersonCustomerId">
      
      <div class="form-row">
        <div class="form-group">
          <label>Contact Person Name <span class="required">*</span></label>
          <input type="text" name="contact_name" required placeholder="Enter contact person name" minlength="2">
        </div>
        <div class="form-group">
          <label>Phone Number <span class="required">*</span></label>
          <input type="tel" name="contact_phone" required placeholder="10-digit mobile number" pattern="[0-9]{10}" title="Please enter a valid 10-digit phone number">
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="cancel-btn" id="cancelNewContactPersonModal">Cancel</button>
        <button type="submit" class="save-btn">Save Contact Person</button>
      </div>
    </form>
  </div>
</div>

<!-- ====================== ADD DRIVER MODAL ====================== -->
<div id="addDriverModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Add New Driver</h3>
      <button class="modal-close" id="closeDriverModal">×</button>
    </div>
    <p class="modal-subtitle">Add a new driver to this vendor's fleet</p>

    <form id="quickAddDriverForm" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" name="vendor_id" id="quickDriverVendorId">

      <!-- Personal Info Section -->
      <div class="section-header">
        <i class="fas fa-user"></i> Personal Information
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Full Name <span class="required">*</span></label>
          <input type="text" name="full_name" required placeholder="Enter driver's full name">
        </div>
        <div class="form-group">
          <label>Phone Number <span class="required">*</span></label>
          <input type="tel" name="phone_number" required placeholder="10-digit mobile number">
        </div>
      </div>

      <!-- Documents Section -->
      <div class="section-header">
        <i class="fas fa-file-alt"></i> Documents
      </div>

      <div class="form-row single-column">
        <div class="form-group full-width">
          <label>PAN Card Document</label>
          <div class="file-upload-area" id="panUploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Drag and drop files here or <span class="browse-link" data-input="panDocument">Browse Files</span></p>
            <input type="file" id="panDocument" name="pan_document" accept=".pdf,.jpg,.jpeg,.png" style="display:none;">
            <span id="panFileName" class="file-name"></span>
          </div>
        </div>
      </div>

      <div class="form-row single-column">
        <div class="form-group full-width">
          <label>Aadhar Card Document</label>
          <div class="file-upload-area" id="aadharUploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Drag and drop files here or <span class="browse-link" data-input="aadharDocument">Browse Files</span></p>
            <input type="file" id="aadharDocument" name="aadhar_document" accept=".pdf,.jpg,.jpeg,.png" style="display:none;">
            <span id="aadharFileName" class="file-name"></span>
          </div>
        </div>
      </div>

      <div class="form-row single-column">
        <div class="form-group full-width">
          <label>Driving License Document</label>
          <div class="file-upload-area" id="licenseUploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Drag and drop files here or <span class="browse-link" data-input="licenseDocument">Browse Files</span></p>
            <input type="file" id="licenseDocument" name="license_document" accept=".pdf,.jpg,.jpeg,.png" style="display:none;">
            <span id="licenseFileName" class="file-name"></span>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="cancel-btn" id="cancelDriverModal">Cancel</button>
        <button type="submit" class="save-btn">Save Driver</button>
      </div>
    </form>
  </div>
</div>

<!-- ====================== ADD VEHICLE MODAL ====================== -->
<div id="addVehicleModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Add New Vehicle</h3>
      <button class="modal-close" id="closeVehicleModal">×</button>
    </div>
    <p class="modal-subtitle">Add a new vehicle to this vendor's fleet</p>

    <form id="quickAddVehicleForm" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" name="vendor_id" id="quickVehicleVendorId">

      <!-- Vehicle Details Section -->
      <div class="section-header">
        <i class="fas fa-truck"></i> Vehicle Details
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Registration Number <span class="required">*</span></label>
          <input type="text" name="reg_no" required placeholder="e.g. TN45AB1234" style="text-transform: uppercase;">
        </div>
        <div class="form-group">
          <label>Vehicle Type <span class="required">*</span></label>
          <select name="vehicle_type" required>
            <option value="">Select Vehicle Type</option>
            {% for vehicle_type in vehicle_types %}
            <option value="{{ vehicle_type.id }}">{{ vehicle_type.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- Documents Section -->
      <div class="section-header">
        <i class="fas fa-file-alt"></i> Vehicle Documents
      </div>

      <div class="form-row single-column">
        <div class="form-group full-width">
          <label>Insurance Document</label>
          <div class="file-upload-area" id="insuranceUploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Drag and drop files here or <span class="browse-link" data-input="insuranceDocument">Browse Files</span></p>
            <input type="file" id="insuranceDocument" name="insurance_document" accept=".pdf,.jpg,.jpeg,.png" style="display:none;">
            <span id="insuranceFileName" class="file-name"></span>
          </div>
        </div>
      </div>

      <div class="form-row single-column">
        <div class="form-group full-width">
          <label>RC (Registration Certificate) Document</label>
          <div class="file-upload-area" id="rcUploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Drag and drop files here or <span class="browse-link" data-input="rcDocument">Browse Files</span></p>
            <input type="file" id="rcDocument" name="rc_document" accept=".pdf,.jpg,.jpeg,.png" style="display:none;">
            <span id="rcFileName" class="file-name"></span>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="cancel-btn" id="cancelVehicleModal">Cancel</button>
        <button type="submit" class="save-btn">Save Vehicle</button>
      </div>
    </form>
  </div>
</div>


<!-- vendor modal -->
<!-- ====================== ASSIGN VENDOR MODAL ====================== -->
<div id="assignVendorModal" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
      <h3>Assign Vendor to Load</h3>
      <button class="modal-close" id="closeAssignVendorModal">×</button>
    </div>
    <p class="modal-subtitle">Select a vendor to assign to Load ID: <span id="assignLoadId"></span></p>

    <div class="modal-body" style="display: flex; gap: 20px; padding: 0;">
      <!-- Left Section: Vendors List -->
      <div style="flex: 0 0 40%; border-right: 1px solid #e5e7eb; padding: 20px 32px;">
        <!-- Search Bar -->
        <div class="form-row" style="margin: 0 0 20px;">
          <div class="form-group full-width">
            <input type="text" id="vendorSearchInput" placeholder="Search vendors..." 
                   style="padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
          </div>
        </div>

        <!-- Vendors List -->
        <div class="vendors-list-container" style="max-height: 400px; overflow-y: auto;">
          <div id="vendorsList">
            <!-- Vendors will be loaded here -->
          </div>
        </div>

        <!-- Loading State -->
        <div id="vendorsLoading" style="text-align: center; padding: 40px 0; color: #6b7280; display: none;">
          <i class="fas fa-spinner fa-spin"></i> Loading vendors...
        </div>

        <!-- Empty State -->
        <div id="vendorsEmpty" style="text-align: center; padding: 40px 0; color: #9ca3af; display: none;">
          <i class="fas fa-users-slash" style="font-size: 36px; margin-bottom: 16px;"></i>
          <p>No vendors available</p>
        </div>

        <!-- Error State -->
        <div id="vendorsError" style="text-align: center; padding: 40px 0; color: #dc2626; display: none;">
          <i class="fas fa-exclamation-circle" style="font-size: 36px; margin-bottom: 16px;"></i>
          <p>Error loading vendors</p>
        </div>
      </div>

      <!-- Right Section: Vehicles and Drivers -->
      <div style="flex: 1; padding: 20px 32px; overflow-y: auto; max-height: 400px;">
        <div id="vendorDetailsPanel" style="display: none;">
          <div id="selectedVendorInfo" style="margin-bottom: 20px; padding: 15px; background: #f3f4f6; border-radius: 8px;">
            <!-- Selected vendor info will be displayed here -->
          </div>

          <!-- Vehicles Section -->
          <div style="margin-bottom: 20px;">
            <h4 style="margin-bottom: 10px; color: #374151; font-size: 14px; font-weight: 600;">Select Vehicle *</h4>
            <select id="assignVendorVehicleSelect" style="width: 100%; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
              <option value="">-- Select a vehicle --</option>
            </select>
            <div id="vendorVehiclesList" style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px; font-size: 12px; color: #6b7280;">
              <div style="text-align: center; color: #9ca3af; padding: 10px;">Select a vendor to view vehicles</div>
            </div>
          </div>

          <!-- Drivers Section -->
          <div>
            <h4 style="margin-bottom: 10px; color: #374151; font-size: 14px; font-weight: 600;">Select Driver *</h4>
            <select id="assignVendorDriverSelect" style="width: 100%; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
              <option value="">-- Select a driver --</option>
            </select>
            <div id="vendorDriversList" style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px; font-size: 12px; color: #6b7280;">
              <div style="text-align: center; color: #9ca3af; padding: 10px;">Select a vendor to view drivers</div>
            </div>
          </div>

          <!-- Update Amount Section -->
          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
            <h4 style="margin-bottom: 10px; color: #374151; font-size: 14px; font-weight: 600;">Update Amount (Optional)</h4>
            <div style="background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
              <small style="color: #1e40af; font-size: 12px;">
                <i class="fas fa-info-circle"></i> Current Amount: <span id="currentAmountDisplay" style="font-weight: 600;">₹0.00</span>
              </small>
            </div>
            <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #374151;">
              New Amount (₹)
            </label>
            <input type="number" 
                   id="updateAmountInput" 
                   placeholder="Enter new amount" 
                   step="0.01" 
                   min="0"
                   style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; margin-bottom: 8px;">
            <small style="color: #6b7280; font-size: 12px; display: block;">
              Leave empty to keep current amount
            </small>
          </div>
        </div>

        <div id="vendorDetailsEmpty" style="text-align: center; padding: 60px 20px; color: #9ca3af;">
          <i class="fas fa-arrow-left" style="font-size: 36px; margin-bottom: 16px;"></i>
          <p>Select a vendor to view vehicles and drivers</p>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button type="button" class="cancel-btn" id="cancelAssignVendorModal">Cancel</button>
      <button type="button" class="save-btn" id="confirmVendorAssignment" disabled>Assign Vendor</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script>
// Global variables
let currentLoadId = null;
let selectedRequestId = null;
let currentVendorId = null;
let csrftoken = null;
let selectedVendorId = null;
let selectedVendorName = null;

// Store contact persons data globally
let contactPersonsData = {};

document.addEventListener('DOMContentLoaded', function () {
  csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const sidebar = document.getElementById('profileSidebar');
  const overlay = document.getElementById('sidebarOverlay');
  const tripRequestsContainer = document.getElementById('tripRequestsContainer');
  const confirmPanel = document.getElementById('confirmAssignmentPanel');
  const vehicleTypeSelect = document.getElementById('vehicleTypeSelect');
  const driverSelect = document.getElementById('driverSelect');

  // Modal elements
  const addLoadModal = document.getElementById('addLoadModal');
  const addDriverModal = document.getElementById('addDriverModal');
  const addVehicleModal = document.getElementById('addVehicleModal');
  const assignVendorModal = document.getElementById('assignVendorModal');

  const openAddModalBtn = document.getElementById('openAddModal');
  const closeLoadModal = document.getElementById('closeLoadModal');
  const cancelLoadModal = document.getElementById('cancelLoadModal');
  const openAddDriverModalBtn = document.getElementById('openAddDriverModalBtn');
  const openAddVehicleModalBtn = document.getElementById('openAddVehicleModal');

  // Contact person elements
  const customerSelect = document.getElementById('customerSelect');
  const contactPersonSelect = document.getElementById('contactPersonSelect');
  const contactPhoneInput = document.getElementById('contactPersonPhone');

  function showToast(text, type = 'info') {
    const colors = { success: '#16a34a', error: '#dc2626', info: '#2563eb' };
    Toastify({ 
      text, 
      duration: 3000, 
      gravity: "top", 
      position: "right", 
      style: { background: colors[type] },
      close: true 
    }).showToast();
  }

  // ====================== FETCH CONTACT PERSONS DATA ======================
  function fetchContactPersons() {
    fetch('/api/loads/customers/contact-persons/')
      .then(r => {
        if (!r.ok) {
          throw new Error(`HTTP error! status: ${r.status}`);
        }
        return r.json();
      })
      .then(data => {
        if (data.success && data.contact_persons) {
          contactPersonsData = data.contact_persons;
          console.log('Contact persons loaded successfully');
        } else {
          console.error('Failed to load contact persons:', data.error);
          showToast('Failed to load contact persons', 'error');
        }
      })
      .catch(error => {
        console.error('Error fetching contact persons:', error);
        showToast('Error loading contact persons data', 'error');
      });
  }

  // Initialize contact persons data on page load
  fetchContactPersons();

  // ====================== CUSTOMER & CONTACT PERSON AUTO-FILL ======================
  customerSelect?.addEventListener('change', function() {
    const customerId = this.value;
    const selectedOption = this.options[this.selectedIndex];
    
    // Handle "Add New Customer" option
    if (customerId === '__add_new__') {
      document.getElementById('addNewCustomerModal').style.display = 'flex';
      this.value = ''; // Reset the select
      return;
    }
    
    const customerPhone = selectedOption.dataset.phone || '';
    const customerLocation = selectedOption.dataset.location || '';
    
    // Clear contact person dropdown and phone
    contactPersonSelect.innerHTML = '<option value="">Select Contact Person</option>';
    contactPersonSelect.appendChild(new Option('+ Add New Contact Person', '__add_new__'));
    contactPhoneInput.value = '';
    contactPhoneInput.placeholder = 'Phone number will auto-fill';
    
    if (!customerId) {
      return;
    }
    
    // Show loading in dropdown
    contactPersonSelect.innerHTML = '<option value="">Loading contact persons...</option>';
    
    // Small delay to show loading state
    setTimeout(() => {
      // Add customer as first contact option
      contactPersonSelect.innerHTML = '<option value="">Select Contact Person</option>';
      
      const customerOption = document.createElement('option');
      customerOption.value = 'customer_primary';
      customerOption.textContent = selectedOption.textContent + ' (Primary)';
      customerOption.dataset.phone = customerPhone;
      contactPersonSelect.appendChild(customerOption);
      
      // Add contact persons for this customer from cached data
      if (contactPersonsData[customerId] && contactPersonsData[customerId].length > 0) {
        contactPersonsData[customerId].forEach(contact => {
          const option = document.createElement('option');
          option.value = contact.id;
          option.textContent = contact.name;
          option.dataset.phone = contact.phone_number || '';
          contactPersonSelect.appendChild(option);
        });
      }
      
      // Add "Add New Contact Person" option
      const addNewOption = document.createElement('option');
      addNewOption.value = '__add_new__';
      addNewOption.textContent = '+ Add New Contact Person';
      addNewOption.style.fontWeight = 'bold';
      addNewOption.style.color = '#dc2626';
      contactPersonSelect.appendChild(addNewOption);
      
      // If only customer primary, auto-select it and show phone
      if (contactPersonSelect.options.length === 3) { // 1 for placeholder + 1 for primary + 1 for add new
        contactPersonSelect.selectedIndex = 1;
        contactPhoneInput.value = customerPhone;
      }
      
      // If no contact persons found, show message
      if (contactPersonSelect.options.length === 2) { // Only placeholder and add new
        const noContactsOption = document.createElement('option');
        noContactsOption.value = '';
        noContactsOption.textContent = 'No contact persons found';
        noContactsOption.disabled = true;
        contactPersonSelect.insertBefore(noContactsOption, contactPersonSelect.querySelector('option[value="__add_new__"]'));
      }
    }, 100);
  });

  // When contact person changes, update phone number
  contactPersonSelect?.addEventListener('change', function() {
    const selectedValue = this.value;
    
    // Handle "Add New Contact Person" option
    if (selectedValue === '__add_new__') {
      const customerId = customerSelect.value;
      if (!customerId) {
        showToast('Please select a customer first', 'warning');
        this.value = ''; // Reset the select
        return;
      }
      document.getElementById('contactPersonCustomerId').value = customerId;
      document.getElementById('addNewContactPersonModal').style.display = 'flex';
      this.value = ''; // Reset the select
      return;
    }
    
    const selectedOption = this.options[this.selectedIndex];
    const phone = selectedOption.dataset.phone || '';
    contactPhoneInput.value = phone;
    
    // If "Select Contact Person" or disabled option is selected, clear phone
    if (!selectedOption.value || selectedOption.disabled) {
      contactPhoneInput.value = '';
      if (selectedOption.disabled) {
        contactPhoneInput.placeholder = 'No contact persons available';
      }
    }
  });

  // ====================== 90-10 PAYMENT SPLIT CALCULATION ======================
  function calculatePaymentSplit() {
    const totalInput = document.getElementById('totalAmountInput');
    const finalDisplay = document.getElementById('finalPaymentDisplay');
    const hiddenFinalPayment = document.getElementById('hiddenFinalPayment');
    const firstHalfInput = document.getElementById('firstHalfPaymentInput');
    const secondHalfInput = document.getElementById('secondHalfPaymentInput');

    if (!totalInput || !finalDisplay) return;

    const total = parseFloat(totalInput.value) || 0;

    if (total > 0) {
      const finalPayment = total;
      const firstHalfPayment = total * 0.90;  // 90%
      const secondHalfPayment = total * 0.10; // 10%

      finalDisplay.value = '₹ ' + finalPayment.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      hiddenFinalPayment.value = finalPayment;
      
      // Update input fields (only if they haven't been manually modified)
      if (!firstHalfInput.dataset.modified) {
        firstHalfInput.value = firstHalfPayment.toFixed(2);
      }
      if (!secondHalfInput.dataset.modified) {
        secondHalfInput.value = secondHalfPayment.toFixed(2);
      }
    } else {
      finalDisplay.value = '₹ 0.00';
      hiddenFinalPayment.value = '';
      
      if (!firstHalfInput.dataset.modified) {
        firstHalfInput.value = '0.00';
      }
      if (!secondHalfInput.dataset.modified) {
        secondHalfInput.value = '0.00';
      }
    }
  }

  // Initialize payment calculation when modal opens
  openAddModalBtn?.addEventListener('click', function () {
    addLoadModal.style.display = 'flex';
    
    // Reset contact person fields
    if (customerSelect) customerSelect.selectedIndex = 0;
    if (contactPersonSelect) contactPersonSelect.innerHTML = '<option value="">Select Contact Person</option>';
    if (contactPhoneInput) {
      contactPhoneInput.value = '';
      contactPhoneInput.placeholder = 'Phone number will auto-fill';
    }
    
    setTimeout(() => {
      const totalInput = document.getElementById('totalAmountInput');
      const firstHalfInput = document.getElementById('firstHalfPaymentInput');
      const secondHalfInput = document.getElementById('secondHalfPaymentInput');
      
      if (totalInput) {
        totalInput.focus();
        totalInput.addEventListener('input', calculatePaymentSplit);
        calculatePaymentSplit(); // Initial calculation
      }
      
      // Track manual modifications to payment fields with auto-adjustment
      if (firstHalfInput) {
        firstHalfInput.addEventListener('input', function () {
          this.dataset.modified = 'true';
          // Auto-adjust second half payment
          const finalPayment = parseFloat(document.getElementById('hiddenFinalPayment').value) || 0;
          const firstHalf = parseFloat(this.value) || 0;
          const secondHalf = finalPayment - firstHalf;
          
          if (secondHalfInput) {
            secondHalfInput.dataset.modified = 'true';
            secondHalfInput.value = Math.max(0, secondHalf).toFixed(2);
          }
        });
      }
      
      if (secondHalfInput) {
        secondHalfInput.addEventListener('input', function () {
          this.dataset.modified = 'true';
          // Auto-adjust first half payment
          const finalPayment = parseFloat(document.getElementById('hiddenFinalPayment').value) || 0;
          const secondHalf = parseFloat(this.value) || 0;
          const firstHalf = finalPayment - secondHalf;
          
          if (firstHalfInput) {
            firstHalfInput.dataset.modified = 'true';
            firstHalfInput.value = Math.max(0, firstHalf).toFixed(2);
          }
        });
      }
    }, 100);
  });

  // ====================== TIME INPUT FORMAT ======================
  const timeInput = document.getElementById('timeInput');
  const ampmSelect = document.getElementById('ampmSelect');
  const hiddenTimeInput = document.getElementById('hiddenTimeInput');

  if (timeInput) {
    timeInput.addEventListener('input', function (e) {
      let v = e.target.value.replace(/\D/g, '');
      if (v.length > 2) v = v.slice(0, 2) + ':' + v.slice(2, 4);
      e.target.value = v.slice(0, 5);
      if (hiddenTimeInput) hiddenTimeInput.value = v + ' ' + (ampmSelect?.value || 'PM');
    });
  }
  ampmSelect?.addEventListener('change', () => {
    if (timeInput && hiddenTimeInput) {
      hiddenTimeInput.value = timeInput.value + ' ' + ampmSelect.value;
    }
  });

  // ====================== DATE VALIDATION ======================
  const pickupDate = document.getElementById('pickupDate');
  const dropDate = document.getElementById('dropDate');
  if (pickupDate) {
    pickupDate.min = new Date().toISOString().split('T')[0];
    pickupDate.addEventListener('change', () => {
      if (dropDate) {
        dropDate.min = pickupDate.value;
        if (dropDate.value && dropDate.value < pickupDate.value) dropDate.value = pickupDate.value;
      }
    });
  }

  // ====================== SIDEBAR & TRIP REQUESTS ======================
  function openSidebar(row) {
    const data = JSON.parse(row.dataset.load);
    currentLoadId = row.dataset.loadId;

    document.getElementById('sidebarLoadId').textContent = data.load_id;
    document.getElementById('sidebarStatus').textContent = data.status_display;
    document.getElementById('sidebarPickup').textContent = data.pickup;
    document.getElementById('sidebarDrop').textContent = data.drop;
    document.getElementById('sidebarVehicleType').textContent = data.vehicle_type;
    document.getElementById('sidebarDateTime').textContent = `${data.date} ${data.time || ''}`;
    document.getElementById('sidebarMaterial').textContent = data.material || '-';
    document.getElementById('sidebarWeight').textContent = data.weight || '-';
    document.getElementById('sidebarCustomerName').textContent = data.customer_name || '-';
    document.getElementById('sidebarCustomerPhone').textContent = data.customer_phone || '-';
    document.getElementById('sidebarCustomerLocation').textContent = data.customer_location || '-';
    document.getElementById('sidebarContactPersonName').textContent = data.contact_person_name || '-';
    document.getElementById('sidebarContactPersonPhone').textContent = data.contact_person_phone || '-';
    document.getElementById('sidebarCustomerAmount').textContent = data.user_amount || '-';
    document.getElementById('sidebarVendorAmount').textContent = data.price_per_unit || '-';

    confirmPanel.style.display = 'none';
    loadTripRequests(currentLoadId);

    sidebar.classList.add('open');
    overlay.classList.add('show');
    document.querySelectorAll('.clickable-row').forEach(r => r.classList.remove('active'));
    row.classList.add('active');
  }

  // Load trip requests for a specific load
  function loadTripRequests(loadId) {
    tripRequestsContainer.innerHTML = `<div style="text-align:center;padding:40px;color:#6b7280;"><i class="fas fa-spinner fa-spin"></i> Loading...</div>`;

    fetch(`/loads/${loadId}/requests/`)
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(requests => {
        tripRequestsContainer.innerHTML = '';
        const pending = (requests || []).filter(r => r.status === 'pending');

        if (pending.length === 0) {
          tripRequestsContainer.innerHTML = `<div style="text-align:center;padding:40px;color:#9ca3af;">No pending requests</div>`;
          return;
        }

        pending.forEach(req => {
          const initials = (req.vendor_name || 'NA').split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase();
          const div = document.createElement('div');
          div.className = 'trip-request-item';
          div.innerHTML = `
            <div class="trip-request-info">
              
              <div class="vendor-details">
                <div>${req.vendor_name}</div>
                <div>${req.vendor_phone}</div>
              </div>
            </div>
            <div class="trip-request-actions">
              <button class="accept-btn" data-id="${req.id}" data-vendor-id="${req.vendor_id}">
                <i class="fas fa-check-circle" style="color:#16a34a"></i>
              </button>
              <button class="reject-btn" data-id="${req.id}">
                <i class="fas fa-times-circle" style="color:#dc2626"></i>
              </button>
            </div>`;
          tripRequestsContainer.appendChild(div);
        });

        // Accept Request
        tripRequestsContainer.querySelectorAll('.accept-btn').forEach(btn => {
          btn.onclick = () => {
            selectedRequestId = btn.dataset.id;
            currentVendorId = btn.dataset.vendorId;
            populateDropdowns(currentVendorId);
            confirmPanel.style.display = 'block';
          };
        });

        // Reject Request
        tripRequestsContainer.querySelectorAll('.reject-btn').forEach(btn => {
          btn.onclick = () => {
            if (confirm('Reject this request?')) {
              fetch(`/loads/${loadId}/requests/${btn.dataset.id}/reject/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken }
              })
              .then(r => r.json())
              .then(data => {
                if (data.success) {
                  showToast('Request rejected. Notification sent to vendor.', 'success');
                  loadTripRequests(loadId);
                } else {
                  showToast(data.message || 'Failed to reject request', 'error');
                }
              })
              .catch(error => {
                console.error('Error rejecting request:', error);
                showToast('Error rejecting request', 'error');
              });
            }
          };
        });
      })
      .catch(() => {
        tripRequestsContainer.innerHTML = `<div style="text-align:center;padding:40px;color:#dc2626;">Error loading requests</div>`;
      });
  }

  // Populate Vehicle & Driver dropdowns
  function populateDropdowns(vendorId) {
    vehicleTypeSelect.innerHTML = '<option>Loading vehicles...</option>';
    driverSelect.innerHTML = '<option>Loading drivers...</option>';

    Promise.all([
      fetch(`/api/vendors/${vendorId}/vehicles/`).then(r => r.json()),
      fetch(`/api/vendors/${vendorId}/drivers/`).then(r => r.json())
    ]).then(([vehiclesResp, driversResp]) => {
      const vehicles = (vehiclesResp && vehiclesResp.vehicles) || [];
      const drivers = (driversResp && driversResp.drivers) || [];

      vehicleTypeSelect.innerHTML = '<option value="">Select Vehicle</option>';
      driverSelect.innerHTML = '<option value="">Select Driver</option>';

      vehicles.forEach(v => {
        const opt = new Option(v.reg_no, v.id);
        vehicleTypeSelect.add(opt);
      });
      if (vehicles.length === 0) vehicleTypeSelect.add(new Option('No vehicles', ''));

      drivers.forEach(d => {
        const opt = new Option(`${d.full_name} - ${d.phone_number}`, d.id);
        driverSelect.add(opt);
      });
      if (drivers.length === 0) driverSelect.add(new Option('No drivers', ''));
    })
    .catch(error => {
      console.error('Error loading vehicles/drivers:', error);
      showToast('Error loading vehicles/drivers', 'error');
    });
  }

  // Final Assignment with Firebase Notification
  // Final Assignment
  document.getElementById('finalConfirmBtn')?.addEventListener('click', function () {
      const vehicleId = vehicleTypeSelect.value;
      const driverId = driverSelect.value;

      if (!vehicleId || !driverId) {
          showToast('Please select both vehicle and driver', 'error');
          return;
      }

      this.innerHTML = 'Assigning...';
      this.disabled = true;

      // Use the correct URL endpoint
      fetch(`/loads/${currentLoadId}/requests/${selectedRequestId}/accepted/`, {
          method: 'POST',
          headers: { 
              'X-CSRFToken': csrftoken, 
              'Content-Type': 'application/json',
              'Authorization': 'Bearer YOUR_ADMIN_TOKEN'  // Add if using JWT
          },
          body: JSON.stringify({ 
              vehicle_id: vehicleId, 
              driver_id: driverId 
          })
      })
      .then(r => {
          if (!r.ok) {
              throw new Error(`HTTP error! status: ${r.status}`);
          }
          return r.json();
      })
      .then(data => {
          if (data.success) {
              showToast('Trip assigned successfully! Notification sent to vendor.', 'success');
              
              // Remove the row from table
              const assignedRow = document.querySelector(`.clickable-row[data-load-id="${currentLoadId}"]`);
              if (assignedRow) {
                  assignedRow.remove();
                  updatePaginationAfterRemoval();
              }
              
              // Close sidebar
              sidebar.classList.remove('open');
              overlay.classList.remove('show');
              
              // Reset modal
              confirmPanel.style.display = 'none';
              vehicleTypeSelect.innerHTML = '<option value="">Select vehicle</option>';
              driverSelect.innerHTML = '<option value="">Select Driver</option>';
              
          } else {
              showToast(data.error || 'Failed to assign trip', 'error');
          }
      })
      .catch(error => {
          console.error('Error assigning trip:', error);
          showToast('Error assigning trip: ' + error.message, 'error');
      })
      .finally(() => {
          this.innerHTML = 'Confirm Assignment';
          this.disabled = false;
      });
  });

  // Update pagination after removing a row
  function updatePaginationAfterRemoval() {
    const allRows = Array.from(document.querySelectorAll('tr.clickable-row'));
    filteredRows = [...allRows];
    if (currentPage > Math.ceil(filteredRows.length / perPage)) {
      currentPage = Math.max(1, Math.ceil(filteredRows.length / perPage));
    }
    renderPage();
  }

  // Close sidebar
  document.getElementById('closeSidebar')?.addEventListener('click', () => {
    sidebar.classList.remove('open');
    overlay.classList.remove('show');
  });
  
  overlay.addEventListener('click', () => {
    sidebar.classList.remove('open');
    overlay.classList.remove('show');
  });

  // Row click → open sidebar
  document.querySelectorAll('.clickable-row').forEach(row => {
    row.addEventListener('click', e => {
      if (e.target.closest('.action-col')) return;
      openSidebar(row);
    });
  });

  // Modal Close Buttons
  closeLoadModal?.addEventListener('click', () => {
    addLoadModal.style.display = 'none';
    document.getElementById('addLoadForm').reset();
    
    // Reset contact person fields
    if (contactPersonSelect) contactPersonSelect.innerHTML = '<option value="">Select Contact Person</option>';
    if (contactPhoneInput) {
      contactPhoneInput.value = '';
      contactPhoneInput.placeholder = 'Phone number will auto-fill';
    }
  });
  
  cancelLoadModal?.addEventListener('click', () => {
    addLoadModal.style.display = 'none';
    document.getElementById('addLoadForm').reset();
    
    // Reset contact person fields
    if (contactPersonSelect) contactPersonSelect.innerHTML = '<option value="">Select Contact Person</option>';
    if (contactPhoneInput) {
      contactPhoneInput.value = '';
      contactPhoneInput.placeholder = 'Phone number will auto-fill';
    }
  });
  
  document.getElementById('closeDriverModal')?.addEventListener('click', () => {
    addDriverModal.style.display = 'none';
    document.getElementById('quickAddDriverForm').reset();
  });
  
  document.getElementById('closeVehicleModal')?.addEventListener('click', () => {
    addVehicleModal.style.display = 'none';
    document.getElementById('quickAddVehicleForm').reset();
  });

  // ====================== NEW CUSTOMER MODAL HANDLERS ======================
  document.getElementById('closeNewCustomerModal')?.addEventListener('click', () => {
    document.getElementById('addNewCustomerModal').style.display = 'none';
    document.getElementById('addNewCustomerForm').reset();
  });
  
  document.getElementById('cancelNewCustomerModal')?.addEventListener('click', () => {
    document.getElementById('addNewCustomerModal').style.display = 'none';
    document.getElementById('addNewCustomerForm').reset();
  });

  document.getElementById('addNewCustomerForm')?.addEventListener('submit', async function (e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const btn = this.querySelector('.save-btn');
    const oldText = btn.textContent;
    btn.textContent = 'Saving...';
    btn.disabled = true;

    try {
      const resp = await fetch('/api/customers/add-new/', {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken },
        body: formData
      });
      
      const json = await resp.json();
      
      if (json.success) {
        const customer = json.customer;
        
        // Add new customer to the dropdown
        const newOption = new Option(customer.customer_name, customer.id);
        newOption.dataset.phone = customer.phone_number || '';
        newOption.dataset.location = customer.location || '';
        
        // Add before the "Add New" option
        const addNewOption = customerSelect.querySelector('option[value="__add_new__"]');
        customerSelect.insertBefore(newOption, addNewOption);
        
        // Select the new customer
        customerSelect.value = customer.id;
        customerSelect.dispatchEvent(new Event('change'));
        
        showToast('Customer added successfully', 'success');
        document.getElementById('addNewCustomerModal').style.display = 'none';
        this.reset();
      } else {
        showToast(json.error || 'Failed to add customer', 'error');
      }
    } catch (err) {
      console.error(err);
      showToast('Error adding customer', 'error');
    } finally {
      btn.textContent = oldText;
      btn.disabled = false;
    }
  });

  // ====================== NEW CONTACT PERSON MODAL HANDLERS ======================
  document.getElementById('closeNewContactPersonModal')?.addEventListener('click', () => {
    document.getElementById('addNewContactPersonModal').style.display = 'none';
    document.getElementById('addNewContactPersonForm').reset();
  });
  
  document.getElementById('cancelNewContactPersonModal')?.addEventListener('click', () => {
    document.getElementById('addNewContactPersonModal').style.display = 'none';
    document.getElementById('addNewContactPersonForm').reset();
  });

  // Close modals when clicking outside
  document.getElementById('addNewCustomerModal')?.addEventListener('click', (e) => {
    if (e.target.id === 'addNewCustomerModal') {
      e.target.style.display = 'none';
    }
  });

  document.getElementById('addNewContactPersonModal')?.addEventListener('click', (e) => {
    if (e.target.id === 'addNewContactPersonModal') {
      e.target.style.display = 'none';
    }
  });

  document.getElementById('addNewContactPersonForm')?.addEventListener('submit', async function (e) {
    e.preventDefault();
    
    const customerId = document.getElementById('contactPersonCustomerId').value;
    const contactName = this.querySelector('input[name="contact_name"]').value;
    const contactPhone = this.querySelector('input[name="contact_phone"]').value;
    
    if (!customerId || !contactName || !contactPhone) {
      showToast('Please fill all fields', 'error');
      return;
    }

    const btn = this.querySelector('.save-btn');
    const oldText = btn.textContent;
    btn.textContent = 'Saving...';
    btn.disabled = true;

    try {
      const formData = new FormData();
      formData.append('customer_id', customerId);
      formData.append('contact_name', contactName);
      formData.append('contact_phone', contactPhone);
      
      const resp = await fetch('/api/contact-persons/add-new/', {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken },
        body: formData
      });
      
      const json = await resp.json();
      
      if (json.success) {
        const contact = json.contact;
        
        // Add to contact persons data
        if (!contactPersonsData[customerId]) {
          contactPersonsData[customerId] = [];
        }
        
        contactPersonsData[customerId].push(contact);
        
        // Update the contact person select dropdown
        const newOption = document.createElement('option');
        newOption.value = contact.id;
        newOption.textContent = contact.name;
        newOption.dataset.phone = contact.phone_number || '';
        
        const addNewOption = contactPersonSelect.querySelector('option[value="__add_new__"]');
        contactPersonSelect.insertBefore(newOption, addNewOption);
        
        // Select the new contact person
        contactPersonSelect.value = contact.id;
        contactPersonSelect.dispatchEvent(new Event('change'));
        
        showToast('Contact person added successfully', 'success');
        document.getElementById('addNewContactPersonModal').style.display = 'none';
        this.reset();
      } else {
        showToast(json.error || 'Failed to add contact person', 'error');
      }
    } catch (err) {
      console.error(err);
      showToast('Error adding contact person', 'error');
    } finally {
      btn.textContent = oldText;
      btn.disabled = false;
    }
  });
  openAddDriverModalBtn?.addEventListener('click', () => {
    if (!currentVendorId) {
      showToast('No vendor selected. Please select a trip request first.', 'error');
      return;
    }
    document.getElementById('quickDriverVendorId').value = currentVendorId;
    addDriverModal.style.display = 'flex';
  });
  
  openAddVehicleModalBtn?.addEventListener('click', () => {
    if (!currentVendorId) {
      showToast('No vendor selected. Please select a trip request first.', 'error');
      return;
    }
    document.getElementById('quickVehicleVendorId').value = currentVendorId;
    addVehicleModal.style.display = 'flex';
  });

  // Add Load Form Submit - UPDATED FOR CONTACT PERSON
  document.getElementById('addLoadForm')?.addEventListener('submit', function (e) {
    e.preventDefault();
    
    // Validate contact person selection
    const selectedContactPerson = contactPersonSelect?.value;
    if (!selectedContactPerson) {
      showToast('Please select a contact person', 'error');
      return;
    }
    
    const formData = new FormData(this);
    console.log('Form data:', Object.fromEntries(formData));
    const btn = this.querySelector('.save-btn');
    const oldText = btn.innerHTML;
    btn.innerHTML = 'Saving...'; 
    btn.disabled = true;

    fetch('/loads/add/', { 
      method: 'POST', 
      headers: { 'X-CSRFToken': csrftoken }, 
      body: formData 
    })
      .then(r => r.json())
      .then(d => {
        if (d.success) {
          showToast('Load created successfully!', 'success');
          addLoadModal.style.display = 'none';
          this.reset();
          
          // Reset contact person fields
          if (contactPersonSelect) contactPersonSelect.innerHTML = '<option value="">Select Contact Person</option>';
          if (contactPhoneInput) {
            contactPhoneInput.value = '';
            contactPhoneInput.placeholder = 'Phone number will auto-fill';
          }
          
          setTimeout(() => location.reload(), 1500);
        } else {
          showToast(d.error || 'Failed to create load', 'error');
        }
      })
      .catch(error => {
        console.error('Error creating load:', error);
        showToast('Error creating load', 'error');
      })
      .finally(() => {
        btn.innerHTML = oldText; 
        btn.disabled = false;
      });
  });

  // File Upload Handlers
  document.querySelectorAll('.browse-link').forEach(link => {
    link.addEventListener('click', function () {
      const inputId = this.dataset.input;
      document.getElementById(inputId)?.click();
    });
  });

  document.querySelectorAll('input[type="file"]').forEach(input => {
    input.addEventListener('change', function () {
      const fileName = this.files[0]?.name || '';
      const display = this.parentElement.querySelector('.file-name');
      if (display) {
        display.textContent = fileName || 'No file chosen';
        display.style.color = fileName ? '#16a34a' : '#6b7280';
      }
    });
  });

  // Quick Add Driver Form
  document.getElementById('quickAddDriverForm')?.addEventListener('submit', function (e) {
    e.preventDefault();
    const formData = new FormData(this);
    const btn = this.querySelector('.save-btn');
    const oldText = btn.innerHTML;
    btn.innerHTML = 'Saving...'; 
    btn.disabled = true;

    fetch('/loads/add-driver/', {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken },
      body: formData
    })
    .then(r => r.json())
    .then(d => {
      if (d.success) {
        showToast('Driver added successfully!', 'success');
        addDriverModal.style.display = 'none';
        this.reset();
        document.querySelectorAll('.file-name').forEach(el => el.textContent = '');
        
        // Update driver dropdown
        fetch(`/api/vendors/${currentVendorId}/drivers/`)
          .then(r => r.json())
          .then(drivers => {
            driverSelect.innerHTML = '<option value="">Select Driver</option>';
            drivers.forEach(driver => {
              const opt = new Option(`${driver.full_name} - ${driver.phone_number}`, driver.id);
              driverSelect.add(opt);
            });
            if (d.driver_id) {
              driverSelect.value = d.driver_id;
              showToast('Driver added and selected', 'success');
            }
          });
      } else {
        showToast(d.error || 'Failed to add driver', 'error');
      }
    })
    .catch(error => {
      console.error('Error adding driver:', error);
      showToast('Error adding driver', 'error');
    })
    .finally(() => {
      btn.innerHTML = oldText; 
      btn.disabled = false;
    });
  });

  // Quick Add Vehicle Form
  document.getElementById('quickAddVehicleForm')?.addEventListener('submit', function (e) {
    e.preventDefault();
    const formData = new FormData(this);
    const btn = this.querySelector('.save-btn');
    const oldText = btn.innerHTML;
    btn.innerHTML = 'Saving...'; 
    btn.disabled = true;

    fetch('/loads/add-vehicle/', {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken },
      body: formData
    })
    .then(r => r.json())
    .then(d => {
      if (d.success) {
        showToast('Vehicle added successfully!', 'success');
        addVehicleModal.style.display = 'none';
        this.reset();
        document.querySelectorAll('.file-name').forEach(el => el.textContent = '');
        
        // Update vehicle dropdown
        fetch(`/api/vendors/${currentVendorId}/vehicles/`)
          .then(r => r.json())
          .then(vehicles => {
            vehicleTypeSelect.innerHTML = '<option value="">Select Vehicle</option>';
            vehicles.forEach(vehicle => {
              const opt = new Option(vehicle.reg_no, vehicle.id);
              vehicleTypeSelect.add(opt);
            });
            if (d.vehicle_id) {
              vehicleTypeSelect.value = d.vehicle_id;
              showToast('Vehicle added and selected', 'success');
            }
          });
      } else {
        showToast(d.error || 'Failed to add vehicle', 'error');
      }
    })
    .catch(error => {
      console.error('Error adding vehicle:', error);
      showToast('Error adding vehicle', 'error');
    })
    .finally(() => {
      btn.innerHTML = oldText; 
      btn.disabled = false;
    });
  });

  // Delete Load Button
  document.querySelectorAll('.action-delete').forEach(button => {
    button.addEventListener('click', function(e) {
      e.stopPropagation();
      const loadId = this.getAttribute('data-load-id');
      
      if (confirm('Are you sure you want to delete this load?')) {
        fetch(`/loads/${loadId}/delete/`, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrftoken }
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            showToast('Load deleted successfully', 'success');
            // Remove the row from table
            const row = this.closest('tr.clickable-row');
            if (row) {
              row.remove();
              updatePaginationAfterRemoval();
            }
          } else {
            showToast(data.message || 'Failed to delete load', 'error');
          }
        })
        .catch(error => {
          console.error('Error deleting load:', error);
          showToast('Error deleting load', 'error');
        });
      }
    });
  });

  // Pagination & Search
  const allRows = Array.from(document.querySelectorAll('tr.clickable-row'));
  let filteredRows = [...allRows];
  let currentPage = 1;
  let perPage = 10;

  function renderPage() {
    const start = (currentPage - 1) * perPage;
    const end = start + perPage;
    
    // Hide all rows first
    allRows.forEach(r => r.style.display = 'none');
    
    // Show only filtered rows for current page
    filteredRows.slice(start, end).forEach(r => r.style.display = '');
    
    // Update pagination info
    document.getElementById('showingStart').textContent = filteredRows.length ? start + 1 : 0;
    document.getElementById('showingEnd').textContent = Math.min(end, filteredRows.length);
    document.getElementById('totalEntries').textContent = filteredRows.length;
    document.getElementById('prevPage').disabled = currentPage === 1;
    document.getElementById('nextPage').disabled = end >= filteredRows.length;
    document.getElementById('currentPageInfo').textContent = `Page ${currentPage}`;
  }

  // Search functionality
  document.getElementById('searchInput')?.addEventListener('input', function () {
    const term = this.value.toLowerCase().trim();
    filteredRows = allRows.filter(row => {
      const rowText = row.textContent.toLowerCase();
      return rowText.includes(term);
    });
    currentPage = 1;
    renderPage();
  });

  // Entries per page
  document.getElementById('entriesPerPage')?.addEventListener('change', function () {
    perPage = parseInt(this.value);
    currentPage = 1;
    renderPage();
  });

  // Previous page
  document.getElementById('prevPage')?.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      renderPage();
    }
  });

  // Next page
  document.getElementById('nextPage')?.addEventListener('click', () => {
    if (currentPage * perPage < filteredRows.length) {
      currentPage++;
      renderPage();
    }
  });

  // Initialize pagination
  renderPage();

  // Chat functionality
  const chatInput = document.querySelector('.chat-input');
  const chatSendBtn = document.querySelector('.chat-send-btn');
  
  if (chatSendBtn && chatInput) {
    chatSendBtn.addEventListener('click', function() {
      const message = chatInput.value.trim();
      if (message && currentLoadId) {
        // Send chat message
        fetch(`/loads/${currentLoadId}/chat/`, {
          method: 'POST',
          headers: { 
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ message: message })
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            // Add message to chat UI
            const chatMessages = document.querySelector('.chat-messages');
            const newMessage = document.createElement('div');
            newMessage.className = 'chat-message';
            newMessage.innerHTML = `
              <div class="chat-label">Admin</div>
              <div class="chat-bubble admin">${message}</div>
              <div class="chat-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
            `;
            chatMessages.appendChild(newMessage);
            chatInput.value = '';
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }
        })
        .catch(error => console.error('Chat error:', error));
      }
    });
    
    // Send message on Enter key
    chatInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        chatSendBtn.click();
      }
    });
  }

  // Close Trip Button
  const closeTripBtn = document.querySelector('.close-trip-btn');
  if (closeTripBtn) {
    closeTripBtn.addEventListener('click', function() {
      if (!currentLoadId) {
        showToast('Please select a load first', 'error');
        return;
      }
      
      if (confirm('Are you sure you want to close this trip? This action cannot be undone.')) {
        closeTripBtn.disabled = true;
        closeTripBtn.style.opacity = '0.6';
        closeTripBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Closing...';
        
        fetch(`/api/trip/${currentLoadId}/close/`, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrftoken }
        })
        .then(r => r.json())
        .then(data => {
          closeTripBtn.disabled = false;
          closeTripBtn.style.opacity = '1';
          closeTripBtn.innerHTML = 'Close Trip';
          
          if (data.success) {
            showToast('Trip closed successfully', 'success');
            // Update UI
            document.getElementById('sidebarStatus').textContent = 'Closed';
            const statusBadge = document.querySelector(`.clickable-row[data-load-id="${currentLoadId}"] .status-badge`);
            if (statusBadge) {
              statusBadge.textContent = 'Closed';
              statusBadge.className = 'status-badge status-delivered';
            }
            
            // Close sidebar
            setTimeout(() => {
              sidebar.classList.remove('open');
              overlay.classList.remove('show');
              currentLoadId = null;
              location.reload();
            }, 1500);
          } else {
            console.error('Close trip error:', data);
            showToast(data.error || data.message || 'Failed to close trip', 'error');
          }
        })
        .catch(error => {
          closeTripBtn.disabled = false;
          closeTripBtn.style.opacity = '1';
          closeTripBtn.innerHTML = 'Close Trip';
          console.error('Error closing trip:', error);
          showToast('Network error: ' + error.message, 'error');
        });
      }
    });
  }

  // ====================== VENDOR ASSIGNMENT ======================
  
  // Add event listener for Assign Vendor button
  document.getElementById('openAssignVendorModal')?.addEventListener('click', function() {
    if (!currentLoadId) {
      showToast('Please select a load first', 'error');
      return;
    }
    
    // Get load data from active row
    const activeRow = document.querySelector('.clickable-row.active');
    if (!activeRow) {
      showToast('Please select a load first', 'error');
      return;
    }
    
    const loadData = JSON.parse(activeRow.dataset.load);
    document.getElementById('assignLoadId').textContent = loadData.load_id;
    
    // Display current amount in the update amount section - use final_payment if available, otherwise price_per_unit
    const currentAmount = parseFloat(loadData.final_payment || loadData.price_per_unit || 0);
    document.getElementById('currentAmountDisplay').textContent = '₹' + currentAmount.toFixed(2);
    document.getElementById('updateAmountInput').value = '';
    
    // Reset selection
    selectedVendorId = null;
    selectedVendorName = null;
    document.getElementById('confirmVendorAssignment').disabled = true;
    
    // Show modal and load vendors
    assignVendorModal.style.display = 'flex';
    loadVendorsForAssignment();
  });

  // Close Assign Vendor Modal
  document.getElementById('closeAssignVendorModal')?.addEventListener('click', closeAssignVendorModal);
  document.getElementById('cancelAssignVendorModal')?.addEventListener('click', closeAssignVendorModal);

  function closeAssignVendorModal() {
    assignVendorModal.style.display = 'none';
    document.getElementById('vendorSearchInput').value = '';
    selectedVendorId = null;
    selectedVendorName = null;
  }

  // Load vendors function
  function loadVendorsForAssignment() {
    const vendorsList = document.getElementById('vendorsList');
    const loadingDiv = document.getElementById('vendorsLoading');
    const emptyDiv = document.getElementById('vendorsEmpty');
    const errorDiv = document.getElementById('vendorsError');
    
    // Show loading state
    vendorsList.innerHTML = '';
    loadingDiv.style.display = 'block';
    emptyDiv.style.display = 'none';
    errorDiv.style.display = 'none';
    
    fetch('/loads/get-vendors/')
      .then(response => {
        // Always parse JSON, even for non-200 responses
        return response.json().then(data => ({
          ok: response.ok,
          data: data
        }));
      })
      .then(({ ok, data }) => {
        loadingDiv.style.display = 'none';
        
        if (ok && data.success && data.vendors && data.vendors.length > 0) {
          renderVendorsList(data.vendors);
        } else {
          if (data.error) {
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = `
              <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 16px;"></i>
              <p>${data.error}</p>
            `;
          } else {
            emptyDiv.style.display = 'block';
          }
        }
      })
      .catch(error => {
        console.error('Error loading vendors:', error);
        loadingDiv.style.display = 'none';
        errorDiv.style.display = 'block';
        errorDiv.innerHTML = `
          <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 16px;"></i>
          <p>${error.message}</p>
        `;
        showToast('Error loading vendors: ' + error.message, 'error');
      });
  }

  // Render vendors list
  function renderVendorsList(vendors) {
    const vendorsList = document.getElementById('vendorsList');
    vendorsList.innerHTML = '';
    
    vendors.forEach(vendor => {
      const initials = vendor.full_name.split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase();
      const div = document.createElement('div');
      div.className = 'vendor-card';
      div.dataset.vendorId = vendor.id;
      div.dataset.vendorName = vendor.full_name;
      div.innerHTML = `
        <div class="vendor-info">
          <div class="vendor-details">
            <div class="vendor-name">${vendor.full_name}</div>
            <div class="vendor-meta">
              <div class="vendor-meta-item">
                <i class="fas fa-phone"></i>
                <span>${vendor.phone_number}</span>
              </div>
              <div class="vendor-meta-item">
                <i class="fas fa-envelope"></i>
                <span>${vendor.email}</span>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Add click event to select vendor
      div.addEventListener('click', () => {
        // Remove selection from all vendor cards
        document.querySelectorAll('.vendor-card').forEach(card => {
          card.classList.remove('selected');
        });
        
        // Add selection to clicked card
        div.classList.add('selected');
        
        // Update selected vendor
        selectedVendorId = div.dataset.vendorId;
        selectedVendorName = div.dataset.vendorName;
        
        // Show vendor details and load vehicles/drivers
        showVendorDetails(vendor);
        
        // Enable confirm button
        document.getElementById('confirmVendorAssignment').disabled = false;
      });
      
      vendorsList.appendChild(div);
    });
    
    // Add search functionality
    const searchInput = document.getElementById('vendorSearchInput');
    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase().trim();
      const vendorCards = document.querySelectorAll('.vendor-card');
      
      let visibleCount = 0;
      vendorCards.forEach(card => {
        const vendorName = card.dataset.vendorName.toLowerCase();
        const vendorPhone = card.querySelector('.vendor-meta-item span').textContent.toLowerCase();
        const isVisible = vendorName.includes(searchTerm) || vendorPhone.includes(searchTerm);
        card.style.display = isVisible ? 'block' : 'none';
        if (isVisible) visibleCount++;
      });
      
      // Show/hide empty state
      const emptyDiv = document.getElementById('vendorsEmpty');
      emptyDiv.style.display = visibleCount === 0 ? 'block' : 'none';
    });
  }

  // Show vendor details and load vehicles/drivers
  function showVendorDetails(vendor) {
    const detailsPanel = document.getElementById('vendorDetailsPanel');
    const emptyPanel = document.getElementById('vendorDetailsEmpty');
    const selectedVendorInfo = document.getElementById('selectedVendorInfo');
    
    // Hide empty panel and show details panel
    emptyPanel.style.display = 'none';
    detailsPanel.style.display = 'block';
    
    // Display vendor info
    selectedVendorInfo.innerHTML = `
      <div style="font-weight: 600; color: #111827; margin-bottom: 8px;">${vendor.full_name}</div>
      <div style="font-size: 13px; color: #6b7280;">
        <div><i class="fas fa-phone" style="margin-right: 6px; width: 14px;"></i>${vendor.phone_number}</div>
        <div><i class="fas fa-envelope" style="margin-right: 6px; width: 14px;"></i>${vendor.email}</div>
      </div>
    `;
    
    // Load vehicles and drivers
    loadVendorVehicles(vendor.id);
    loadVendorDrivers(vendor.id);
  }

  // Load vehicles for selected vendor
  function loadVendorVehicles(vendorId) {
    const vehiclesList = document.getElementById('vendorVehiclesList');
    const vehicleSelect = document.getElementById('assignVendorVehicleSelect');
    
    vehicleSelect.innerHTML = '<option value="">-- Loading vehicles... --</option>';
    vehiclesList.innerHTML = '<div style="text-align: center; padding: 15px; color: #9ca3af;"><i class="fas fa-spinner fa-spin"></i> Loading vehicles...</div>';
    
    console.log('🚗 Fetching vehicles for vendor ID:', vendorId);
    fetch(`/api/vendors/${vendorId}/vehicles/`)
      .then(response => {
        console.log('✓ Vehicle response status:', response.status);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('✓ Vehicle data received:', data);
        if (data.vehicles && data.vehicles.length > 0) {
          vehiclesList.innerHTML = '';
          vehicleSelect.innerHTML = '<option value="">-- Select a vehicle --</option>';
          
          data.vehicles.forEach(vehicle => {
            // Add to dropdown
            const option = document.createElement('option');
            option.value = vehicle.id;
            option.textContent = `${vehicle.reg_no} (${vehicle.type}) - ${vehicle.load_capacity} tons`;
            vehicleSelect.appendChild(option);
            
            // Also show in list
            const vehicleEl = document.createElement('div');
            vehicleEl.style.cssText = 'padding: 8px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px;';
            vehicleEl.innerHTML = `
              <div style="font-weight: 600; color: #111827;">${vehicle.reg_no}</div>
              <div style="color: #6b7280; font-size: 11px;">Type: ${vehicle.type} | Capacity: ${vehicle.load_capacity} tons</div>
            `;
            vehiclesList.appendChild(vehicleEl);
          });
        } else {
          vehicleSelect.innerHTML = '<option value="">-- No vehicles available --</option>';
          vehiclesList.innerHTML = '<div style="text-align: center; padding: 10px; color: #9ca3af; font-size: 12px;"><i class="fas fa-car"></i> No vehicles available</div>';
        }
      })
      .catch(error => {
        console.error('✗ Error loading vehicles:', error);
        vehicleSelect.innerHTML = '<option value="">-- Error loading vehicles --</option>';
        vehiclesList.innerHTML = '<div style="text-align: center; padding: 10px; color: #dc2626; font-size: 12px;"><i class="fas fa-exclamation-circle"></i> Error: ' + error.message + '</div>';
      });
  }

  // Load drivers for selected vendor
  function loadVendorDrivers(vendorId) {
    const driversList = document.getElementById('vendorDriversList');
    const driverSelect = document.getElementById('assignVendorDriverSelect');
    
    driverSelect.innerHTML = '<option value="">-- Loading drivers... --</option>';
    driversList.innerHTML = '<div style="text-align: center; padding: 15px; color: #9ca3af;"><i class="fas fa-spinner fa-spin"></i> Loading drivers...</div>';
    
    console.log('👤 Fetching drivers for vendor ID:', vendorId);
    fetch(`/api/vendors/${vendorId}/drivers/`)
      .then(response => {
        console.log('✓ Driver response status:', response.status);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('✓ Driver data received:', data);
        if (data.drivers && data.drivers.length > 0) {
          driversList.innerHTML = '';
          driverSelect.innerHTML = '<option value="">-- Select a driver --</option>';
          
          data.drivers.forEach(driver => {
            // Add to dropdown
            const option = document.createElement('option');
            option.value = driver.id;
            option.textContent = `${driver.full_name} (${driver.phone_number})`;
            driverSelect.appendChild(option);
            
            // Also show in list
            const driverEl = document.createElement('div');
            driverEl.style.cssText = 'padding: 8px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px;';
            driverEl.innerHTML = `
              <div style="font-weight: 600; color: #111827;">${driver.full_name}</div>
              <div style="color: #6b7280; font-size: 11px;"><i class="fas fa-phone" style="margin-right: 4px;"></i>${driver.phone_number}</div>
            `;
            driversList.appendChild(driverEl);
          });
        } else {
          driverSelect.innerHTML = '<option value="">-- No drivers available --</option>';
          driversList.innerHTML = '<div style="text-align: center; padding: 10px; color: #9ca3af; font-size: 12px;"><i class="fas fa-user"></i> No drivers available</div>';
        }
      })
      .catch(error => {
        console.error('✗ Error loading drivers:', error);
        driverSelect.innerHTML = '<option value="">-- Error loading drivers --</option>';
        driversList.innerHTML = '<div style="text-align: center; padding: 10px; color: #dc2626; font-size: 12px;"><i class="fas fa-exclamation-circle"></i> Error: ' + error.message + '</div>';
      });
  }

  // Confirm vendor assignment - UPDATED TO INCLUDE VEHICLE AND DRIVER
  document.getElementById('confirmVendorAssignment')?.addEventListener('click', function() {
    if (!currentLoadId || !selectedVendorId) {
      showToast('Please select a vendor', 'error');
      return;
    }
    
    const vehicleSelect = document.getElementById('assignVendorVehicleSelect');
    const driverSelect = document.getElementById('assignVendorDriverSelect');
    const updateAmountInput = document.getElementById('updateAmountInput');
    const selectedVehicleId = vehicleSelect.value;
    const selectedDriverId = driverSelect.value;
    const newAmount = updateAmountInput.value.trim();
    
    if (!selectedVehicleId) {
      showToast('Please select a vehicle', 'error');
      vehicleSelect.focus();
      return;
    }
    
    if (!selectedDriverId) {
      showToast('Please select a driver', 'error');
      driverSelect.focus();
      return;
    }
    
    // Validate new amount if provided
    if (newAmount && (isNaN(newAmount) || parseFloat(newAmount) < 0)) {
      showToast('Please enter a valid amount', 'error');
      updateAmountInput.focus();
      return;
    }
    
    const btn = this;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Assigning...';
    btn.disabled = true;
    
    // Build request body
    const requestBody = {
      vendor_id: selectedVendorId,
      vehicle_id: parseInt(selectedVehicleId),
      driver_id: parseInt(selectedDriverId)
    };
    
    // Add new amount if provided
    if (newAmount) {
      requestBody.new_amount = parseFloat(newAmount);
    }
    
    // Send assignment request with vehicle, driver, and optional amount
    fetch(`/loads/${currentLoadId}/assign-vendor/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestBody)
    })
    .then(response => {
      // Always parse JSON first, then check status
      return response.json().then(data => ({
        ok: response.ok,
        data: data
      }));
    })
    .then(({ ok, data }) => {
      if (data.success) {  // Check the success flag in the JSON response
        showToast(`✓ Vendor, Vehicle, and Driver assigned successfully!`, 'success');
        
        // Close modal
        closeAssignVendorModal();
        
        // Close sidebar drawer
        sidebar.classList.remove('open');
        overlay.classList.remove('show');
        
        // Clear active row selection
        const activeRow = document.querySelector('.clickable-row.active');
        if (activeRow) {
          activeRow.classList.remove('active');
          
          // Update load status in table WITHOUT removing the row
          const statusBadge = document.querySelector(`.clickable-row[data-load-id="${currentLoadId}"] .status-badge`);
          if (statusBadge) {
            statusBadge.textContent = 'Assigned';
            statusBadge.className = 'status-badge status-assigned';
          }
          
          // Update load data attribute
          const loadData = JSON.parse(activeRow.dataset.load);
          loadData.status = 'assigned';
          loadData.status_display = 'Assigned';
          activeRow.dataset.load = JSON.stringify(loadData);
        }
        
        // Reset current load selection
        currentLoadId = null;
        selectedVendorId = null;
        
      } else {
        // Show error from data if available
        showToast(data.message || data.error || 'Failed to assign vendor', 'error');
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    })
    .catch(error => {
      console.error('Error assigning vendor:', error);
      showToast('Error: ' + error.message, 'error');
      btn.innerHTML = originalText;
      btn.disabled = false;
    });
  });

});
</script>
<!-- vendor assign script -->
</body>
</html>
{% endblock %}