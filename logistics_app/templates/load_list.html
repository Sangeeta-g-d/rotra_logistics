{% extends "admin_base.html" %}
{% load static %}
{% block title %}Load Management{% endblock %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>Load Management</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/load_management.css' %}">
  <style>
    .route-display {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      color: #374151;
    }
    .route-arrow {
      color: #dc2626;
      font-size: 14px;
    }
    .datetime-display {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .date-display {
      font-weight: 500;
      color: #111827;
    }
    .time-display {
      font-size: 12px;
      color: #6b7280;
    }
    
    /* Modal Styling Improvements */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    .modal-header {
      display: flex;
      justify-content: between;
      align-items: center;
      padding: 24px 32px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .modal-header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: #111827;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6b7280;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-close:hover {
      color: #374151;
    }
    
    .modal-subtitle {
      padding: 0 32px 24px;
      margin: 0;
      color: #6b7280;
      font-size: 14px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .section-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: #374151;
      margin: 24px 32px 16px;
      font-size: 16px;
    }
    
    .section-header i {
      color: #dc2626;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 0 32px 20px;
    }
    
    .form-row.single-column {
      grid-template-columns: 1fr;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group.full-width {
      grid-column: 1 / -1;
    }
    
    .form-group label {
      font-weight: 500;
      color: #374151;
      margin-bottom: 6px;
      font-size: 14px;
    }
    
    .required {
      color: #dc2626;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #dc2626;
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
    }
    
    .form-group input[readonly] {
      background-color: #f9fafb;
      color: #6b7280;
    }
    
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 24px 32px;
      border-top: 1px solid #e5e7eb;
      margin-top: 20px;
    }
    
    .cancel-btn {
      padding: 10px 20px;
      border: 1px solid #d1d5db;
      background: white;
      color: #374151;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .cancel-btn:hover {
      background: #f9fafb;
    }
    
    .save-btn {
      padding: 10px 24px;
      background: #dc2626;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .save-btn:hover:not(:disabled) {
      background: #b91c1c;
    }
    
    .save-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    /* Payment Section Styling */
    .payment-display {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      margin: 8px 0;
    }
    
    .payment-display input {
      background: transparent;
      border: none;
      font-weight: 600;
      color: inherit;
    }
    
    .first-half-payment {
      background: #f0fdf4;
      color: #16a34a;
      border-color: #bbf7d0;
    }
    
    .final-payment {
      background: #fef2f2;
      color: #dc2626;
      border-color: #fecaca;
    }
    
    /* Time Input Styling */
    .time-input-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .time-input-group input {
      width: 100px;
    }
    
    .time-input-group select {
      width: 80px;
    }
    
    /* File Upload Styling */
    .file-upload-area {
      border: 2px dashed #d1d5db;
      border-radius: 6px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .file-upload-area:hover {
      border-color: #dc2626;
    }
    
    .file-upload-area i {
      font-size: 24px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    
    .file-upload-area p {
      margin: 0;
      color: #6b7280;
      font-size: 14px;
    }
    
    .browse-link {
      color: #dc2626;
      text-decoration: underline;
      cursor: pointer;
    }
    
    .file-name {
      display: block;
      margin-top: 8px;
      font-size: 12px;
      color: #6b7280;
    }
    .assign-vendor-btn {
  width: 100%;
  padding: 12px 20px;
  background: #dc2626;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.assign-vendor-btn:hover {
  background: #b91c1c;
}
.vendor-card {
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

.vendor-card:hover {
  border-color: #dc2626;
  background: #fef2f2;
}

.vendor-card.selected {
  border-color: #dc2626;
  background: #fef2f2;
  border-width: 2px;
}

.vendor-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.vendor-avatar {
  width: 40px;
  height: 40px;
  background: #dc2626;
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 14px;
}

.vendor-details {
  flex: 1;
}

.vendor-name {
  font-weight: 600;
  color: #111827;
  margin-bottom: 4px;
}

.vendor-meta {
  display: flex;
  gap: 16px;
  font-size: 13px;
  color: #6b7280;
}

.vendor-meta-item {
  display: flex;
  align-items: center;
  gap: 4px;
}

.vendor-meta-item i {
  font-size: 12px;
}
  </style>
</head>
<body>
<div class="dashboard">

  <!-- TOP BAR -->
  <div class="top-bar">
    <h2>Load Management</h2>
    <div class="search-add-container">
      <input type="text" id="searchInput" placeholder="Search loads..." class="search-input">
      <button class="add-button" id="openAddModal">+ Add Load</button>
    </div>
  </div>

  <!-- TABLE -->
  <div class="table-card">
    <table id="loadTable">
      <thead>
        <tr>
          <th>Load ID</th>
          <th>Route</th>
          <th>Date & Time</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if loads %}
          {% for load in loads %}
<tr class="clickable-row" data-load-id="{{ load.id }}"
    data-load='{
        "load_id": "{{ load.load_id }}",
        "pickup": "{{ load.pickup_location }}",
        "drop": "{{ load.drop_location }}",
        "vehicle_type": "{{ load.vehicle_type.name }}",
        "date": "{{ load.pickup_date|date:'M d, Y' }}",
        "time": "{{ load.time|default:'' }}",
        "material": "{{ load.material|default:'-' }}",
        "weight": "{{ load.weight }}",
        "driver_name": "{{ load.driver.full_name|default:'-' }}",
        "driver_phone": "{{ load.driver.phone_number|default:'-' }}",
        "status": "{{ load.status }}",
        "status_display": "{{ load.get_status_display }}"
    }'>
    <td style="color:var(--primary); font-weight: 1000;">{{ load.load_id }}</td>
    <td>
        <div class="route-display">
            <span>{{ load.pickup_location }}</span>
            <i class="fas fa-arrow-right route-arrow"></i>
            <span>{{ load.drop_location }}</span>
        </div>
    </td>
    <td>
        <div class="datetime-display">
            <span class="date-display">{{ load.pickup_date|date:"M d, Y" }}</span>
            {% if load.time %}
                <span class="time-display">{{ load.time }}</span>
            {% endif %}
        </div>
    </td>
    <td>
        <span class="status-badge status-{{ load.status }}">{{ load.get_status_display }}</span>
    </td>
    <td class="action-col">
        <div class="action-buttons">
            <button class="action-view" title="View"><i class="fas fa-eye"></i></button>
            <button class="action-edit" title="Edit" onclick="window.location.href='{% url 'edit_load' load.id %}'">
  <i class="fas fa-edit"></i>
</button>
            <button class="action-delete" data-load-id="{{ load.id }}" title="Delete"><i class="fas fa-trash"></i></button>
        </div>
    </td>
</tr>
{% endfor %}
        {% else %}
          <tr><td colspan="5" style="text-align:center;padding:40px;color:#6b7280;">No loads found.</td></tr>
        {% endif %}
      </tbody>
    </table>

    <!-- Pagination -->
    <div class="pagination-container">
      <div class="entries-per-page">
        <span>Show</span>
        <select id="entriesPerPage">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="25">25</option>
          <option value="50">50</option>
        </select>
        <span>entries</span>
      </div>
      <div class="pagination-info">
        Showing <span id="showingStart">0</span> to <span id="showingEnd">0</span> of <span id="totalEntries">0</span> entries
      </div>
      <div class="pagination-controls">
        <button id="prevPage" disabled>Previous</button>
        <span id="currentPageInfo">Page 1</span>
        <button id="nextPage">Next</button>
      </div>
    </div>
  </div>

  <!-- RIGHT SIDEBAR - Reduced Width -->
  <div id="profileSidebar">
    <button class="close-btn" id="closeSidebar">×</button>

    <!-- Header -->
    <div class="sidebar-section">
      <div class="sidebar-header">
        <h3 id="sidebarLoadId"></h3>
        <p id="sidebarStatus"></p>
      </div>
    </div>

    <!-- Route -->
    <div class="sidebar-section">
      <div class="route-container">
        <div class="route-info">
          <div class="route-locations">
            <div id="sidebarPickup"></div>
            <i class="fas fa-arrow-right" style="color:#dc2626;font-size:14px;"></i>
            <div id="sidebarDrop"></div>
          </div>
          <i class="fas fa-truck" style="color:#dc2626;font-size:18px;"></i>
        </div>
        <div class="progress-container">
          <div class="progress-bar"></div>
          <i class="fas fa-car-side progress-icon"></i>
        </div>
      </div>
    </div>

    <!-- TRIP REQUESTS -->
    <div class="sidebar-section">
      <h4>Trip Requests By Owner</h4>
      <div id="tripRequestsContainer" class="trip-requests-container">
        <div style="text-align:center;padding:40px 20px;color:#6b7280;font-size:14px;">
          Select a load to view trip requests
        </div>
      </div>
    </div>

    <!-- CONFIRM ASSIGNMENT PANEL -->
    <div id="confirmAssignmentPanel" class="confirm-panel" style="display:none;">
      <h4>Assign Vehicle & Driver</h4>
      
      <!-- Dropdowns -->
      <div class="form-grid">
        <div class="form-group">
          <select id="vehicleTypeSelect"><option value="">Select vehicle</option></select>
          <button type="button" id="openAddVehicleModal" style="margin-top:6px;color:#dc2626;background:none;border:none;font-size:13px;font-weight:500;cursor:pointer;text-decoration:underline;">
            + New Vehicle
          </button>
        </div>
        <div class="form-group">
          <select id="driverSelect"><option value="">Select Driver</option></select>
          <button type="button" id="openAddDriverModalBtn" style="margin-top:6px;color:#dc2626;background:none;border:none;font-size:13px;font-weight:500;cursor:pointer;text-decoration:underline;">
            + New Driver
          </button>
        </div>
      </div>

      <!-- Confirm Button -->
      <button id="finalConfirmBtn" class="confirm-btn">
        Confirm Assignment
      </button>
    </div>

    <!-- Trip Info -->
    <div class="sidebar-section" style="background:#fafafa;">
      <h4>Trip Information</h4>
      <div class="trip-info-grid">
        <div>
          <div class="trip-info-label">Vehicle Type</div>
          <div id="sidebarVehicleType" class="trip-info-value"></div>
        </div>
        <div>
          <div class="trip-info-label">Date & Time</div>
          <div id="sidebarDateTime" class="trip-info-value"></div>
        </div>
        <div>
          <div class="trip-info-label">Material</div>
          <div id="sidebarMaterial" class="trip-info-value"></div>
        </div>
        <div>
          <div class="trip-info-label">Weight</div>
          <div id="sidebarWeight" class="trip-info-value"></div>
        </div>
      </div>
    </div>
<!-- Add this after the Trip Info section in your sidebar -->
<div class="sidebar-section">
  <button class="assign-vendor-btn" id="openAssignVendorModal">
    <i class="fas fa-user-plus"></i> Assign Vendor
  </button>
</div>
    <!-- Chat -->
    <div class="sidebar-section chat-container">
      <h4 class="chat-header">Chat</h4>
      <div class="chat-messages">
        <div class="chat-message">
          <div class="chat-label">Admin</div>
          <div class="chat-bubble admin">Driver confirmed departure from Mumbai warehouse.</div>
          <div class="chat-time">Dec 21, 10:30 AM</div>
        </div>
      </div>
      <div class="chat-input-container">
        <input type="text" class="chat-input" placeholder="Type a comment">
        <button class="chat-send-btn">
          <i class="fa-solid fa-paper-plane"></i>
        </button>
      </div>
    </div>

    <!-- Close Trip Button -->
    <div class="sidebar-section">
      <button class="close-trip-btn">
        Close Trip
      </button>
    </div>
  </div>
  <div id="sidebarOverlay"></div>
</div>

<!-- ====================== ADD LOAD MODAL (CORRECTED UI) ====================== -->
<div id="addLoadModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Create New Load</h3>
      <button class="modal-close" id="closeLoadModal">×</button>
    </div>
    <p class="modal-subtitle">Fill in the details below to create a new load request</p>

    <form id="addLoadForm" enctype="multipart/form-data">
      {% csrf_token %}

      <!-- Load Info Section -->
      <div class="section-header">
        <i class="fas fa-info-circle"></i> Load Information
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Customer <span class="required">*</span></label>
          <select name="customer" id="customerSelect" required>
            <option value="">Select Customer</option>
            {% for customer in customers %}
            <option value="{{ customer.id }}"
                    data-contact-person="{{ customer.contact_person_name|default:'' }}"
                    data-contact-phone="{{ customer.contact_person_phone|default:'' }}">
              {{ customer.customer_name }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label>Contact Person</label>
          <input type="text" name="contactPersonName" id="contactPersonName" readonly>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Contact Phone</label>
          <input type="tel" name="contactPersonPhone" id="contactPersonPhone" readonly>
        </div>
        <div class="form-group">
          <label>Vehicle Type <span class="required">*</span></label>
          <select name="vehicleType" required>
            <option value="">Select Vehicle Type</option>
            {% for vehicle_type in vehicle_types %}
            <option value="{{ vehicle_type.id }}">{{ vehicle_type.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- Route & Schedule Section -->
      <div class="section-header">
        <i class="fas fa-route"></i> Route & Schedule
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Pickup Location <span class="required">*</span></label>
          <input type="text" name="pickupLocation" required placeholder="e.g. Mumbai Port">
        </div>
        <div class="form-group">
          <label>Drop Location <span class="required">*</span></label>
          <input type="text" name="dropLocation" required placeholder="e.g. Delhi Warehouse">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Pickup Date <span class="required">*</span></label>
          <input type="date" name="pickupDate" id="pickupDate" required>
        </div>
        <div class="form-group">
          <label>Drop Date</label>
          <input type="date" name="dropDate" id="dropDate">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Time (Optional)</label>
          <div class="time-input-group">
            <input type="text" id="timeInput" placeholder="02:30" maxlength="5">
            <select id="ampmSelect">
              <option value="AM">AM</option>
              <option value="PM" selected>PM</option>
            </select>
            <input type="hidden" name="time" id="hiddenTimeInput">
          </div>
        </div>
        <div class="form-group">
          <label>Material</label>
          <input type="text" name="material" placeholder="e.g. Cement, Rice">
        </div>
      </div>

      <!-- Weight Section -->
      <div class="form-row">
        <div class="form-group">
          <label>Weight (Optional)</label>
          <input type="text" name="weight" placeholder="e.g. 20 Ton">
          <small style="color:#6b7280; font-size: 12px; margin-top: 4px;">Only for display purposes</small>
        </div>
        <div class="form-group"></div>
      </div>

    
      <div class="form-row">
        <div class="form-group full-width">
          <label>Total Trip Amount <span class="required">*</span></label>
          <input type="number" 
                 name="total_amount" 
                 id="totalAmountInput"
                 step="1" 
                 min="1000" 
                 required 
                 placeholder="Enter full freight amount"
                 style="font-size:16px; font-weight:600; padding: 12px;">
          <small style="color:#6b7280; font-size: 12px; margin-top: 4px;">Enter the complete freight amount for the trip</small>
        </div>
      </div>

      <!-- Payment Split Section -->
      <div style="background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 16px; margin: 16px 0;">
        <div style="font-weight: 600; color: #1e40af; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
          <i class="fas fa-coins"></i> Payment Split (90% & 10%)
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>First Half Payment (90%)</label>
            <input type="number" id="firstHalfPaymentInput" name="first_half_payment" step="0.01" min="0" value="0.00" placeholder="Enter or auto-calculated" style="font-size: 14px; font-weight: 600; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
            <small style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">Edit this amount - second half will auto-adjust to match total</small>
          </div>
          <div class="form-group">
            <label>Second Half Payment (10%)</label>
            <input type="number" id="secondHalfPaymentInput" name="second_half_payment" step="0.01" min="0" value="0.00" placeholder="Enter or auto-calculated" style="font-size: 14px; font-weight: 600; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
            <small style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">Edit this amount - first half will auto-adjust to match total</small>
          </div>
        </div>
      </div>

      <!-- Final Payment -->
      <div class="form-row">
        <div class="form-group">
          <label>Final Payment</label>
          <div class="payment-display final-payment">
            <input type="text" id="finalPaymentDisplay" readonly value="₹ 0">
          </div>
          <input type="hidden" name="final_payment" id="hiddenFinalPayment">
        </div>
      </div>

      <!-- Notes Section -->
      <div class="section-header">
        <i class="fas fa-sticky-note"></i> Additional Notes
      </div>
      <div class="form-row single-column">
        <div class="form-group full-width">
          <label>Notes</label>
          <textarea name="notes" rows="3" placeholder="Any special instructions or additional information..."></textarea>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="modal-actions">
        <button type="button" class="cancel-btn" id="cancelLoadModal">Cancel</button>
        <button type="submit" class="save-btn">Create Load</button>
      </div>
    </form>
  </div>
</div>

<!-- ====================== ADD DRIVER MODAL ====================== -->
<div id="addDriverModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Add New Driver</h3>
      <button class="modal-close" id="closeDriverModal">×</button>
    </div>
    <p class="modal-subtitle">Add a new driver to this vendor's fleet</p>

    <form id="quickAddDriverForm" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" name="vendor_id" id="quickDriverVendorId">

      <!-- Personal Info Section -->
      <div class="section-header">
        <i class="fas fa-user"></i> Personal Information
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Full Name <span class="required">*</span></label>
          <input type="text" name="full_name" required placeholder="Enter driver's full name">
        </div>
        <div class="form-group">
          <label>Phone Number <span class="required">*</span></label>
          <input type="tel" name="phone_number" required placeholder="10-digit mobile number">
        </div>
      </div>

      <!-- Documents Section -->
      <div class="section-header">
        <i class="fas fa-file-alt"></i> Documents
      </div>

      <div class="form-row single-column">
        <div class="form-group full-width">
          <label>PAN Card Document</label>
          <div class="file-upload-area" id="panUploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Drag and drop files here or <span class="browse-link" data-input="panDocument">Browse Files</span></p>
            <input type="file" id="panDocument" name="pan_document" accept=".pdf,.jpg,.jpeg,.png" style="display:none;">
            <span id="panFileName" class="file-name"></span>
          </div>
        </div>
      </div>

      <div class="form-row single-column">
        <div class="form-group full-width">
          <label>Aadhar Card Document</label>
          <div class="file-upload-area" id="aadharUploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Drag and drop files here or <span class="browse-link" data-input="aadharDocument">Browse Files</span></p>
            <input type="file" id="aadharDocument" name="aadhar_document" accept=".pdf,.jpg,.jpeg,.png" style="display:none;">
            <span id="aadharFileName" class="file-name"></span>
          </div>
        </div>
      </div>

      <div class="form-row single-column">
        <div class="form-group full-width">
          <label>Driving License Document</label>
          <div class="file-upload-area" id="licenseUploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Drag and drop files here or <span class="browse-link" data-input="licenseDocument">Browse Files</span></p>
            <input type="file" id="licenseDocument" name="license_document" accept=".pdf,.jpg,.jpeg,.png" style="display:none;">
            <span id="licenseFileName" class="file-name"></span>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="cancel-btn" id="cancelDriverModal">Cancel</button>
        <button type="submit" class="save-btn">Save Driver</button>
      </div>
    </form>
  </div>
</div>

<!-- ====================== ADD VEHICLE MODAL ====================== -->
<div id="addVehicleModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Add New Vehicle</h3>
      <button class="modal-close" id="closeVehicleModal">×</button>
    </div>
    <p class="modal-subtitle">Add a new vehicle to this vendor's fleet</p>

    <form id="quickAddVehicleForm" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" name="vendor_id" id="quickVehicleVendorId">

      <!-- Vehicle Details Section -->
      <div class="section-header">
        <i class="fas fa-truck"></i> Vehicle Details
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Registration Number <span class="required">*</span></label>
          <input type="text" name="reg_no" required placeholder="e.g. TN45AB1234" style="text-transform: uppercase;">
        </div>
        <div class="form-group">
          <label>Vehicle Type <span class="required">*</span></label>
          <select name="vehicle_type" required>
            <option value="">Select Vehicle Type</option>
            {% for vehicle_type in vehicle_types %}
            <option value="{{ vehicle_type.id }}">{{ vehicle_type.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- Documents Section -->
      <div class="section-header">
        <i class="fas fa-file-alt"></i> Vehicle Documents
      </div>

      <div class="form-row single-column">
        <div class="form-group full-width">
          <label>Insurance Document</label>
          <div class="file-upload-area" id="insuranceUploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Drag and drop files here or <span class="browse-link" data-input="insuranceDocument">Browse Files</span></p>
            <input type="file" id="insuranceDocument" name="insurance_document" accept=".pdf,.jpg,.jpeg,.png" style="display:none;">
            <span id="insuranceFileName" class="file-name"></span>
          </div>
        </div>
      </div>

      <div class="form-row single-column">
        <div class="form-group full-width">
          <label>RC (Registration Certificate) Document</label>
          <div class="file-upload-area" id="rcUploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Drag and drop files here or <span class="browse-link" data-input="rcDocument">Browse Files</span></p>
            <input type="file" id="rcDocument" name="rc_document" accept=".pdf,.jpg,.jpeg,.png" style="display:none;">
            <span id="rcFileName" class="file-name"></span>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="cancel-btn" id="cancelVehicleModal">Cancel</button>
        <button type="submit" class="save-btn">Save Vehicle</button>
      </div>
    </form>
  </div>
</div>


<!-- vendor modal -->
<!-- ====================== ASSIGN VENDOR MODAL ====================== -->
<div id="assignVendorModal" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
      <h3>Assign Vendor to Load</h3>
      <button class="modal-close" id="closeAssignVendorModal">×</button>
    </div>
    <p class="modal-subtitle">Select a vendor to assign to Load ID: <span id="assignLoadId"></span></p>

    <div class="modal-body">
      <!-- Search Bar -->
      <div class="form-row" style="margin: 0 32px 20px;">
        <div class="form-group full-width">
          <input type="text" id="vendorSearchInput" placeholder="Search vendors by name or phone..." 
                 style="padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; width: 100%;">
        </div>
      </div>

      <!-- Vendors List -->
      <div class="vendors-list-container" style="max-height: 400px; overflow-y: auto; margin: 0 32px;">
        <div id="vendorsList">
          <!-- Vendors will be loaded here -->
        </div>
      </div>

      <!-- Loading State -->
      <div id="vendorsLoading" style="text-align: center; padding: 40px; color: #6b7280; display: none;">
        <i class="fas fa-spinner fa-spin"></i> Loading vendors...
      </div>

      <!-- Empty State -->
      <div id="vendorsEmpty" style="text-align: center; padding: 40px; color: #9ca3af; display: none;">
        <i class="fas fa-users-slash" style="font-size: 48px; margin-bottom: 16px;"></i>
        <p>No vendors available to assign</p>
      </div>

      <!-- Error State -->
      <div id="vendorsError" style="text-align: center; padding: 40px; color: #dc2626; display: none;">
        <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 16px;"></i>
        <p>Error loading vendors</p>
      </div>
    </div>

    <div class="modal-actions">
      <button type="button" class="cancel-btn" id="cancelAssignVendorModal">Cancel</button>
      <button type="button" class="save-btn" id="confirmVendorAssignment" disabled>Assign Vendor</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script>
// Global variables
let currentLoadId = null;
let selectedRequestId = null;
let currentVendorId = null;
let csrftoken = null;
let selectedVendorId = null;
let selectedVendorName = null;

document.addEventListener('DOMContentLoaded', function () {
  csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const sidebar = document.getElementById('profileSidebar');
  const overlay = document.getElementById('sidebarOverlay');
  const tripRequestsContainer = document.getElementById('tripRequestsContainer');
  const confirmPanel = document.getElementById('confirmAssignmentPanel');
  const vehicleTypeSelect = document.getElementById('vehicleTypeSelect');
  const driverSelect = document.getElementById('driverSelect');

  // Modal elements
  const addLoadModal = document.getElementById('addLoadModal');
  const addDriverModal = document.getElementById('addDriverModal');
  const addVehicleModal = document.getElementById('addVehicleModal');
  const assignVendorModal = document.getElementById('assignVendorModal');

  const openAddModalBtn = document.getElementById('openAddModal');
  const closeLoadModal = document.getElementById('closeLoadModal');
  const cancelLoadModal = document.getElementById('cancelLoadModal');
  const openAddDriverModalBtn = document.getElementById('openAddDriverModalBtn');
  const openAddVehicleModalBtn = document.getElementById('openAddVehicleModal');

  function showToast(text, type = 'info') {
    const colors = { success: '#16a34a', error: '#dc2626', info: '#2563eb' };
    Toastify({ text, duration: 3000, gravity: "top", position: "right", backgroundColor: colors[type] }).showToast();
  }

  // ====================== 90-10 PAYMENT SPLIT CALCULATION ======================
  function calculatePaymentSplit() {
    const totalInput = document.getElementById('totalAmountInput');
    const finalDisplay = document.getElementById('finalPaymentDisplay');
    const hiddenFinalPayment = document.getElementById('hiddenFinalPayment');
    const firstHalfInput = document.getElementById('firstHalfPaymentInput');
    const secondHalfInput = document.getElementById('secondHalfPaymentInput');

    if (!totalInput || !finalDisplay) return;

    const total = parseFloat(totalInput.value) || 0;

    if (total > 0) {
      const finalPayment = total;
      const firstHalfPayment = total * 0.90;  // 90%
      const secondHalfPayment = total * 0.10; // 10%

      finalDisplay.value = '₹ ' + finalPayment.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      hiddenFinalPayment.value = finalPayment;
      
      // Update input fields (only if they haven't been manually modified)
      if (!firstHalfInput.dataset.modified) {
        firstHalfInput.value = firstHalfPayment.toFixed(2);
      }
      if (!secondHalfInput.dataset.modified) {
        secondHalfInput.value = secondHalfPayment.toFixed(2);
      }
    } else {
      finalDisplay.value = '₹ 0.00';
      hiddenFinalPayment.value = '';
      
      if (!firstHalfInput.dataset.modified) {
        firstHalfInput.value = '0.00';
      }
      if (!secondHalfInput.dataset.modified) {
        secondHalfInput.value = '0.00';
      }
    }
  }

  // Initialize payment calculation when modal opens
  openAddModalBtn?.addEventListener('click', function () {
    addLoadModal.style.display = 'flex';
    setTimeout(() => {
      const totalInput = document.getElementById('totalAmountInput');
      const firstHalfInput = document.getElementById('firstHalfPaymentInput');
      const secondHalfInput = document.getElementById('secondHalfPaymentInput');
      
      if (totalInput) {
        totalInput.focus();
        totalInput.addEventListener('input', calculatePaymentSplit);
        calculatePaymentSplit(); // Initial calculation
      }
      
      // Track manual modifications to payment fields with auto-adjustment
      if (firstHalfInput) {
        firstHalfInput.addEventListener('input', function () {
          this.dataset.modified = 'true';
          // Auto-adjust second half payment
          const finalPayment = parseFloat(document.getElementById('hiddenFinalPayment').value) || 0;
          const firstHalf = parseFloat(this.value) || 0;
          const secondHalf = finalPayment - firstHalf;
          
          if (secondHalfInput) {
            secondHalfInput.dataset.modified = 'true';
            secondHalfInput.value = Math.max(0, secondHalf).toFixed(2);
          }
        });
      }
      
      if (secondHalfInput) {
        secondHalfInput.addEventListener('input', function () {
          this.dataset.modified = 'true';
          // Auto-adjust first half payment
          const finalPayment = parseFloat(document.getElementById('hiddenFinalPayment').value) || 0;
          const secondHalf = parseFloat(this.value) || 0;
          const firstHalf = finalPayment - secondHalf;
          
          if (firstHalfInput) {
            firstHalfInput.dataset.modified = 'true';
            firstHalfInput.value = Math.max(0, firstHalf).toFixed(2);
          }
        });
      }
    }, 100);
  });

  // ====================== CUSTOMER AUTO-FILL ======================
  document.getElementById('customerSelect')?.addEventListener('change', function () {
    const selected = this.options[this.selectedIndex];
    document.getElementById('contactPersonName').value = selected.dataset.contactPerson || '';
    document.getElementById('contactPersonPhone').value = selected.dataset.contactPhone || '';
  });

  // ====================== TIME INPUT FORMAT ======================
  const timeInput = document.getElementById('timeInput');
  const ampmSelect = document.getElementById('ampmSelect');
  const hiddenTimeInput = document.getElementById('hiddenTimeInput');

  if (timeInput) {
    timeInput.addEventListener('input', function (e) {
      let v = e.target.value.replace(/\D/g, '');
      if (v.length > 2) v = v.slice(0, 2) + ':' + v.slice(2, 4);
      e.target.value = v.slice(0, 5);
      if (hiddenTimeInput) hiddenTimeInput.value = v + ' ' + (ampmSelect?.value || 'PM');
    });
  }
  ampmSelect?.addEventListener('change', () => {
    if (timeInput && hiddenTimeInput) {
      hiddenTimeInput.value = timeInput.value + ' ' + ampmSelect.value;
    }
  });

  // ====================== DATE VALIDATION ======================
  const pickupDate = document.getElementById('pickupDate');
  const dropDate = document.getElementById('dropDate');
  if (pickupDate) {
    pickupDate.min = new Date().toISOString().split('T')[0];
    pickupDate.addEventListener('change', () => {
      if (dropDate) {
        dropDate.min = pickupDate.value;
        if (dropDate.value && dropDate.value < pickupDate.value) dropDate.value = pickupDate.value;
      }
    });
  }

  // ====================== SIDEBAR & TRIP REQUESTS ======================
  function openSidebar(row) {
    const data = JSON.parse(row.dataset.load);
    currentLoadId = row.dataset.loadId;

    document.getElementById('sidebarLoadId').textContent = data.load_id;
    document.getElementById('sidebarStatus').textContent = data.status_display;
    document.getElementById('sidebarPickup').textContent = data.pickup;
    document.getElementById('sidebarDrop').textContent = data.drop;
    document.getElementById('sidebarVehicleType').textContent = data.vehicle_type;
    document.getElementById('sidebarDateTime').textContent = `${data.date} ${data.time || ''}`;
    document.getElementById('sidebarMaterial').textContent = data.material || '-';
    document.getElementById('sidebarWeight').textContent = data.weight || '-';

    confirmPanel.style.display = 'none';
    loadTripRequests(currentLoadId);

    sidebar.classList.add('open');
    overlay.classList.add('show');
    document.querySelectorAll('.clickable-row').forEach(r => r.classList.remove('active'));
    row.classList.add('active');
  }

  // Load trip requests for a specific load
  function loadTripRequests(loadId) {
    tripRequestsContainer.innerHTML = `<div style="text-align:center;padding:40px;color:#6b7280;"><i class="fas fa-spinner fa-spin"></i> Loading...</div>`;

    fetch(`/loads/${loadId}/requests/`)
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(requests => {
        tripRequestsContainer.innerHTML = '';
        const pending = (requests || []).filter(r => r.status === 'pending');

        if (pending.length === 0) {
          tripRequestsContainer.innerHTML = `<div style="text-align:center;padding:40px;color:#9ca3af;">No pending requests</div>`;
          return;
        }

        pending.forEach(req => {
          const initials = (req.vendor_name || 'NA').split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase();
          const div = document.createElement('div');
          div.className = 'trip-request-item';
          div.innerHTML = `
            <div class="trip-request-info">
              
              <div class="vendor-details">
                <div>${req.vendor_name}</div>
                <div>${req.vendor_phone}</div>
              </div>
            </div>
            <div class="trip-request-actions">
              <button class="accept-btn" data-id="${req.id}" data-vendor-id="${req.vendor_id}">
                <i class="fas fa-check-circle" style="color:#16a34a"></i>
              </button>
              <button class="reject-btn" data-id="${req.id}">
                <i class="fas fa-times-circle" style="color:#dc2626"></i>
              </button>
            </div>`;
          tripRequestsContainer.appendChild(div);
        });

        // Accept Request
        tripRequestsContainer.querySelectorAll('.accept-btn').forEach(btn => {
          btn.onclick = () => {
            selectedRequestId = btn.dataset.id;
            currentVendorId = btn.dataset.vendorId;
            populateDropdowns(currentVendorId);
            confirmPanel.style.display = 'block';
          };
        });

        // Reject Request
        tripRequestsContainer.querySelectorAll('.reject-btn').forEach(btn => {
          btn.onclick = () => {
            if (confirm('Reject this request?')) {
              fetch(`/loads/${loadId}/requests/${btn.dataset.id}/reject/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken }
              })
              .then(r => r.json())
              .then(data => {
                if (data.success) {
                  showToast('Request rejected. Notification sent to vendor.', 'success');
                  loadTripRequests(loadId);
                } else {
                  showToast(data.message || 'Failed to reject request', 'error');
                }
              })
              .catch(error => {
                console.error('Error rejecting request:', error);
                showToast('Error rejecting request', 'error');
              });
            }
          };
        });
      })
      .catch(() => {
        tripRequestsContainer.innerHTML = `<div style="text-align:center;padding:40px;color:#dc2626;">Error loading requests</div>`;
      });
  }

  // Populate Vehicle & Driver dropdowns
  function populateDropdowns(vendorId) {
    vehicleTypeSelect.innerHTML = '<option>Loading vehicles...</option>';
    driverSelect.innerHTML = '<option>Loading drivers...</option>';

    Promise.all([
      fetch(`/api/vendors/${vendorId}/vehicles/`).then(r => r.json()),
      fetch(`/api/vendors/${vendorId}/drivers/`).then(r => r.json())
    ]).then(([vehicles, drivers]) => {
      vehicleTypeSelect.innerHTML = '<option value="">Select Vehicle</option>';
      driverSelect.innerHTML = '<option value="">Select Driver</option>';

      vehicles.forEach(v => {
        const opt = new Option(v.reg_no, v.id);
        vehicleTypeSelect.add(opt);
      });
      if (vehicles.length === 0) vehicleTypeSelect.add(new Option('No vehicles', ''));

      drivers.forEach(d => {
        const opt = new Option(`${d.full_name} - ${d.phone_number}`, d.id);
        driverSelect.add(opt);
      });
      if (drivers.length === 0) driverSelect.add(new Option('No drivers', ''));
    })
    .catch(error => {
      console.error('Error loading vehicles/drivers:', error);
      showToast('Error loading vehicles/drivers', 'error');
    });
  }

  // Final Assignment with Firebase Notification
  // Final Assignment
  document.getElementById('finalConfirmBtn')?.addEventListener('click', function () {
      const vehicleId = vehicleTypeSelect.value;
      const driverId = driverSelect.value;

      if (!vehicleId || !driverId) {
          showToast('Please select both vehicle and driver', 'error');
          return;
      }

      this.innerHTML = 'Assigning...';
      this.disabled = true;

      // Use the correct URL endpoint
      fetch(`/loads/${currentLoadId}/requests/${selectedRequestId}/accepted/`, {
          method: 'POST',
          headers: { 
              'X-CSRFToken': csrftoken, 
              'Content-Type': 'application/json',
              'Authorization': 'Bearer YOUR_ADMIN_TOKEN'  // Add if using JWT
          },
          body: JSON.stringify({ 
              vehicle_id: vehicleId, 
              driver_id: driverId 
          })
      })
      .then(r => {
          if (!r.ok) {
              throw new Error(`HTTP error! status: ${r.status}`);
          }
          return r.json();
      })
      .then(data => {
          if (data.success) {
              showToast('Trip assigned successfully! Notification sent to vendor.', 'success');
              
              // Remove the row from table
              const assignedRow = document.querySelector(`.clickable-row[data-load-id="${currentLoadId}"]`);
              if (assignedRow) {
                  assignedRow.remove();
                  updatePaginationAfterRemoval();
              }
              
              // Close sidebar
              sidebar.classList.remove('open');
              overlay.classList.remove('show');
              
              // Reset modal
              confirmPanel.style.display = 'none';
              vehicleTypeSelect.innerHTML = '<option value="">Select vehicle</option>';
              driverSelect.innerHTML = '<option value="">Select Driver</option>';
              
          } else {
              showToast(data.error || 'Failed to assign trip', 'error');
          }
      })
      .catch(error => {
          console.error('Error assigning trip:', error);
          showToast('Error assigning trip: ' + error.message, 'error');
      })
      .finally(() => {
          this.innerHTML = 'Confirm Assignment';
          this.disabled = false;
      });
  });

  // Update pagination after removing a row
  function updatePaginationAfterRemoval() {
    const allRows = Array.from(document.querySelectorAll('tr.clickable-row'));
    filteredRows = [...allRows];
    if (currentPage > Math.ceil(filteredRows.length / perPage)) {
      currentPage = Math.max(1, Math.ceil(filteredRows.length / perPage));
    }
    renderPage();
  }

  // Close sidebar
  document.getElementById('closeSidebar')?.addEventListener('click', () => {
    sidebar.classList.remove('open');
    overlay.classList.remove('show');
  });
  
  overlay.addEventListener('click', () => {
    sidebar.classList.remove('open');
    overlay.classList.remove('show');
  });

  // Row click → open sidebar
  document.querySelectorAll('.clickable-row').forEach(row => {
    row.addEventListener('click', e => {
      if (e.target.closest('.action-col')) return;
      openSidebar(row);
    });
  });

  // Modal Close Buttons
  closeLoadModal?.addEventListener('click', () => {
    addLoadModal.style.display = 'none';
    document.getElementById('addLoadForm').reset();
  });
  
  cancelLoadModal?.addEventListener('click', () => {
    addLoadModal.style.display = 'none';
    document.getElementById('addLoadForm').reset();
  });
  
  document.getElementById('closeDriverModal')?.addEventListener('click', () => {
    addDriverModal.style.display = 'none';
    document.getElementById('quickAddDriverForm').reset();
  });
  
  document.getElementById('closeVehicleModal')?.addEventListener('click', () => {
    addVehicleModal.style.display = 'none';
    document.getElementById('quickAddVehicleForm').reset();
  });

  // Quick Add Driver/Vehicle Modals
  openAddDriverModalBtn?.addEventListener('click', () => {
    if (!currentVendorId) {
      showToast('No vendor selected. Please select a trip request first.', 'error');
      return;
    }
    document.getElementById('quickDriverVendorId').value = currentVendorId;
    addDriverModal.style.display = 'flex';
  });
  
  openAddVehicleModalBtn?.addEventListener('click', () => {
    if (!currentVendorId) {
      showToast('No vendor selected. Please select a trip request first.', 'error');
      return;
    }
    document.getElementById('quickVehicleVendorId').value = currentVendorId;
    addVehicleModal.style.display = 'flex';
  });

  // Add Load Form Submit
  document.getElementById('addLoadForm')?.addEventListener('submit', function (e) {
    e.preventDefault();
    const formData = new FormData(this);
    console.log('Form data:', Object.fromEntries(formData));
    const btn = this.querySelector('.save-btn');
    const oldText = btn.innerHTML;
    btn.innerHTML = 'Saving...'; 
    btn.disabled = true;

    fetch('/loads/add/', { 
      method: 'POST', 
      headers: { 'X-CSRFToken': csrftoken }, 
      body: formData 
    })
      .then(r => r.json())
      .then(d => {
        if (d.success) {
          showToast('Load created successfully!', 'success');
          addLoadModal.style.display = 'none';
          this.reset();
          setTimeout(() => location.reload(), 1500);
        } else {
          showToast(d.error || 'Failed to create load', 'error');
        }
      })
      .catch(error => {
        console.error('Error creating load:', error);
        showToast('Error creating load', 'error');
      })
      .finally(() => {
        btn.innerHTML = oldText; 
        btn.disabled = false;
      });
  });

  // File Upload Handlers
  document.querySelectorAll('.browse-link').forEach(link => {
    link.addEventListener('click', function () {
      const inputId = this.dataset.input;
      document.getElementById(inputId)?.click();
    });
  });

  document.querySelectorAll('input[type="file"]').forEach(input => {
    input.addEventListener('change', function () {
      const fileName = this.files[0]?.name || '';
      const display = this.parentElement.querySelector('.file-name');
      if (display) {
        display.textContent = fileName || 'No file chosen';
        display.style.color = fileName ? '#16a34a' : '#6b7280';
      }
    });
  });

  // Quick Add Driver Form
  document.getElementById('quickAddDriverForm')?.addEventListener('submit', function (e) {
    e.preventDefault();
    const formData = new FormData(this);
    const btn = this.querySelector('.save-btn');
    const oldText = btn.innerHTML;
    btn.innerHTML = 'Saving...'; 
    btn.disabled = true;

    fetch('/loads/add-driver/', {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken },
      body: formData
    })
    .then(r => r.json())
    .then(d => {
      if (d.success) {
        showToast('Driver added successfully!', 'success');
        addDriverModal.style.display = 'none';
        this.reset();
        document.querySelectorAll('.file-name').forEach(el => el.textContent = '');
        
        // Update driver dropdown
        fetch(`/api/vendors/${currentVendorId}/drivers/`)
          .then(r => r.json())
          .then(drivers => {
            driverSelect.innerHTML = '<option value="">Select Driver</option>';
            drivers.forEach(driver => {
              const opt = new Option(`${driver.full_name} - ${driver.phone_number}`, driver.id);
              driverSelect.add(opt);
            });
            if (d.driver_id) {
              driverSelect.value = d.driver_id;
              showToast('Driver added and selected', 'success');
            }
          });
      } else {
        showToast(d.error || 'Failed to add driver', 'error');
      }
    })
    .catch(error => {
      console.error('Error adding driver:', error);
      showToast('Error adding driver', 'error');
    })
    .finally(() => {
      btn.innerHTML = oldText; 
      btn.disabled = false;
    });
  });

  // Quick Add Vehicle Form
  document.getElementById('quickAddVehicleForm')?.addEventListener('submit', function (e) {
    e.preventDefault();
    const formData = new FormData(this);
    const btn = this.querySelector('.save-btn');
    const oldText = btn.innerHTML;
    btn.innerHTML = 'Saving...'; 
    btn.disabled = true;

    fetch('/loads/add-vehicle/', {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken },
      body: formData
    })
    .then(r => r.json())
    .then(d => {
      if (d.success) {
        showToast('Vehicle added successfully!', 'success');
        addVehicleModal.style.display = 'none';
        this.reset();
        document.querySelectorAll('.file-name').forEach(el => el.textContent = '');
        
        // Update vehicle dropdown
        fetch(`/api/vendors/${currentVendorId}/vehicles/`)
          .then(r => r.json())
          .then(vehicles => {
            vehicleTypeSelect.innerHTML = '<option value="">Select Vehicle</option>';
            vehicles.forEach(vehicle => {
              const opt = new Option(vehicle.reg_no, vehicle.id);
              vehicleTypeSelect.add(opt);
            });
            if (d.vehicle_id) {
              vehicleTypeSelect.value = d.vehicle_id;
              showToast('Vehicle added and selected', 'success');
            }
          });
      } else {
        showToast(d.error || 'Failed to add vehicle', 'error');
      }
    })
    .catch(error => {
      console.error('Error adding vehicle:', error);
      showToast('Error adding vehicle', 'error');
    })
    .finally(() => {
      btn.innerHTML = oldText; 
      btn.disabled = false;
    });
  });

  // Delete Load Button
  document.querySelectorAll('.action-delete').forEach(button => {
    button.addEventListener('click', function(e) {
      e.stopPropagation();
      const loadId = this.getAttribute('data-load-id');
      
      if (confirm('Are you sure you want to delete this load?')) {
        fetch(`/loads/${loadId}/delete/`, {
          method: 'DELETE',
          headers: { 'X-CSRFToken': csrftoken }
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            showToast('Load deleted successfully', 'success');
            // Remove the row from table
            const row = this.closest('tr.clickable-row');
            if (row) {
              row.remove();
              updatePaginationAfterRemoval();
            }
          } else {
            showToast(data.message || 'Failed to delete load', 'error');
          }
        })
        .catch(error => {
          console.error('Error deleting load:', error);
          showToast('Error deleting load', 'error');
        });
      }
    });
  });

  // Pagination & Search
  const allRows = Array.from(document.querySelectorAll('tr.clickable-row'));
  let filteredRows = [...allRows];
  let currentPage = 1;
  let perPage = 10;

  function renderPage() {
    const start = (currentPage - 1) * perPage;
    const end = start + perPage;
    
    // Hide all rows first
    allRows.forEach(r => r.style.display = 'none');
    
    // Show only filtered rows for current page
    filteredRows.slice(start, end).forEach(r => r.style.display = '');
    
    // Update pagination info
    document.getElementById('showingStart').textContent = filteredRows.length ? start + 1 : 0;
    document.getElementById('showingEnd').textContent = Math.min(end, filteredRows.length);
    document.getElementById('totalEntries').textContent = filteredRows.length;
    document.getElementById('prevPage').disabled = currentPage === 1;
    document.getElementById('nextPage').disabled = end >= filteredRows.length;
    document.getElementById('currentPageInfo').textContent = `Page ${currentPage}`;
  }

  // Search functionality
  document.getElementById('searchInput')?.addEventListener('input', function () {
    const term = this.value.toLowerCase().trim();
    filteredRows = allRows.filter(row => {
      const rowText = row.textContent.toLowerCase();
      return rowText.includes(term);
    });
    currentPage = 1;
    renderPage();
  });

  // Entries per page
  document.getElementById('entriesPerPage')?.addEventListener('change', function () {
    perPage = parseInt(this.value);
    currentPage = 1;
    renderPage();
  });

  // Previous page
  document.getElementById('prevPage')?.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      renderPage();
    }
  });

  // Next page
  document.getElementById('nextPage')?.addEventListener('click', () => {
    if (currentPage * perPage < filteredRows.length) {
      currentPage++;
      renderPage();
    }
  });

  // Initialize pagination
  renderPage();

  // Chat functionality
  const chatInput = document.querySelector('.chat-input');
  const chatSendBtn = document.querySelector('.chat-send-btn');
  
  if (chatSendBtn && chatInput) {
    chatSendBtn.addEventListener('click', function() {
      const message = chatInput.value.trim();
      if (message && currentLoadId) {
        // Send chat message
        fetch(`/loads/${currentLoadId}/chat/`, {
          method: 'POST',
          headers: { 
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ message: message })
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            // Add message to chat UI
            const chatMessages = document.querySelector('.chat-messages');
            const newMessage = document.createElement('div');
            newMessage.className = 'chat-message';
            newMessage.innerHTML = `
              <div class="chat-label">Admin</div>
              <div class="chat-bubble admin">${message}</div>
              <div class="chat-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
            `;
            chatMessages.appendChild(newMessage);
            chatInput.value = '';
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }
        })
        .catch(error => console.error('Chat error:', error));
      }
    });
    
    // Send message on Enter key
    chatInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        chatSendBtn.click();
      }
    });
  }

  // Close Trip Button
  const closeTripBtn = document.querySelector('.close-trip-btn');
  if (closeTripBtn) {
    closeTripBtn.addEventListener('click', function() {
      if (!currentLoadId) {
        showToast('Please select a load first', 'error');
        return;
      }
      
      if (confirm('Are you sure you want to close this trip?')) {
        fetch(`/loads/${currentLoadId}/close/`, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrftoken }
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            showToast('Trip closed successfully', 'success');
            // Update UI
            document.getElementById('sidebarStatus').textContent = 'Closed';
            document.querySelector(`.clickable-row[data-load-id="${currentLoadId}"] .status-badge`).textContent = 'Closed';
            document.querySelector(`.clickable-row[data-load-id="${currentLoadId}"] .status-badge`).className = 'status-badge status-delivered';
            
            // Close sidebar
            setTimeout(() => {
              sidebar.classList.remove('open');
              overlay.classList.remove('show');
            }, 1500);
          } else {
            showToast(data.message || 'Failed to close trip', 'error');
          }
        })
        .catch(error => {
          console.error('Error closing trip:', error);
          showToast('Error closing trip', 'error');
        });
      }
    });
  }

  // ====================== VENDOR ASSIGNMENT ======================
  
  // Add event listener for Assign Vendor button
  document.getElementById('openAssignVendorModal')?.addEventListener('click', function() {
    if (!currentLoadId) {
      showToast('Please select a load first', 'error');
      return;
    }
    
    // Get load data from active row
    const activeRow = document.querySelector('.clickable-row.active');
    if (!activeRow) {
      showToast('Please select a load first', 'error');
      return;
    }
    
    const loadData = JSON.parse(activeRow.dataset.load);
    document.getElementById('assignLoadId').textContent = loadData.load_id;
    
    // Reset selection
    selectedVendorId = null;
    selectedVendorName = null;
    document.getElementById('confirmVendorAssignment').disabled = true;
    
    // Show modal and load vendors
    assignVendorModal.style.display = 'flex';
    loadVendorsForAssignment();
  });

  // Close Assign Vendor Modal
  document.getElementById('closeAssignVendorModal')?.addEventListener('click', closeAssignVendorModal);
  document.getElementById('cancelAssignVendorModal')?.addEventListener('click', closeAssignVendorModal);

  function closeAssignVendorModal() {
    assignVendorModal.style.display = 'none';
    document.getElementById('vendorSearchInput').value = '';
    selectedVendorId = null;
    selectedVendorName = null;
  }

  // Load vendors function
  function loadVendorsForAssignment() {
    const vendorsList = document.getElementById('vendorsList');
    const loadingDiv = document.getElementById('vendorsLoading');
    const emptyDiv = document.getElementById('vendorsEmpty');
    const errorDiv = document.getElementById('vendorsError');
    
    // Show loading state
    vendorsList.innerHTML = '';
    loadingDiv.style.display = 'block';
    emptyDiv.style.display = 'none';
    errorDiv.style.display = 'none';
    
    fetch('/loads/get-vendors/')
      .then(response => {
        // Always parse JSON, even for non-200 responses
        return response.json().then(data => ({
          ok: response.ok,
          data: data
        }));
      })
      .then(({ ok, data }) => {
        loadingDiv.style.display = 'none';
        
        if (ok && data.success && data.vendors && data.vendors.length > 0) {
          renderVendorsList(data.vendors);
        } else {
          if (data.error) {
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = `
              <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 16px;"></i>
              <p>${data.error}</p>
            `;
          } else {
            emptyDiv.style.display = 'block';
          }
        }
      })
      .catch(error => {
        console.error('Error loading vendors:', error);
        loadingDiv.style.display = 'none';
        errorDiv.style.display = 'block';
        errorDiv.innerHTML = `
          <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 16px;"></i>
          <p>${error.message}</p>
        `;
        showToast('Error loading vendors: ' + error.message, 'error');
      });
  }

  // Render vendors list
  function renderVendorsList(vendors) {
    const vendorsList = document.getElementById('vendorsList');
    vendorsList.innerHTML = '';
    
    vendors.forEach(vendor => {
      const initials = vendor.full_name.split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase();
      const div = document.createElement('div');
      div.className = 'vendor-card';
      div.dataset.vendorId = vendor.id;
      div.dataset.vendorName = vendor.full_name;
      div.innerHTML = `
        <div class="vendor-info">
          <div class="vendor-details">
            <div class="vendor-name">${vendor.full_name}</div>
            <div class="vendor-meta">
              <div class="vendor-meta-item">
                <i class="fas fa-phone"></i>
                <span>${vendor.phone_number}</span>
              </div>
              <div class="vendor-meta-item">
                <i class="fas fa-envelope"></i>
                <span>${vendor.email}</span>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Add click event to select vendor
      div.addEventListener('click', () => {
        // Remove selection from all vendor cards
        document.querySelectorAll('.vendor-card').forEach(card => {
          card.classList.remove('selected');
        });
        
        // Add selection to clicked card
        div.classList.add('selected');
        
        // Update selected vendor
        selectedVendorId = div.dataset.vendorId;
        selectedVendorName = div.dataset.vendorName;
        
        // Enable confirm button
        document.getElementById('confirmVendorAssignment').disabled = false;
      });
      
      vendorsList.appendChild(div);
    });
    
    // Add search functionality
    const searchInput = document.getElementById('vendorSearchInput');
    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase().trim();
      const vendorCards = document.querySelectorAll('.vendor-card');
      
      let visibleCount = 0;
      vendorCards.forEach(card => {
        const vendorName = card.dataset.vendorName.toLowerCase();
        const vendorPhone = card.querySelector('.vendor-meta-item span').textContent.toLowerCase();
        const isVisible = vendorName.includes(searchTerm) || vendorPhone.includes(searchTerm);
        card.style.display = isVisible ? 'block' : 'none';
        if (isVisible) visibleCount++;
      });
      
      // Show/hide empty state
      const emptyDiv = document.getElementById('vendorsEmpty');
      emptyDiv.style.display = visibleCount === 0 ? 'block' : 'none';
    });
  }

  // Confirm vendor assignment - FIXED VERSION
  // Confirm vendor assignment - UPDATES WITHOUT PAGE RELOAD
  document.getElementById('confirmVendorAssignment')?.addEventListener('click', function() {
    if (!currentLoadId || !selectedVendorId) {
      showToast('Please select a vendor', 'error');
      return;
    }
    
    const btn = this;
    const originalText = btn.innerHTML;
    btn.innerHTML = 'Assigning...';
    btn.disabled = true;
    
    // Send assignment request
    fetch(`/loads/${currentLoadId}/assign-vendor/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        vendor_id: selectedVendorId
      })
    })
    .then(response => {
      // Always parse JSON first, then check status
      return response.json().then(data => ({
        ok: response.ok,
        data: data
      }));
    })
    .then(({ ok, data }) => {
      if (data.success) {  // Check the success flag in the JSON response
        showToast(`Vendor ${selectedVendorName} assigned successfully!`, 'success');
        
        // Close modal
        closeAssignVendorModal();
        
        // Close sidebar drawer
        sidebar.classList.remove('open');
        overlay.classList.remove('show');
        
        // Clear active row selection
        const activeRow = document.querySelector('.clickable-row.active');
        if (activeRow) {
          activeRow.classList.remove('active');
          
          // Update load status in table WITHOUT removing the row
          const statusBadge = document.querySelector(`.clickable-row[data-load-id="${currentLoadId}"] .status-badge`);
          if (statusBadge) {
            statusBadge.textContent = 'Confirmed';
            statusBadge.className = 'status-badge status-assigned';
          }
          
          // Update load data attribute
          const loadData = JSON.parse(activeRow.dataset.load);
          loadData.status = 'confirmed';
          loadData.status_display = 'Confirmed';
          activeRow.dataset.load = JSON.stringify(loadData);
        }
        
        // Reset current load selection
        currentLoadId = null;
        
      } else {
        // Show error from data if available
        showToast(data.error || data.message || 'Failed to assign vendor', 'error');
      }
    })
    .catch(error => {
      console.error('Error assigning vendor:', error);
      showToast('Error assigning vendor: ' + error.message, 'error');
    })
    .finally(() => {
      btn.innerHTML = originalText;
      btn.disabled = false;
    });
  });

});
</script>
<!-- vendor assign script -->
</body>
</html>
{% endblock %}