{% extends "admin_base.html" %}
{% load static %}
{% block title %}Trip Management{% endblock %}
{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>Trip Management</title>

  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="stylesheet" href="/static/css/trip.css">
  <style>
    .status-badge {
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }
    .status-trip_requested { background: #fef3c7; color: #d97706; }
    .status-trip_confirmed { background: #dbeafe; color: #2563eb; }
    .status-reached_loading_point { background: #ffedd5; color: #ea580c; }
    .status-upload_lr { background: #dbeafe; color: #2563eb; }
    .status-in_transit { background: #ffedd5; color: #ea580c; }
    .status-reached_unloading_point { background: #dbeafe; color: #2563eb; }
    .status-unloading_completed { background: #d1fae5; color: #16a34a; }
    .status-pod_pending { background: #fef3c7; color: #d97706; }
    .status-pod_received_at_office { background: #d1fae5; color: #16a34a; }
    .status-trip_closed { background: #d1fae5; color: #16a34a; }
  </style>
</head>
<body>
<style>
  /* Add these styles to your CSS */
.btn-pod-received {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  white-space: nowrap;
}

.btn-pod-received:hover {
  background: #7c3aed !important;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
}

.btn-pod-received:active {
  transform: translateY(0);
}

/* Animation for modal */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.pod-received-modal .modal-content {
  animation: fadeIn 0.2s ease-out;
}

/* Add modal styles */
.pod-received-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

.pod-received-modal .modal-content {
  background: white;
  border-radius: 12px;
  padding: 24px;
  width: 90%;
  max-width: 450px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

/* Current Location Styling - Isolated */
.location-card {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  padding: 12px;
  border-radius: 8px;
  border-left: 4px solid #2563eb;
  margin-top: 10px;
  margin-bottom: 16px;
}

.location-card__header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}

.location-card__icon {
  color: #2563eb;
  font-size: 14px;
}

.location-card__title {
  font-weight: 600;
  color: #1e40af;
  font-size: 12px;
}

.location-card__content {
  background: white;
  padding: 8px;
  border-radius: 6px;
  margin-bottom: 8px;
}

.location-card__location-text {
  font-weight: 600;
  color: #111827;
  font-size: 14px;
  margin-bottom: 4px;
}

.location-card__timestamp {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 11px;
  color: #6b7280;
}

.location-card__timestamp-icon {
  color: #9ca3af;
  font-size: 10px;
}

.location-card__timestamp-value {
  font-weight: 500;
}

.location-card__edit-mode {
  display: none;
}

.location-card__edit-mode.active {
  display: block;
}

.location-card__input {
  width: 100%;
  padding: 8px 10px;
  border: 2px solid #d1d5db;
  border-radius: 6px;
  font-size: 13px;
  margin-bottom: 8px;
  box-sizing: border-box;
}

.location-card__button-group {
  display: flex;
  gap: 6px;
}

.location-card__button {
  flex: 1;
  padding: 8px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 500;
  transition: background 0.2s;
  color: white;
}

.location-card__button--save {
  background: #16a34a;
}

.location-card__button--save:hover {
  background: #15803d;
}

.location-card__button--cancel {
  background: #f3f4f6;
  color: #374151;
}

.location-card__button--cancel:hover {
  background: #e5e7eb;
}

.location-card__button--edit {
  width: 100%;
  padding: 8px;
  background: #2563eb;
  color: white;
}

.location-card__button--edit:hover {
  background: #1d4ed8;
}
</style>
<div class="dashboard">
  <div class="top-bar">
    <h2>Trip Management</h2>
    <div class="search-add-container">
      <select id="statusFilter" class="search-input" style="width:180px;">
        <option value="all" selected>All Statuses</option>
        <option value="trip_requested">Trip Requested</option>
        <option value="trip_confirmed">Trip Confirmed</option>
        <option value="reached_loading_point">Reached at Loading point</option>
        <option value="upload_lr">Upload LR</option>
        <option value="in_transit">In transit</option>
        <option value="reached_unloading_point">Reached at unloading point</option>
        <option value="unloading_completed">Unloading completed</option>
        <option value="pod_pending">POD status - Pending</option>
        <option value="pod_received_at_office">POD status - received at rotra office</option>
        <option value="trip_closed">Trip closed</option>
      </select>
      <input type="text" id="searchInput" placeholder="Search trips..." class="search-input">
      <button class="add-button" onclick="window.location.href='{% url 'load_list' %}'">View All Loads</button>
    </div>
  </div>
  <div class="table-card">
    <table id="tripsTable">
      <thead>
        <tr>
          <th>Load ID</th>
          <th>Route</th>
          <th>Date and Time</th>
          <th>Trip Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if trips %}
          {% for load in trips %}
          <tr class="clickable-row" data-trip-id="{{ load.id }}" data-trip-status="{{ load.trip_status }}">
            <td style="color:var(--primary); font-weight: 600;">{{ load.load_id }}</td>
            <td>
              <div class="route-display">
                {{ load.pickup_location }}
                <i class="fas fa-arrow-right route-arrow"></i>
                {{ load.drop_location }}
              </div>
            </td>
            <td>{{ load.updated_at|date:"M d, Y H:i" }}</td>
            <td>
              <span class="status-badge status-{{ load.trip_status }}">
                {{ load.get_trip_status_display }}
              </span>
            </td>
            <td class="action-col">
              <button class="action-view" onclick="viewTrip(event, {{ load.id }})">View</button>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="5" style="text-align:center;padding:60px;color:#6b7280;">No trips found.</td></tr>
        {% endif %}
      </tbody>
    </table>

    <div class="pagination-container">
      <div class="entries-per-page">
        <span>Show</span>
        <select id="entriesPerPage">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="25">25</option>
          <option value="50">50</option>
        </select>
        <span>entries</span>
      </div>
      <div class="pagination-info">
        Showing <span id="showingStart">1</span> to <span id="showingEnd">10</span> of <span id="totalEntries">0</span> entries
      </div>
      <div class="pagination-controls">
        <button id="prevPage">Previous</button>
        <span id="currentPageInfo">Page 1</span>
        <button id="nextPage">Next</button>
      </div>
    </div>
  </div>

  <aside id="profileSidebar">
    <div class="sidebar-header">
      <div>
        <h3 id="sidebarTripId">Loading...</h3>
        <span class="status-badge" id="sidebarStatusBadge" style="font-size:11px;padding:4px 10px;margin-top:6px;display:inline-block;">
          Loading...
        </span>
      </div>
      <button class="close-btn" id="closeSidebar">×</button>
    </div>

    <div class="route-header">
      <div class="route-title">Route Information</div>
      <div class="route-path">
        <div class="route-line"></div>
        <div class="truck-icon"><i class="fas fa-truck"></i></div>
        <div class="route-line"></div>
      </div>
      <div style="margin-top:8px;font-weight:600;">
        <span id="routeFrom">-</span> — <span id="routeTo">-</span>
      </div>
    </div>

    <div class="trip-info-section">
      <h3 class="section-title">Trip Information</h3>
      <div class="info-grid">
        <div class="info-item"><div class="info-label">Vehicle No</div><div class="info-value" id="vehicleNo">-</div></div>
        <div class="info-item"><div class="info-label">Driver</div><div class="info-value" id="driverName">-</div></div>
        <div class="info-item"><div class="info-label">Vehicle Type</div><div class="info-value" id="vehicleType">-</div></div>
        <div class="info-item"><div class="info-label">Distance</div><div class="info-value" id="distance">-</div></div>
        <div class="info-item"><div class="info-label">Start Date</div><div class="info-value" id="startDate">-</div></div>
        <div class="info-item"><div class="info-label">ETA</div><div class="info-value" id="eta">-</div></div>

        <div class="info-item">
          <div class="info-label">POD Received</div>
          <div class="info-value" id="podReceivedDate">-</div>
        </div>
        <br>
       
      </div>
 <div class="location-card">
          <div class="location-card__header">
            <i class="fas fa-map-marker-alt location-card__icon"></i>
            <span class="location-card__title">Current Location</span>
          </div>
          
          <!-- Display mode -->
          <div class="location-card__content">
            <div class="location-card__location-text" id="currentLocationText">-</div>
            <div class="location-card__timestamp">
              <i class="fas fa-clock location-card__timestamp-icon"></i>
              <span>Updated:</span>
              <span class="location-card__timestamp-value" id="currentLocationTimestamp">-</span>
            </div>
          </div>

          <!-- Edit mode -->
          <div class="location-card__edit-mode" id="locationEditMode">
            <input
              type="text"
              id="currentLocationInput"
              class="location-card__input"
              placeholder="Enter current location"
            />
            <div class="location-card__button-group">
              <button
                id="btnSaveLocation"
                class="location-card__button location-card__button--save"
              >
                <i class="fas fa-check" style="margin-right: 4px;"></i> Save
              </button>
              <button
                id="btnCancelEditLocation"
                class="location-card__button location-card__button--cancel"
              >
                <i class="fas fa-times" style="margin-right: 4px;"></i> Cancel
              </button>
            </div>
          </div>

          <button
            id="btnEditLocation"
            class="location-card__button location-card__button--edit"
          >
            <i class="fas fa-edit" style="margin-right: 6px;"></i> Update Location
          </button>
        </div>

      <div class="location-card">
        <div class="location-card__header">
          <i class="fas fa-map-marker-alt location-card__icon"></i>
          <span class="location-card__title">Current Location</span>
        </div>
        <div class="location-card__content">
          <div class="location-card__location-text" id="currentLocation">-</div>
          <div class="location-card__timestamp">
            <i class="fas fa-clock location-card__timestamp-icon"></i>
            <span>Updated:</span>
            <span class="location-card__timestamp-value" id="currentLocationSidebarTimestamp">-</span>
          </div>
        </div>
      </div>

      <div class="payment-box">
        <div class="payment-row">
          <span>Final Payment</span>
          <span id="finalPaymentStatus" class="pending">₹0 Pending</span>
        </div>
        <div class="payment-row">
          <span>First Half Payment (90%)</span>
          <div style="display: flex; align-items: center; gap: 8px;">
            <span id="firstHalfPaymentStatus" class="pending">₹0</span>
            <input type="checkbox" id="firstHalfPaymentCheckbox" title="Mark as paid" style="cursor: pointer; width: 18px; height: 18px;">
          </div>
        
        </div>
        <div class="payment-row">
          <span>Second Half Payment (10%)</span>
          <span id="secondHalfPaymentStatus" class="pending">₹0</span>
         
        </div>
        <div class="payment-row">
          <span>Holding Charges</span>
          <span id="holdingChargesStatus" class="pending">₹0</span>
          <button id="btnViewHoldingCharges" style="padding: 4px 8px; background: var(--blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; margin-left: 8px;" title="View all holding charges">View</button>
        </div>
        <!-- TDS Section -->
        <div id="tdsSection" style="display: none; background: #fef3c7; border: 1px solid #fcd34d; border-radius: 6px; padding: 10px; margin-top: 10px;">
          <div class="payment-row" style="border: none; padding: 0; margin-bottom: 8px;">
            <span style="color: #92400e; font-weight: 600;">TDS Deduction Applied</span>
            <span id="tdsRateDisplay" style="color: #b45309; font-weight: 600;">2%</span>
          </div>
          <div class="payment-row" style="border: none; padding: 0; margin-bottom: 4px;">
            <span style="color: #92400e; font-size: 13px;">TDS Amount:</span>
            <span id="tdsAmountDisplay" style="color: #b45309; font-weight: 500;">₹0</span>
          </div>
          <div class="payment-row" style="border: none; padding: 0;">
            <span style="color: #92400e; font-size: 13px;">Amount After TDS:</span>
            <span id="tdsDeductibleAmountDisplay" style="color: #b45309; font-weight: 600;">₹0</span>
          </div>
        </div>
        <div class="payment-row" style="border-top: 1px solid #e5e7eb; padding-top: 8px; margin-top: 8px; font-weight: 600; color: #1f2937;">
          <span>Total Amount</span>
          <span id="totalAmountStatus" class="pending">₹0</span>
        </div>
        <div class="payment-row" style="border-top: 1px solid #e5e7eb; padding-top: 8px; margin-top: 8px; font-weight: 600; color: #2563eb;">
          <span>User Amount</span>
          <span id="userAmountStatus" class="pending">₹0</span>
        </div>
        <div class="payment-row" style="border-top: 1px solid #e5e7eb; padding-top: 8px; margin-top: 8px; font-weight: 600; color: #16a34a;">
          <span>Remaining to be Paid</span>
          <span id="remainingAmountStatus" class="pending">₹0</span>
        </div>
        <div style="margin-top: 12px; display: flex; gap: 8px;">
          <button id="btnAddHoldingCharges" style="padding: 8px 12px; background: var(--amber); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; white-space: nowrap;">Add Charges</button>
        </div>
        <div id="holdingChargesInfo" style="margin-top: 8px; font-size: 12px; color: #6b7280; display: none;">
          <span id="chargesAddedAtStatus"></span>
        </div>
      </div>
      <!-- Add this after the payment-box div -->
      <div id="paymentAdjustmentBox" style="display: none; margin-top: 16px; padding: 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
        <h3 class="section-title" style="font-size: 14px; margin-top: 0; margin-bottom: 12px; color: #475569;">Payment Adjustment Details</h3>
        
        <div class="adjustment-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="color: #64748b; font-size: 13px;">Expected Amount:</span>
            <span id="expectedAmount" style="font-weight: 600; color: #334155;">₹0</span>
        </div>
        
        <div class="adjustment-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="color: #64748b; font-size: 13px;">Actual Paid:</span>
            <span id="actualPaidAmount" style="font-weight: 600; color: #16a34a;">₹0</span>
        </div>
        
        <div class="adjustment-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="color: #64748b; font-size: 13px;">Adjustment:</span>
            <span id="adjustmentAmount" style="font-weight: 600; color: #dc2626;">₹0</span>
        </div>
        
        <div class="adjustment-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="color: #64748b; font-size: 13px;">Adjustment %:</span>
            <span id="adjustmentPercentage" style="font-weight: 600; color: #dc2626;">0%</span>
        </div>
        
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0;">
            <div style="color: #64748b; font-size: 13px; margin-bottom: 4px;">Adjustment Reason:</div>
            <div id="adjustmentReason" style="color: #334155; font-size: 13px; line-height: 1.4; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e2e8f0;">
                No adjustment reason provided
            </div>
        </div>
      </div>

      <h3 class="section-title" style="margin-top:28px;">Customer Details</h3>
      <div class="detail-row"><span class="detail-label">Customer Name</span><span class="detail-value" id="customerName">-</span></div>
      <div class="detail-row"><span class="detail-label">Customer Phone</span><span class="detail-value" id="customerPhone">-</span></div>
      <div class="detail-row"><span class="detail-label">Contact Person</span><span class="detail-value" id="contactPerson">-</span></div>
      <div class="detail-row"><span class="detail-label">Contact Person Phone</span><span class="detail-value" id="contactPersonPhone">-</span></div>

      <h3 class="section-title" style="margin-top:28px;">Vendor Details</h3>
      <div class="detail-row"><span class="detail-label">Vendor Name</span><span class="detail-value" id="vendorName">-</span></div>
      <div class="detail-row"><span class="detail-label">Vendor Phone</span><span class="detail-value" id="vendorPhone">-</span></div>

      <h3 class="section-title" style="margin-top:28px;">Assigned Driver</h3>
      <div class="detail-row"><span class="detail-label">Driver Name</span><span class="detail-value" id="assignedDriverName">-</span></div>
      <div class="detail-row"><span class="detail-label">Driver Phone</span><span class="detail-value" id="assignedDriverPhone">-</span></div>

      <div class="progress-container">
        <div class="progress-header">
          <div class="progress-title">Trip Progress</div>
          <div class="progress-percent" id="progressPercent">0% Complete</div>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width: 0%;"></div></div>
      </div>

      <div class="timeline-section">
        <h3 class="timeline-title">Trip Status Timeline</h3>
        <div class="timeline" id="timelineContainer">
          <!-- Timeline will be populated dynamically -->
        </div>
      </div>
    </div>

    <div class="chat-section">
      <h3 class="chat-title">Chat</h3>
      
      <div class="chat-messages-container" id="chatMessagesContainer">
        <div class="no-messages" id="noMessages">No messages yet</div>
      </div>
      
      <div class="chat-input-wrapper">
        <input type="text" class="chat-input" id="commentInput" placeholder="Type a message...">
        <button class="send-rocket" id="sendComment"><i class="fas fa-paper-plane"></i></button>
      </div>
      
      <div class="chat-buttons">
        <div style="display: flex; gap: 8px; align-items: center;">
          <select id="statusSelect" class="status-select" style="flex: 1; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background: white; cursor: pointer;">
            <option value="">Select Status...</option>
            <option value="trip_requested">Trip Requested</option>
            <option value="trip_confirmed">Trip Confirmed</option>
            <option value="reached_loading_point">Reached at Loading point</option>
            <option value="upload_lr">Upload LR</option>
            <option value="in_transit">In transit</option>
            <option value="reached_unloading_point">Reached at unloading point</option>
            <option value="unloading_completed">Unloading completed</option>
            <option value="pod_pending">POD status - Pending</option>
            <option value="pod_received_at_office">POD status - received at rotra office</option>
            <option value="trip_closed">Trip closed</option>
          </select>
          <button class="btn-update" id="btnUpdateStatus">Update Status</button>
        </div>
        <button class="btn-upload-lr" id="btnUploadLR" style="display: none;">Upload LR</button>
        <button class="btn-pod-received" id="btnAddPODReceivedDate" style="display:block; padding: 10px 14px; background: #8b5cf6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; margin-top: 8px;">
          <i class="fas fa-calendar-check"></i> Add POD Received Date
        </button>
        <button class="btn-add-comment" id="btnAddComment">Add Comment</button>
      </div>
      <button class="btn-close-trip" id="btnCloseTrip">Close Trip</button>
    </div>
  </aside>

  <div id="sidebarOverlay"></div>
</div>

<!-- pod received modal -->
<div class="pod-received-modal" id="podReceivedModal">
  <div class="modal-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="margin: 0; color: #1f2937; font-size: 18px; font-weight: 600;">
        <i class="fas fa-calendar-check" style="color: #8b5cf6; margin-right: 8px;"></i>
        POD Received Date & Time
      </h3>
      <button class="close-pod-received-modal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; transition: color 0.2s;">&times;</button>
    </div>
    
    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151; font-size: 14px;">
        Select Date and Time
      </label>
      <input 
        type="datetime-local" 
        id="podReceivedDateTimeInput" 
        style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: border-color 0.2s;" 
      >
      <p style="font-size: 12px; color: #6b7280; margin-top: 6px; margin-bottom: 0;">
        <i class="fas fa-info-circle"></i> Select when the POD was physically received
      </p>
    </div>
    
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button 
        class="close-pod-received-modal" 
        style="padding: 10px 20px; background: #f3f4f6; color: #374151; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px; transition: background-color 0.2s;" 
      >
        Cancel
      </button>
      <button 
        id="btnSubmitPODReceivedDate" 
        style="padding: 10px 20px; background: #8b5cf6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px; transition: background-color 0.2s;" 
      >
        <i class="fas fa-check"></i> Save
      </button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script>
let currentTripId = null;
let sidebarEventListenersAttached = false;

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

const csrftoken = getCookie('csrftoken');

function showToast(message, type = 'success') {
  const background = type === 'success' ? '#16a34a' : type === 'error' ? '#dc2626' : '#d97706';
  
  Toastify({
    text: message,
    duration: 3000,
    gravity: "top",
    position: "right",
    style: { background: background },
    stopOnFocus: true,
    className: "toastify-custom",
  }).showToast();
}

function attachSidebarEventListeners() {
  if (sidebarEventListenersAttached) return;
  
  const sidebar = document.getElementById('profileSidebar');
  const overlay = document.getElementById('sidebarOverlay');
  const closeBtn = document.getElementById('closeSidebar');

  closeBtn.addEventListener('click', closeSidebar);
  overlay.addEventListener('click', closeSidebar);

  // First half payment checkbox listener
  document.getElementById('firstHalfPaymentCheckbox').addEventListener('change', function() {
    if (!currentTripId) {
      showToast('No trip selected', 'error');
      this.checked = !this.checked; // Revert checkbox
      return;
    }
    
    const tripId = currentTripId;
    const isPaid = this.checked;
    console.log('Sending request for trip ID:', tripId, 'is_paid:', isPaid);
    // Call API to update first half payment status
    fetch(`/api/payment/${tripId}/mark-first-half-paid/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken
      },
      body: JSON.stringify({ is_paid: isPaid })
    })
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        // Update UI with backend data
        const firstHalfPaymentStatus = document.getElementById('firstHalfPaymentStatus');
        const remainingAmountStatus = document.getElementById('remainingAmountStatus');
        const totalAmountStatus = document.getElementById('totalAmountStatus');
        
        // Update first half payment status
        if (isPaid) {
          firstHalfPaymentStatus.className = 'paid';
          // Add tooltip with payment info
          let tooltipText = 'First half payment paid';
          if (result.paid_at) {
            tooltipText += `\nOn: ${result.paid_at}`;
          }
          if (result.paid_by) {
            tooltipText += `\nBy: ${result.paid_by}`;
          }
          firstHalfPaymentStatus.title = tooltipText;
        } else {
          firstHalfPaymentStatus.className = 'pending';
          firstHalfPaymentStatus.title = '';
        }
        
        // Update remaining amount
        remainingAmountStatus.textContent = `₹${parseFloat(result.remaining_amount || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
        
        // Update remaining amount color based on payment status
        if (result.is_paid) {
          remainingAmountStatus.className = 'paid';
        } else {
          remainingAmountStatus.className = 'pending';
        }
        
        showToast(result.message || 'First half payment status updated', 'success');
      } else {
        // Revert checkbox on error
        this.checked = !isPaid;
        showToast('Error: ' + (result.error || 'Failed to update payment status'), 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      // Revert checkbox on error
      this.checked = !isPaid;
      showToast('Failed to update payment status', 'error');
    });
  });

  document.getElementById('btnUpdateStatus').addEventListener('click', updateTripStatus);
  document.getElementById('btnUploadLR').addEventListener('click', showLRUploadModal);
  document.getElementById('btnAddComment').addEventListener('click', addComment);
  document.getElementById('sendComment').addEventListener('click', addComment);
  document.getElementById('btnCloseTrip').addEventListener('click', closeTrip);
  document.getElementById('btnAddHoldingCharges').addEventListener('click', addHoldingCharges);
  
  // Initialize POD received modal button - ALWAYS VISIBLE
  const btnAddPODReceived = document.getElementById('btnAddPODReceivedDate');
  if (btnAddPODReceived) {
    btnAddPODReceived.addEventListener('click', showPODReceivedModal);
  }
  
  const commentInput = document.getElementById('commentInput');
  commentInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      addComment();
    }
  });

  sidebarEventListenersAttached = true;
}

document.addEventListener('DOMContentLoaded', function () {
  const tbody = document.querySelector('#tripsTable tbody');
  let allRows = Array.from(document.querySelectorAll('.clickable-row'));
  let filteredRows = [...allRows];
  let currentPage = 1;
  let perPage = 10;

  const entriesSelect = document.getElementById('entriesPerPage');
  const showingStart = document.getElementById('showingStart');
  const showingEnd = document.getElementById('showingEnd');
  const totalEntries = document.getElementById('totalEntries');
  const prevBtn = document.getElementById('prevPage');
  const nextBtn = document.getElementById('nextPage');
  const currentPageInfo = document.getElementById('currentPageInfo');
  const searchInput = document.getElementById('searchInput');
  const statusSelect = document.getElementById('statusFilter');

  function renderPage() {
    const start = (currentPage - 1) * perPage;
    const end = start + perPage;
    allRows.forEach(r => r.style.display = 'none');
    filteredRows.slice(start, end).forEach(r => r.style.display = '');

    const visibleEnd = Math.min(end, filteredRows.length);
    showingStart.textContent = filteredRows.length ? start + 1 : 0;
    showingEnd.textContent = visibleEnd;
    totalEntries.textContent = filteredRows.length;
    currentPageInfo.textContent = `Page ${currentPage}`;

    prevBtn.disabled = currentPage === 1;
    nextBtn.disabled = currentPage >= Math.ceil(filteredRows.length / perPage);
  }

  entriesSelect.addEventListener('change', () => {
    perPage = parseInt(entriesSelect.value);
    currentPage = 1;
    renderPage();
  });

  prevBtn.addEventListener('click', () => { 
    if (currentPage > 1) { 
      currentPage--; 
      renderPage(); 
    } 
  });
  
  nextBtn.addEventListener('click', () => { 
    if (currentPage < Math.ceil(filteredRows.length / perPage)) { 
      currentPage++; 
      renderPage(); 
    } 
  });

  function applyFilters() {
    const term = (searchInput && searchInput.value) ? searchInput.value.toLowerCase() : '';
    const selectedStatus = (statusSelect && statusSelect.value) ? statusSelect.value : 'all';

    filteredRows = allRows.filter(row => {
      const matchesSearch = term === '' || row.textContent.toLowerCase().includes(term);
      const rowStatus = row.dataset.tripStatus || '';
      const matchesStatus = selectedStatus === 'all' || rowStatus === selectedStatus;
      return matchesSearch && matchesStatus;
    });

    currentPage = 1;
    renderPage();
  }

  if (searchInput) {
    searchInput.addEventListener('input', () => {
      applyFilters();
    });
  }

  if (statusSelect) {
    statusSelect.addEventListener('change', () => {
      applyFilters();
    });
  }

  attachRowClickListeners();
  attachSidebarEventListeners();
  initializeLRModal();
  initializePODModal();
  initializePODReceivedModal();
  applyFilters();
});

function attachRowClickListeners() {
  document.querySelectorAll('.clickable-row').forEach(row => {
    row.addEventListener('click', function(e) {
      if (!e.target.closest('.action-col')) {
        const tripId = this.dataset.tripId;
        loadTripDetails(tripId);
      }
    });
  });
}

function initializeLRModal() {
  if (document.getElementById('lrModal')) return;
  
  const modalHTML = `
  <div class="lr-modal" id="lrModal">
    <div class="lr-modal-content">
      <div class="lr-modal-header">
        <h3>Upload LR Document</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="upload-area" id="modalUploadArea">
        <input type="file" id="modalFileInput" accept=".pdf,.jpg,.jpeg,.png" style="display: none;">
        <div class="upload-placeholder">
          <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #6b7280; margin-bottom: 16px;"></i>
          <p style="color: #6b7280; margin-bottom: 16px;">Click to upload LR document</p>
          <p style="font-size: 12px; color: #9ca3af;">Supported formats: PDF, JPG, PNG (Max 10MB)</p>
        </div>
      </div>
      <div class="file-preview" id="modalFilePreview">
        <div class="file-info">
          <div class="file-name">
            <i class="fas fa-file-pdf" style="color: #ef4444;"></i>
            <span id="modalFileName">file.pdf</span>
          </div>
          <button type="button" class="remove-file">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" id="btnCancelUpload">Cancel</button>
        <button class="btn-submit-lr" id="btnSubmitLR" disabled>Upload Document</button>
      </div>
    </div>
  </div>
  `;

  document.body.insertAdjacentHTML('beforeend', modalHTML);

  document.querySelector('#lrModal .close-modal').addEventListener('click', closeLRModal);
  document.querySelector('#lrModal #btnCancelUpload').addEventListener('click', closeLRModal);
  document.querySelector('#lrModal #modalUploadArea').addEventListener('click', () => document.querySelector('#lrModal #modalFileInput').click());
  document.querySelector('#lrModal #modalFileInput').addEventListener('change', handleLRFileSelect);
  document.querySelector('#lrModal .remove-file').addEventListener('click', removeSelectedLRFile);
  document.querySelector('#lrModal #btnSubmitLR').addEventListener('click', uploadLRDocument);

  const modalUploadArea = document.querySelector('#lrModal #modalUploadArea');
  modalUploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    modalUploadArea.classList.add('dragover');
  });

  modalUploadArea.addEventListener('dragleave', () => {
    modalUploadArea.classList.remove('dragover');
  });

  modalUploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    modalUploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      handleLRFileSelection(files[0]);
    }
  });
}

function initializePODModal() {
  if (document.getElementById('podModal')) return;
  
  const modalHTML = `
  <div class="pod-modal" id="podModal">
    <div class="pod-modal-content">
      <div class="pod-modal-header">
        <h3>Upload POD Document</h3>
        <button class="close-pod-modal">&times;</button>
      </div>
      <div class="upload-area" id="podModalUploadArea">
        <input type="file" id="podModalFileInput" accept=".pdf,.jpg,.jpeg,.png" style="display: none;">
        <div class="upload-placeholder">
          <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #6b7280; margin-bottom: 16px;"></i>
          <p style="color: #6b7280; margin-bottom: 16px;">Click to upload POD document</p>
          <p style="font-size: 12px; color: #9ca3af;">Supported formats: PDF, JPG, PNG (Max 10MB)</p>
        </div>
      </div>
      <div class="file-preview" id="podModalFilePreview">
        <div class="file-info">
          <div class="file-name">
            <i class="fas fa-file-pdf" style="color: #2563eb;"></i>
            <span id="podModalFileName">file.pdf</span>
          </div>
          <button type="button" class="remove-pod-file">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" id="btnCancelPODUpload">Cancel</button>
        <button class="btn-submit-pod" id="btnSubmitPOD" disabled>Upload Document</button>
      </div>
    </div>
  </div>
  `;

  document.body.insertAdjacentHTML('beforeend', modalHTML);

  document.querySelector('#podModal .close-pod-modal').addEventListener('click', closePODModal);
  document.querySelector('#podModal #btnCancelPODUpload').addEventListener('click', closePODModal);
  document.querySelector('#podModal #podModalUploadArea').addEventListener('click', () => document.querySelector('#podModal #podModalFileInput').click());
  document.querySelector('#podModal #podModalFileInput').addEventListener('change', handlePODFileSelect);
  document.querySelector('#podModal .remove-pod-file').addEventListener('click', removeSelectedPODFile);
  document.querySelector('#podModal #btnSubmitPOD').addEventListener('click', uploadPODDocument);

  const podModalUploadArea = document.querySelector('#podModal #podModalUploadArea');
  podModalUploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    podModalUploadArea.classList.add('dragover');
  });

  podModalUploadArea.addEventListener('dragleave', () => {
    podModalUploadArea.classList.remove('dragover');
  });

  podModalUploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    podModalUploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      handlePODFileSelection(files[0]);
    }
  });
}

function initializePODReceivedModal() {
  const modal = document.getElementById('podReceivedModal');
  const btnSubmit = document.getElementById('btnSubmitPODReceivedDate');
  const closeButtons = document.querySelectorAll('.close-pod-received-modal');
  
  // Note: Button event listener is already attached in attachSidebarEventListeners()
  // to ensure it's always available
  
  if (btnSubmit) {
    btnSubmit.addEventListener('click', submitPODReceivedDate);
  }
  
  closeButtons.forEach(btn => {
    btn.addEventListener('click', closePODReceivedModal);
  });
  
  // Close on outside click
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closePODReceivedModal();
      }
    });
  }
}

function showPODReceivedModal() {
  const modal = document.getElementById('podReceivedModal');
  const dateTimeInput = document.getElementById('podReceivedDateTimeInput');
  
  // Set current date and time as default
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  
  dateTimeInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
  
  modal.style.display = 'flex';
}

function closePODReceivedModal() {
  const modal = document.getElementById('podReceivedModal');
  modal.style.display = 'none';
  document.getElementById('podReceivedDateTimeInput').value = '';
}

function submitPODReceivedDate() {
  if (!currentTripId) {
    showToast('No trip selected', 'error');
    return;
  }
  
  const dateTimeInput = document.getElementById('podReceivedDateTimeInput');
  const dateTimeValue = dateTimeInput.value;
  
  if (!dateTimeValue) {
    showToast('Please select a date and time', 'error');
    return;
  }
  
  const btnSubmit = document.getElementById('btnSubmitPODReceivedDate');
  btnSubmit.disabled = true;
  btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
  
  fetch(`/api/trip/${currentTripId}/update-pod-received-date/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrftoken
    },
    body: JSON.stringify({
      pod_received_at: dateTimeValue
    })
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      showToast(result.message || 'POD received date updated successfully', 'success');
      closePODReceivedModal();
      
      // Update the display
      document.getElementById('podReceivedDate').textContent = result.pod_received_at;
      
      // Update button text to "Update POD Received Date" if date is already set
      const btnAddPODReceived = document.getElementById('btnAddPODReceivedDate');
      if (btnAddPODReceived && result.pod_received_at) {
        btnAddPODReceived.innerHTML = '<i class="fas fa-calendar-edit"></i> Update POD Received Date';
      }
      
      // Reload trip details to refresh all data
      setTimeout(() => {
        loadTripDetails(currentTripId);
      }, 300);
    } else {
      showToast('Error: ' + (result.error || 'Failed to update POD received date'), 'error');
    }
    
    btnSubmit.disabled = false;
    btnSubmit.innerHTML = '<i class="fas fa-check"></i> Save';
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('Failed to update POD received date', 'error');
    btnSubmit.disabled = false;
    btnSubmit.innerHTML = '<i class="fas fa-check"></i> Save';
  });
}

function showLRUploadModal() {
  document.getElementById('lrModal').style.display = 'flex';
  resetLRModal();
}

function closeLRModal() {
  document.getElementById('lrModal').style.display = 'none';
  resetLRModal();
}

function resetLRModal() {
  document.querySelector('#lrModal #modalFileInput').value = '';
  document.querySelector('#lrModal #modalFilePreview').style.display = 'none';
  document.querySelector('#lrModal #btnSubmitLR').disabled = true;
  document.querySelector('#lrModal #modalUploadArea').style.display = 'block';
  document.querySelector('#lrModal #btnSubmitLR').textContent = 'Upload Document';
}

function showPODUploadModal() {
  document.getElementById('podModal').style.display = 'flex';
  resetPODModal();
}

function closePODModal() {
  document.getElementById('podModal').style.display = 'none';
  resetPODModal();
}

function resetPODModal() {
  document.querySelector('#podModal #podModalFileInput').value = '';
  document.querySelector('#podModal #podModalFilePreview').style.display = 'none';
  document.querySelector('#podModal #btnSubmitPOD').disabled = true;
  document.querySelector('#podModal #podModalUploadArea').style.display = 'block';
  document.querySelector('#podModal #btnSubmitPOD').textContent = 'Upload Document';
}

function handleLRFileSelect(e) {
  const file = e.target.files[0];
  if (file) {
    handleLRFileSelection(file);
  }
}

function handleLRFileSelection(file) {
  const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
  if (!allowedTypes.includes(file.type)) {
    showToast('Please select a PDF, JPG, or PNG file', 'error');
    return;
  }

  if (file.size > 10 * 1024 * 1024) {
    showToast('File size must be less than 10MB', 'error');
    return;
  }

  document.querySelector('#lrModal #modalFileName').textContent = file.name;
  document.querySelector('#lrModal #modalFilePreview').style.display = 'block';
  document.querySelector('#lrModal #btnSubmitLR').disabled = false;

  const fileIcon = document.querySelector('#lrModal .file-name i');
  if (file.type === 'application/pdf') {
    fileIcon.className = 'fas fa-file-pdf';
    fileIcon.style.color = '#ef4444';
  } else {
    fileIcon.className = 'fas fa-file-image';
    fileIcon.style.color = '#16a34a';
  }
}

function handlePODFileSelect(e) {
  const file = e.target.files[0];
  if (file) {
    handlePODFileSelection(file);
  }
}

function handlePODFileSelection(file) {
  const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
  if (!allowedTypes.includes(file.type)) {
    showToast('Please select a PDF, JPG, or PNG file', 'error');
    return;
  }

  if (file.size > 10 * 1024 * 1024) {
    showToast('File size must be less than 10MB', 'error');
    return;
  }

  document.querySelector('#podModal #podModalFileName').textContent = file.name;
  document.querySelector('#podModal #podModalFilePreview').style.display = 'block';
  document.querySelector('#podModal #btnSubmitPOD').disabled = false;

  const fileIcon = document.querySelector('#podModal .file-name i');
  if (file.type === 'application/pdf') {
    fileIcon.className = 'fas fa-file-pdf';
    fileIcon.style.color = '#2563eb';
  } else {
    fileIcon.className = 'fas fa-file-image';
    fileIcon.style.color = '#16a34a';
  }
}

function removeSelectedLRFile() {
  resetLRModal();
}

function removeSelectedPODFile() {
  resetPODModal();
}

function uploadLRDocument() {
  if (!currentTripId) {
    showToast('No trip selected', 'error');
    return;
  }

  const fileInput = document.querySelector('#lrModal #modalFileInput');
  if (!fileInput.files.length) {
    showToast('Please select a file to upload', 'error');
    return;
  }

  const file = fileInput.files[0];
  const formData = new FormData();
  formData.append('lr_document', file);

  const submitBtn = document.querySelector('#lrModal #btnSubmitLR');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Uploading...';

  fetch(`/api/trip/${currentTripId}/upload-lr/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken
    },
    body: formData
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      showToast('LR document uploaded successfully!', 'success');
      closeLRModal();
      loadTripDetails(currentTripId);
    } else {
      showToast('Error: ' + result.error, 'error');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Upload Document';
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('Failed to upload LR document', 'error');
    submitBtn.disabled = false;
    submitBtn.textContent = 'Upload Document';
  });
}

function uploadPODDocument() {
  if (!currentTripId) {
    showToast('No trip selected', 'error');
    return;
  }

  const fileInput = document.querySelector('#podModal #podModalFileInput');
  if (!fileInput.files.length) {
    showToast('Please select a file to upload', 'error');
    return;
  }

  const file = fileInput.files[0];
  const formData = new FormData();
  formData.append('pod_document', file);

  const submitBtn = document.querySelector('#podModal #btnSubmitPOD');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Uploading...';

  fetch(`/api/trip/${currentTripId}/upload-pod/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken
    },
    body: formData
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      showToast('POD document uploaded successfully!', 'success');
      closePODModal();
      loadTripDetails(currentTripId);
    } else {
      showToast('Error: ' + result.error, 'error');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Upload Document';
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('Failed to upload POD document', 'error');
    submitBtn.disabled = false;
    submitBtn.textContent = 'Upload Document';
  });
}

function viewTrip(event, tripId) {
  event.stopPropagation();
  loadTripDetails(tripId);
}

function loadTripDetails(tripId) {
  currentTripId = tripId;
  const sidebar = document.getElementById('profileSidebar');
  const overlay = document.getElementById('sidebarOverlay');
  
  document.getElementById('sidebarTripId').textContent = 'Loading...';
  
  sidebar.classList.add('open');
  overlay.classList.add('show');
  
  document.querySelectorAll('.clickable-row').forEach(r => r.classList.remove('selected'));
  const selectedRow = document.querySelector(`[data-trip-id="${tripId}"]`);
  if (selectedRow) selectedRow.classList.add('selected');
  
  fetch(`/api/trip/${tripId}/details/`, {
    method: 'GET',
    headers: {
      'X-CSRFToken': csrftoken,
      'Content-Type': 'application/json'
    },
    credentials: 'same-origin'
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(result => {
    if (result.success) {
      console.log('Backend data:', result.data); // Add this for debugging
      console.log('First half payment paid:', result.data.first_half_payment_paid);
      populateSidebar(result.data);
    } else {
      showToast('Error loading trip details: ' + (result.error || 'Unknown error'), 'error');
      closeSidebar();
    }
  })
  .catch(error => {
    console.error('Error:', error);
    closeSidebar();
  });
}

function populateSidebar(data) {
  currentTripId = data.id; 
  function formatDateTime(isoString) {
  if (!isoString) return '-';

  const date = new Date(isoString);

  return date.toLocaleString('en-IN', {
    day: '2-digit',
    month: 'short',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    hour12: true
  });
}

  // Update payment adjustment display
  const paymentAdjustmentBox = document.getElementById('paymentAdjustmentBox');
  const adjustmentAmount = parseFloat(data.adjustment_amount || 0);
  const adjustmentType = data.adjustment_type || 'none';
  const podReceivedDate = document.getElementById('podReceivedDate');
  if (data.pod_received_at) {
    podReceivedDate.textContent = formatDateTime(data.pod_received_at);
  } else {
    podReceivedDate.textContent = '-';
  }

  document.getElementById('sidebarTripId').textContent = data.load_id;
  const statusBadge = document.getElementById('sidebarStatusBadge');
  statusBadge.textContent = data.trip_status_display;
  statusBadge.className = 'status-badge status-' + data.trip_status;
  
  // Set current status in dropdown
  const statusSelect = document.getElementById('statusSelect');
  if (statusSelect) {
    statusSelect.value = data.trip_status || '';
  }
  
  document.getElementById('routeFrom').textContent = data.pickup_location;
  document.getElementById('routeTo').textContent = data.drop_location;
  
  document.getElementById('vehicleNo').textContent = data.vehicle_no;
  document.getElementById('driverName').textContent = data.driver_name;
  document.getElementById('vehicleType').textContent = data.vehicle_type;
  document.getElementById('distance').textContent = data.distance;
  document.getElementById('startDate').textContent = data.pickup_date;
  document.getElementById('eta').textContent = data.drop_date;
  
  // Update current location with formatted timestamp
  document.getElementById('currentLocation').textContent = data.current_location || '-';
  document.getElementById('currentLocationText').textContent = data.current_location || '-';
  
  // Format the timestamp nicely
  if (data.current_location_updated_at && data.current_location_updated_at !== '-') {
    document.getElementById('currentLocationTimestamp').textContent = data.current_location_updated_at;
    document.getElementById('currentLocationSidebarTimestamp').textContent = data.current_location_updated_at;
  } else {
    document.getElementById('currentLocationTimestamp').textContent = '-';
    document.getElementById('currentLocationSidebarTimestamp').textContent = '-';
  }
  
  // Update button text based on whether POD received date is already set
  const btnAddPODReceived = document.getElementById('btnAddPODReceivedDate');
  if (btnAddPODReceived) {
    if (data.pod_received_at) {
      btnAddPODReceived.innerHTML = '<i class="fas fa-calendar-edit"></i> Update POD Received Date';
    } else {
      btnAddPODReceived.innerHTML = '<i class="fas fa-calendar-check"></i> Add POD Received Date';
    }
  }
  
  const finalPaymentStatus = document.getElementById('finalPaymentStatus');
  if (adjustmentAmount !== 0 && data.confirmed_amount && data.before_amount) {
    paymentAdjustmentBox.style.display = 'block';
    
    // Set colors based on adjustment type
    const adjustmentColor = adjustmentType === 'increase' ? '#16a34a' : 
                          adjustmentType === 'decrease' ? '#dc2626' : '#64748b';
    
    const adjustmentSign = adjustmentAmount > 0 ? '+' : '';
    
    document.getElementById('expectedAmount').textContent = 
        `₹${parseFloat(data.before_amount).toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
    
    document.getElementById('actualPaidAmount').textContent = 
        `₹${parseFloat(data.confirmed_amount).toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
    
    document.getElementById('adjustmentAmount').textContent = 
        `${adjustmentSign}₹${Math.abs(adjustmentAmount).toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
    document.getElementById('adjustmentAmount').style.color = adjustmentColor;
    
    document.getElementById('adjustmentPercentage').textContent = 
        `${adjustmentSign}${parseFloat(data.adjustment_percentage || 0).toFixed(2)}%`;
    document.getElementById('adjustmentPercentage').style.color = adjustmentColor;
    
    // Show adjustment reason if available
    document.getElementById('adjustmentReason').textContent = 
        data.payment_adjustment_reason || 'No adjustment reason provided';
    
  } else {
      paymentAdjustmentBox.style.display = 'none';
  }
  
  if (data.final_payment_paid) {
    finalPaymentStatus.textContent = `₹${data.final_payment.toLocaleString('en-IN', {minimumFractionDigits: 2})} Paid`;
    finalPaymentStatus.className = 'paid';
  } else {
    finalPaymentStatus.textContent = `₹${data.final_payment.toLocaleString('en-IN', {minimumFractionDigits: 2})} Pending`;
    finalPaymentStatus.className = 'pending';
  }
  
  // Update payment display with first half and second half payment
  // User Amount
  const userAmountStatus = document.getElementById('userAmountStatus');
  if (userAmountStatus && data.user_amount !== undefined) {
    userAmountStatus.textContent = `\u20b9${parseFloat(data.user_amount).toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
  }
  const holdingChargesStatus = document.getElementById('holdingChargesStatus');
  const totalAmountStatus = document.getElementById('totalAmountStatus');
  const remainingAmountStatus = document.getElementById('remainingAmountStatus');
  const holdingChargesInfo = document.getElementById('holdingChargesInfo');
  const chargesAddedAtStatus = document.getElementById('chargesAddedAtStatus');
  const firstHalfPaymentStatus = document.getElementById('firstHalfPaymentStatus');
  const secondHalfPaymentStatus = document.getElementById('secondHalfPaymentStatus');
  const firstHalfPaymentCheckbox = document.getElementById('firstHalfPaymentCheckbox');
  const btnViewHoldingCharges = document.getElementById('btnViewHoldingCharges');
  
  const finalPayment = data.final_payment || 0;
  const firstHalfPayment = data.first_half_payment || 0;
  const secondHalfPayment = data.second_half_payment || 0;
  const holdingCharges = data.holding_charges || 0;
  const totalAmount = (finalPayment + holdingCharges);
  
  // Display first and second half payments
  firstHalfPaymentStatus.textContent = `₹${firstHalfPayment.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
  secondHalfPaymentStatus.textContent = `₹${secondHalfPayment.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
  holdingChargesStatus.textContent = `₹${holdingCharges.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
  totalAmountStatus.textContent = `₹${totalAmount.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
  
  // Set checkbox state based on backend data
  firstHalfPaymentCheckbox.checked = data.first_half_payment_paid || false;
  firstHalfPaymentCheckbox.dataset.tripId = data.id;
  
  // Calculate remaining amount: Total - First Half Payment
  if (data.first_half_payment_paid) {
    firstHalfPaymentStatus.className = 'paid';
    // Add tooltip with payment info
    let tooltipText = 'First half payment paid';
    if (data.first_half_payment_paid_at) {
        tooltipText += `\nOn: ${data.first_half_payment_paid_at}`;
    }

    firstHalfPaymentStatus.title = tooltipText;
  } else {
    firstHalfPaymentStatus.className = 'pending';
    firstHalfPaymentStatus.title = '';
  }
  
  // Calculate remaining amount based on payment status
  let remainingAmount = totalAmount;
  if (data.first_half_payment_paid) {
    remainingAmount = totalAmount - firstHalfPayment;
  }
  
  // If final payment is completed, remaining is 0
  if (data.final_payment_paid) {
    remainingAmount = 0;
  }
  
  remainingAmountStatus.textContent = `₹${remainingAmount.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
  
  // Update remaining amount color based on payment status
  if (data.final_payment_paid) {
    remainingAmountStatus.className = 'paid';
  } else if (data.first_half_payment_paid) {
    remainingAmountStatus.className = 'paid';
  } else {
    remainingAmountStatus.className = 'pending';
  }
  
  // Reset checkbox state
  // firstHalfPaymentCheckbox.checked = false;
  firstHalfPaymentCheckbox.dataset.tripId = data.id;
  
  // Store trip status for modal
  window.currentTripStatus = data.trip_status;
  
  // Show information about when charges were added
  if (data.holding_charges_added_at && holdingCharges > 0) {
    const chargesDate = new Date(data.holding_charges_added_at);
    const formattedDate = chargesDate.toLocaleString('en-IN', {dateStyle: 'short', timeStyle: 'short'});
    chargesAddedAtStatus.textContent = `Added at: ${formattedDate} (Status: ${data.holding_charges_added_at_status || 'Unknown'})`;
    holdingChargesInfo.style.display = 'block';
  } else {
    holdingChargesInfo.style.display = 'none';
  }
  
  // Set up View button for holding charges
  if (data.holding_charges_list && data.holding_charges_list.length > 0) {
    btnViewHoldingCharges.style.display = 'inline-block';
    btnViewHoldingCharges.onclick = () => showViewHoldingChargesModal(data.holding_charges_list);
  } else {
    btnViewHoldingCharges.style.display = 'none';
  }
  
  // Display TDS information if applied
  const tdsSection = document.getElementById('tdsSection');
  if (data.apply_tds) {
    tdsSection.style.display = 'block';
    document.getElementById('tdsRateDisplay').textContent = `${data.tds_rate}%`;
    document.getElementById('tdsAmountDisplay').textContent = `₹${parseFloat(data.tds_amount).toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
    document.getElementById('tdsDeductibleAmountDisplay').textContent = `₹${parseFloat(data.tds_deductible_amount).toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
  } else {
    tdsSection.style.display = 'none';
  }
  
  document.getElementById('customerName').textContent = data.customer_name;
  document.getElementById('customerPhone').textContent = data.customer_phone;
  document.getElementById('contactPerson').textContent = data.contact_person;
  document.getElementById('contactPersonPhone').textContent = data.contact_person_phone;
  
  document.getElementById('vendorName').textContent = data.vendor_name;
  document.getElementById('vendorPhone').textContent = data.vendor_phone;
  
  document.getElementById('assignedDriverName').textContent = data.driver_name;
  document.getElementById('assignedDriverPhone').textContent = data.driver_phone;
  
  document.getElementById('progressPercent').textContent = `${data.progress}% Complete`;
  document.getElementById('progressFill').style.width = `${data.progress}%`;
  
  renderTimeline(data);
  renderChatMessages(data.comments || []);
  
  const uploadLRBtn = document.getElementById('btnUploadLR');
  if (!data.lr_document) {
    uploadLRBtn.style.display = 'inline-block';
  } else {
    uploadLRBtn.style.display = 'none';
  }
  
  const btnCloseTrip = document.getElementById('btnCloseTrip');
  btnCloseTrip.disabled = data.trip_status !== 'trip_closed';
  btnCloseTrip.style.opacity = data.trip_status !== 'trip_closed' ? '0.5' : '1';
  btnCloseTrip.style.cursor = data.trip_status !== 'trip_closed' ? 'not-allowed' : 'pointer';
}

function renderChatMessages(comments) {
  const container = document.getElementById('chatMessagesContainer');
  const noMessages = document.getElementById('noMessages');
  
  if (!comments || comments.length === 0) {
    noMessages.style.display = 'block';
    container.querySelectorAll('.chat-message').forEach(msg => msg.remove());
    return;
  }
  
  noMessages.style.display = 'none';
  container.innerHTML = '';
  
  comments.forEach(comment => {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'chat-message';
    
    const senderName = comment.sender_type === 'admin' ? 'Admin' : 'Driver';
    const timestamp = new Date(comment.created_at).toLocaleString('en-US', {
      month: 'short',
      day: 'numeric',
      hour: 'numeric',
      minute: 'numeric',
      hour12: true
    });
    
    messageDiv.innerHTML = `
      <div class="chat-message-header">
        <span class="chat-message-sender">${senderName}</span>
        <span class="chat-message-time">${timestamp}</span>
      </div>
      <div class="chat-message-content">${comment.comment}</div>
    `;
    
    container.appendChild(messageDiv);
  });
  
  container.scrollTop = container.scrollHeight;
}

function renderTimeline(data) {
  const container = document.getElementById('timelineContainer');
  container.innerHTML = '';
  
  const statusOrder = [
    'trip_requested',
    'trip_confirmed',
    'reached_loading_point',
    'upload_lr',
    'in_transit',
    'reached_unloading_point',
    'unloading_completed',
    'pod_pending',
    'pod_received_at_office',
    'trip_closed'
  ];
  
  // Find current status index
  const currentStatusIndex = statusOrder.indexOf(data.trip_status);
  
  // Show current dot at NEXT stage (unless at final stage)
  let displayCurrentIndex = currentStatusIndex + 1;
  
  // Boundary checks
  if (displayCurrentIndex >= statusOrder.length) {
    displayCurrentIndex = statusOrder.length - 1; // Stay at last stage
  }
  
  statusOrder.forEach((status, index) => {
    let isCompleted = index <= currentStatusIndex;
    let isCurrent = index === displayCurrentIndex;
    let isPending = index > displayCurrentIndex;
    
    // For final stage, everything is completed
    if (data.trip_status === 'trip_closed') {
      isCompleted = true;
      isCurrent = false;
      isPending = false;
    }
    
    const timelineItem = createTimelineItem(status, isCompleted, isCurrent, isPending, data);
    container.appendChild(timelineItem);
  });
}

function createTimelineItem(status, isCompleted, isCurrent, isPending, data) {
  const timelineItem = document.createElement('div');
  timelineItem.className = 'timeline-item';
  
  let dotClass = 'pending';
  let mainClass = 'pending';
  
  if (isCompleted) {
    dotClass = 'completed';
    mainClass = 'completed';
  } else if (isCurrent) {
    dotClass = 'current';
    mainClass = 'current';
  }
  
  const statusInfo = getStatusInfo(status, data);
  
  let fileButton = '';
  if (statusInfo.hasFile && statusInfo.fileUrl) {
    fileButton = `
      <button class="view-file-btn" onclick="window.open('${statusInfo.fileUrl}', '_blank')" title="View ${statusInfo.fileName || 'document'}">
        <i class="fas fa-file-pdf"></i> View Document
      </button>
    `;
  }

  // If this is POD stage, optionally show Tracking Details button when image URL available
  let trackingButton = '';
  const trackingUrl = data.tracking_details_image || data.tracking_image || data.tracking_details_image_url || data.tracking_image_url;
  if (status === 'pod_uploaded' && trackingUrl) {
    trackingButton = `
      <button class="view-file-btn" style="background:#f3f4f6;color:#111;border-color:#e5e7eb;margin-left:8px;" onclick="showTrackingImageModal('${trackingUrl}')" title="View Tracking Details">
        <i class="fas fa-image" style="color:#6b7280"></i> Tracking Details
      </button>
    `;
  }
  
  // Add "Next Action" indicator for current stage
  let actionIndicator = '';
  if (isCurrent) {
    actionIndicator = `<div style="font-size: 12px; color: var(--primary); font-weight: 600; margin-top: 4px;"></div>`;
  }
  
  timelineItem.innerHTML = `
    <div class="timeline-dot ${dotClass}">
      <i class="fas ${statusInfo.icon}"></i>
    </div>
    <div class="timeline-content">
      <div class="timeline-main ${mainClass}">${statusInfo.title}</div>
      <div class="timeline-sub">${statusInfo.description}</div>
      ${fileButton}
      ${trackingButton}
      ${actionIndicator}
    </div>
    <div class="timeline-time">${statusInfo.timestamp}</div>
  `;
  
  return timelineItem;
}

function getStatusInfo(status, data) {
  const formatTimestamp = (timestampStr) => {
    if (!timestampStr) return 'Pending';
    try {
      return new Date(timestampStr).toLocaleString('en-US', { 
        month: 'short', 
        day: 'numeric', 
        hour: 'numeric', 
        minute: 'numeric',
        hour12: true 
      });
    } catch (e) {
      return 'Pending';
    }
  };

  const statusConfig = {
    trip_requested: {
      icon: 'fa-clipboard-check',
      title: 'Trip Requested',
      description: 'Trip booking requested',
      timestamp: formatTimestamp(data.pending_at),
      hasFile: false
    },
    trip_confirmed: {
      icon: 'fa-check-circle',
      title: 'Trip Confirmed',
      description: 'Trip booking confirmed by vendor',
      timestamp: formatTimestamp(data.assigned_at),
      hasFile: false
    },
    reached_loading_point: {
      icon: 'fa-box',
      title: 'Reached at Loading point',
      description: 'Cargo reached loading point',
      timestamp: formatTimestamp(data.loaded_at),
      hasFile: false
    },
    upload_lr: {
      icon: 'fa-file-invoice',
      title: 'Upload LR',
      description: 'Loading receipt document uploaded',
      timestamp: formatTimestamp(data.lr_uploaded_at),
      hasFile: !!data.lr_document,
      fileUrl: data.lr_document,
      fileName: data.lr_document_name
    },
    in_transit: {
      icon: 'fa-truck',
      title: 'In transit',
      description: 'Cargo in transit to destination',
      timestamp: formatTimestamp(data.in_transit_at),
      hasFile: false
    },
    reached_unloading_point: {
      icon: 'fa-box-open',
      title: 'Reached at unloading point',
      description: 'Cargo reached unloading point at destination',
      timestamp: formatTimestamp(data.unloading_at),
      hasFile: false
    },
    unloading_completed: {
      icon: 'fa-check-double',
      title: 'Unloading completed',
      description: 'Unloading process completed',
      timestamp: formatTimestamp(data.unloading_at),
      hasFile: false
    },
    pod_pending: {
      icon: 'fa-clock',
      title: 'POD status - Pending',
      description: 'Proof of delivery pending',
      timestamp: formatTimestamp(data.pod_uploaded_at),
      hasFile: false
    },
    pod_received_at_office: {
      icon: 'fa-building',
      title: 'POD status - received at rotra office',
      description: 'POD received at office',
      timestamp: formatTimestamp(data.pod_received_at),
      hasFile: !!data.pod_document,
      fileUrl: data.pod_document,
      fileName: data.pod_document_name
    },
    trip_closed: {
      icon: 'fa-check-circle',
      title: 'Trip closed',
      description: 'Trip completed successfully',
      timestamp: formatTimestamp(data.payment_completed_at),
      hasFile: false
    }
  };
  
  return statusConfig[status] || { 
    icon: 'fa-circle', 
    title: status, 
    description: '', 
    timestamp: 'Pending', 
    hasFile: false 
  };
}

function closeSidebar() {
  const sidebar = document.getElementById('profileSidebar');
  const overlay = document.getElementById('sidebarOverlay');
  
  sidebar.classList.remove('open');
  overlay.classList.remove('show');
  
  document.querySelectorAll('.clickable-row').forEach(r => r.classList.remove('selected'));
  currentTripId = null;
}

function updateTripStatus() {
  if (!currentTripId) {
    showToast('No trip selected', 'error');
    return;
  }
  
  // Get selected status from dropdown
  const statusSelect = document.getElementById('statusSelect');
  const selectedStatus = statusSelect.value;
  
  if (!selectedStatus) {
    showToast('Please select a status to update', 'error');
    return;
  }
  
  // Get current status
  const currentRow = document.querySelector(`[data-trip-id="${currentTripId}"]`);
  const currentStatus = currentRow ? currentRow.dataset.tripStatus : '';
  
  // Status display names
  const statusNames = {
    'trip_requested': 'Trip Requested',
    'trip_confirmed': 'Trip Confirmed',
    'reached_loading_point': 'Reached at Loading point',
    'upload_lr': 'Upload LR',
    'in_transit': 'In transit',
    'reached_unloading_point': 'Reached at unloading point',
    'unloading_completed': 'Unloading completed',
    'pod_pending': 'POD status - Pending',
    'pod_received_at_office': 'POD status - received at rotra office',
    'trip_closed': 'Trip closed'
  };
  
  // Check if status is same as current
  if (selectedStatus === currentStatus) {
    showToast('Trip is already at this status', 'error');
    return;
  }
  
  const selectedStatusName = statusNames[selectedStatus] || selectedStatus;
  const confirmMessage = `Are you sure you want to update the trip status from "${statusNames[currentStatus] || currentStatus}" to "${selectedStatusName}"?`;
  
  if (!confirm(confirmMessage)) {
    return;
  }
  
  // Check for POD document if trying to set to pod_received_at_office
  if (selectedStatus === 'pod_received_at_office') {
    // We'll check this on the backend, but show a warning
    const podCheck = confirm('Note: POD document must be uploaded. Continue?');
    if (!podCheck) {
      return;
    }
  }
  
  // Proceed with status update
  proceedWithStatusUpdate(selectedStatus);
}

function proceedWithStatusUpdate(newStatus, holdReason = null) {
  if (!currentTripId) {
    showToast('No trip selected', 'error');
    return;
  }
  
  const requestBody = {
    'new_status': newStatus
  };
  
  if (holdReason) {
    requestBody['hold_reason'] = holdReason;
  }
  
  fetch(`/api/trip/${currentTripId}/update-status/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrftoken
    },
    body: JSON.stringify(requestBody)
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      let message = result.message || 'Status updated successfully';
      let newStatus = result.new_status;
      let newStatusDisplay = result.new_status_display;

      // Update table row
      updateTableRow(currentTripId, newStatus, newStatusDisplay);
      showToast(message, 'success');
      
      // Reset dropdown
      const statusSelect = document.getElementById('statusSelect');
      if (statusSelect) {
        statusSelect.value = '';
      }
      
      // Refresh sidebar to update timeline
      setTimeout(() => {
        loadTripDetails(currentTripId);
      }, 300);
      
    } else {
      if (result.requires_lr_upload) {
        showToast('Please upload LR document before updating to LR Uploaded status', 'error');
        // Optionally show LR upload modal
        showLRUploadModal();
      } else if (result.requires_pod_upload) {
        showToast('Please upload POD document before updating to POD Uploaded status', 'error');
        // Optionally show POD upload modal
        showPODUploadModal();
      } else {
        showToast('Error: ' + result.error, 'error');
      }
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('Failed to update trip status', 'error');
  });
}

function showHoldCompletedModal() {
  // Create payment completion modal
  let modal = document.getElementById('paymentCompleteModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'paymentCompleteModal';
    modal.className = 'hold-modal';
    modal.innerHTML = `
      <div class="hold-modal-content">
        <div class="lr-modal-header">
          <h3>Complete Payment</h3>
          <button class="close-payment-modal">&times;</button>
        </div>
        <div style="margin-bottom: 12px; color: #374151;">
          <div style="display:flex; gap:12px; align-items:center; margin-bottom:8px;">
            <div style="flex:1;">Expected (before adjustment)</div>
            <div id="pcBeforeAmount" style="font-weight:700;"></div>
          </div>
          
          <!-- Holding Charges Section -->
          <div id="pcHoldingChargesSection" style="margin-top:12px; padding:12px; background:#f0fdf4; border-radius:6px; display:none;">
            <div style="display:flex; gap:12px; align-items:center; margin-bottom:8px;">
              <div style="flex:1; font-weight:600; color:#16a34a;">Holding Charges</div>
              <div id="pcHoldingChargesAmount" style="font-weight:700; color:#16a34a;"></div>
            </div>
            <div style="font-size:12px; color:#6b7280; margin-top:8px;">Additional charges added during the trip.</div>
          </div>
          
          <!-- TDS Deduction Section -->
          <div id="pcTDSSection" style="margin-top:12px; padding:12px; background:#fef2f2; border-radius:6px; display:none;">
            <div style="display:flex; gap:12px; align-items:center; margin-bottom:8px;">
              <div style="flex:1; font-weight:600; color:#dc2626;">TDS Rate</div>
              <div id="pcTDSRate" style="font-weight:700;"></div>
            </div>
            <div style="display:flex; gap:12px; align-items:center; margin-bottom:8px;">
              <div style="flex:1; font-weight:600; color:#dc2626;">TDS Deduction</div>
              <div id="pcTDSAmount" style="font-weight:700; color:#dc2626;"></div>
            </div>
            <div style="font-size:12px; color:#6b7280; margin-top:8px;">TDS (Tax Deducted at Source) will be deducted from the final payment.</div>
          </div>
          
          <div style="display:flex; gap:12px; align-items:center; margin-bottom:8px; margin-top:12px;">
            <div style="flex:1;">Adjustment (+/-)</div>
            <input id="pcAdjustment" type="number" step="0.01" value="0.00" style="width:120px; padding:8px; border:1px solid #d1d5db; border-radius:6px; text-align:right;">
          </div>
          <div style="display:flex; gap:12px; align-items:center; margin-bottom:8px;">
            <div style="flex:1; font-weight:600; color:#16a34a;">Confirmed Total (After TDS)</div>
            <div id="pcConfirmedAmount" style="font-weight:800; color:#16a34a;"></div>
          </div>
          <div id="pcAdjustmentReasonSection" style="margin-top:12px; display:none;">
            <label style="display:block; margin-bottom:8px; font-weight:500; color:#374151;">Adjustment Reason (required for increase/decrease)</label>
            <textarea id="pcAdjustmentReason" rows="3" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; resize:vertical;" placeholder="Explain why the payment is being adjusted..."></textarea>
          </div>
          <div style="font-size:13px; color:#6b7280; margin-top:8px;">If you increase or decrease the amount, please provide a reason.</div>
        </div>
        <div class="modal-actions">
          <button class="btn-cancel" id="pcCancel">Cancel</button>
          <button id="pcConfirm" style="padding: 10px 18px; background: #16a34a; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Confirm Payment</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);

    // Event listeners
    document.querySelector('#paymentCompleteModal .close-payment-modal').addEventListener('click', closePaymentCompleteModal);
    document.querySelector('#paymentCompleteModal #pcCancel').addEventListener('click', closePaymentCompleteModal);
    document.querySelector('#paymentCompleteModal #pcAdjustment').addEventListener('input', function() {
      updateConfirmedAmountDisplay();
      // Show/hide reason field based on adjustment (check in paise to avoid floating-point issues)
      const adj = parseFloat(this.value || 0);
      const adjInPaise = Math.round(adj * 100);
      const reasonSection = document.getElementById('pcAdjustmentReasonSection');
      const reasonField = document.getElementById('pcAdjustmentReason');
      if (adjInPaise !== 0) {
        reasonSection.style.display = 'block';
        reasonField.required = true;
      } else {
        reasonSection.style.display = 'none';
        reasonField.required = false;
        reasonField.value = ''; // Clear the reason field when adjustment is 0
      }
    });
    document.querySelector('#paymentCompleteModal #pcConfirm').addEventListener('click', submitConfirmedPayment);
  }

  // Load payment details and show modal
  fetch(`/api/payment/${currentTripId}/details/`)
    .then(r => r.json())
    .then(result => {
      if (!result.success) {
        showToast('Unable to fetch payment details', 'error');
        return;
      }
      const data = result.data || {};
      const firstHalf = parseFloat(data.first_half_payment || 0);
      const secondHalf = parseFloat(data.second_half_payment || 0);
      const beforeAmount = parseFloat(data.before_amount) || (firstHalf > 0 ? secondHalf : parseFloat(data.final_payment || 0));
      
      // Get TDS details
      const applyTDS = data.apply_tds || false;
      const tdsRate = parseFloat(data.tds_rate || 2);
      const tdsAmount = parseFloat(data.tds_amount || 0);
      
      // Calculate confirmed amount after TDS
      let netAfterTDS = beforeAmount - tdsAmount;
      
      // Check if there's an adjustment
      const confirmed = parseFloat(data.confirmed_amount) || netAfterTDS;

      // populate fields
      document.getElementById('pcBeforeAmount').textContent = `₹${beforeAmount.toLocaleString('en-IN', {minimumFractionDigits:2})}`;
      
      // Show/hide and populate TDS section
      const tdsSection = document.getElementById('pcTDSSection');
      if (applyTDS && tdsAmount > 0) {
        tdsSection.style.display = 'block';
        document.getElementById('pcTDSRate').textContent = `${tdsRate}%`;
        document.getElementById('pcTDSAmount').textContent = `₹${tdsAmount.toLocaleString('en-IN', {minimumFractionDigits:2})}`;
      } else {
        tdsSection.style.display = 'none';
      }
      
      const adjInput = document.getElementById('pcAdjustment');
      adjInput.value = (confirmed - netAfterTDS).toFixed(2);
      document.getElementById('pcConfirmedAmount').textContent = `₹${confirmed.toLocaleString('en-IN', {minimumFractionDigits:2})}`;

      // store in modal dataset for later
      modal.dataset.beforeAmount = beforeAmount;
      modal.dataset.tdsAmount = tdsAmount;
      modal.dataset.currentConfirmed = confirmed;

      // Show/hide reason field
      const adj = parseFloat(adjInput.value || 0);
      const adjInPaise = Math.round(adj * 100);
      const reasonSection = document.getElementById('pcAdjustmentReasonSection');
      const reasonField = document.getElementById('pcAdjustmentReason');
      if (adjInPaise !== 0) {
        reasonSection.style.display = 'block';
        reasonField.value = data.payment_adjustment_reason || '';
      } else {
        reasonSection.style.display = 'none';
        reasonField.value = '';
      }

      modal.style.display = 'flex';
    })
    .catch(err => {
      console.error(err);
      showToast('Failed to load payment details', 'error');
    });
}

function submitConfirmedPayment() {
  if (!currentTripId) return showToast('No trip selected', 'error');
  const modal = document.getElementById('paymentCompleteModal');
  if (!modal) return;
  const beforeAmount = parseFloat(modal.dataset.beforeAmount || 0);
  const tdsAmount = parseFloat(modal.dataset.tdsAmount || 0);
  const adj = parseFloat(document.getElementById('pcAdjustment').value || 0);
  
  // Calculate confirmed: (Before - TDS) + Adjustment
  const netAfterTDS = beforeAmount - tdsAmount;
  const confirmed = (netAfterTDS + adj).toFixed(2);
  
  // Get adjustment reason
  const adjustmentReason = document.getElementById('pcAdjustmentReason').value.trim();
  
  // Check if adjustment is significant (more than 1 paisa/cent to account for floating-point)
  // Convert to paise (multiply by 100) and check if it's 0 in paise
  const adjInPaise = Math.round(adj * 100);
  if (adjInPaise !== 0 && !adjustmentReason) {
    showToast('Please provide a reason for the payment adjustment', 'error');
    return;
  }

  // send to backend
  fetch(`/api/payment/${currentTripId}/mark-final-payment-paid/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrftoken
    },
    body: JSON.stringify({ 
      confirmed_amount: confirmed,
      adjustment_reason: adjInPaise !== 0 ? adjustmentReason : null
    })
  })
  .then(r => r.json())
  .then(result => {
    if (result.success) {
      showToast(result.message || 'Payment completed', 'success');
      closePaymentCompleteModal();
      // update UI: update row and sidebar
      updateTableRow(currentTripId, 'trip_closed', 'Trip Closed');
      setTimeout(() => {
        loadTripDetails(currentTripId);
      }, 300);
    } else if (result.error === 'adjustment_reason_required') {
      showToast(result.message, 'error');
    } else {
      showToast('Error: ' + (result.error || 'Failed to process payment'), 'error');
    }
  })
  .catch(err => {
    console.error(err);
    showToast('Failed to process payment', 'error');
  });
}

function closeHoldCompletedModal() {
  const modal = document.getElementById('paymentCompleteModal');
  if (modal) modal.style.display = 'none';
}

function closePaymentCompleteModal() {
  const modal = document.getElementById('paymentCompleteModal');
  if (modal) modal.style.display = 'none';
}

function updateConfirmedAmountDisplay(e) {
  const modal = document.getElementById('paymentCompleteModal');
  if (!modal) return;
  const beforeAmount = parseFloat(modal.dataset.beforeAmount || 0);
  const tdsAmount = parseFloat(modal.dataset.tdsAmount || 0);
  const adj = parseFloat(document.getElementById('pcAdjustment').value || 0);
  
  // Calculate confirmed amount: (Before Amount - TDS) + Adjustment
  const netAfterTDS = beforeAmount - tdsAmount;
  const confirmed = netAfterTDS + adj;
  
  document.getElementById('pcConfirmedAmount').textContent = `₹${confirmed.toLocaleString('en-IN',{minimumFractionDigits:2})}`;
}

function showHoldReasonModal(selectedStatus) {
  // Create modal if it doesn't exist
  let modal = document.getElementById('holdReasonModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'holdReasonModal';
    modal.className = 'hold-modal';
    modal.innerHTML = `
      <div class="hold-modal-content">
        <div class="lr-modal-header">
          <h3>Hold Trip - Reason Required</h3>
          <button class="close-hold-reason-modal">&times;</button>
        </div>
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Please provide a reason for holding this trip:</label>
          <textarea id="holdReasonInput" rows="4" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;" placeholder="Enter reason for hold..."></textarea>
        </div>
        <div class="modal-actions">
          <button class="btn-cancel" id="btnCancelHoldReason">Cancel</button>
          <button id="btnSubmitHold" style="padding: 10px 20px; background: #d97706; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
            Submit Hold
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    
    // Event listeners
    document.querySelector('#holdReasonModal .close-hold-reason-modal').addEventListener('click', closeHoldReasonModal);
    document.querySelector('#holdReasonModal #btnCancelHoldReason').addEventListener('click', closeHoldReasonModal);
    document.querySelector('#holdReasonModal #btnSubmitHold').addEventListener('click', () => {
      const reason = document.getElementById('holdReasonInput').value.trim();
      if (!reason) {
        showToast('Please provide a reason for holding the trip', 'error');
        return;
      }
      closeHoldReasonModal();
      proceedWithStatusUpdate(selectedStatus, reason);
    });
  }
  
  // Clear previous reason
  const reasonInput = document.getElementById('holdReasonInput');
  if (reasonInput) {
    reasonInput.value = '';
  }
  
  modal.style.display = 'flex';
  
  // Focus on textarea
  setTimeout(() => {
    const reasonInput = document.getElementById('holdReasonInput');
    if (reasonInput) {
      reasonInput.focus();
    }
  }, 100);
}

function closeHoldReasonModal() {
  const modal = document.getElementById('holdReasonModal');
  if (modal) {
    modal.style.display = 'none';
  }
}

function addComment() {
  if (!currentTripId) {
    showToast('No trip selected', 'error');
    return;
  }
  
  const commentInput = document.getElementById('commentInput');
  const comment = commentInput.value.trim();
  
  if (!comment) {
    showToast('Please enter a comment', 'error');
    return;
  }
  
  fetch(`/api/trip/${currentTripId}/add-comment/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrftoken
    },
    body: JSON.stringify({ comment: comment })
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      showToast('Comment added successfully', 'success');
      commentInput.value = '';
      loadTripDetails(currentTripId);
    } else {
      showToast('Error: ' + result.error, 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('Failed to add comment', 'error');
  });
}

function addHoldingCharges() {
  if (!currentTripId) {
    showToast('No trip selected', 'error');
    return;
  }
  
  // Show modal for holding charges
  const modal = document.getElementById('holdingChargesModal');
  if (!modal) {
    createHoldingChargesModal();
  }
  document.getElementById('holdingChargesModal').style.display = 'flex';
}

function createHoldingChargesModal() {
  const modalHTML = `
  <div class="holding-charges-modal" id="holdingChargesModal">
    <div class="modal-content" style="width: 90%; max-width: 500px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">Add Holding Charges</h3>
        <button class="close-hc-modal" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Amount (₹)</label>
        <input type="number" id="hcAmount" placeholder="Enter amount" min="0" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box;">
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Trip Stage</label>
        <select id="hcTripStage" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box;">
          <option value="trip_requested">Trip Requested</option>
          <option value="trip_confirmed">Trip Confirmed</option>
          <option value="reached_loading_point">Reached at Loading point</option>
          <option value="upload_lr">Upload LR</option>
          <option value="in_transit">In transit</option>
          <option value="reached_unloading_point">Reached at unloading point</option>
          <option value="unloading_completed">Unloading completed</option>
          <option value="pod_pending">POD status - Pending</option>
          <option value="pod_received_at_office">POD status - received at rotra office</option>
          <option value="trip_closed">Trip closed</option>
        </select>
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Reason</label>
        <textarea id="hcReason" placeholder="Enter reason for holding charges" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; min-height: 80px; resize: vertical;"></textarea>
      </div>
      
      <div id="hcChargesList" style="margin-bottom: 15px; max-height: 200px; overflow-y: auto; border: 1px solid #f3f4f6; border-radius: 6px; padding: 10px; display: none;">
        <h4 style="margin-top: 0; margin-bottom: 10px; font-size: 13px;">Recent Charges on This Trip:</h4>
        <div id="hcChargesContent"></div>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button id="btnSubmitHC" style="flex: 1; padding: 10px; background: #16a34a; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Add Charges</button>
        <button class="close-hc-modal" style="flex: 1; padding: 10px; background: #e5e7eb; color: #374151; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Cancel</button>
      </div>
    </div>
  </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  // Add modal styles if not already added
  if (!document.getElementById('hcModalStyles')) {
    const style = document.createElement('style');
    style.id = 'hcModalStyles';
    style.textContent = `
      .holding-charges-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      
      .holding-charges-modal .modal-content {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }
    `;
    document.head.appendChild(style);
  }
  
  document.querySelectorAll('.close-hc-modal').forEach(btn => {
    btn.addEventListener('click', closeHoldingChargesModal);
  });
  
  document.getElementById('btnSubmitHC').addEventListener('click', submitHoldingCharges);
  document.getElementById('hcTripStage').value = window.currentTripStatus || 'pending';
}

function closeHoldingChargesModal() {
  const modal = document.getElementById('holdingChargesModal');
  if (modal) {
    modal.style.display = 'none';
    document.getElementById('hcAmount').value = '';
    document.getElementById('hcReason').value = '';
  }
}

function submitHoldingCharges() {
  const amount = document.getElementById('hcAmount').value.trim();
  const reason = document.getElementById('hcReason').value.trim();
  const tripStage = document.getElementById('hcTripStage').value;
  
  if (!amount) {
    showToast('Please enter the amount', 'error');
    return;
  }
  
  if (!reason) {
    showToast('Please enter the reason', 'error');
    return;
  }
  
  if (isNaN(amount) || parseFloat(amount) < 0) {
    showToast('Please enter a valid positive amount', 'error');
    return;
  }
  
  const data = {
    amount: parseFloat(amount),
    reason: reason,
    trip_stage: tripStage
  };
  
  fetch(`/api/trip/${currentTripId}/add-holding-charges/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrftoken
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      showToast(result.message, 'success');
      closeHoldingChargesModal();
      loadTripDetails(currentTripId);
    } else {
      showToast('Error: ' + (result.error || 'Failed to add holding charges'), 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('Failed to add holding charges', 'error');
  });
}

function showViewHoldingChargesModal(chargesList) {
  // Create and show modal with list of all charges
  const modal = document.getElementById('allChargesModal') || createAllChargesModal();
  const chargesContainer = document.getElementById('allChargesContent');
  
  chargesContainer.innerHTML = '';
  
  if (!chargesList || chargesList.length === 0) {
    chargesContainer.innerHTML = '<p style="text-align: center; color: #9ca3af;">No holding charges added yet</p>';
  } else {
    chargesList.forEach((charge, index) => {
      const chargeDiv = document.createElement('div');
      chargeDiv.style.cssText = 'border-bottom: 1px solid #f3f4f6; padding: 10px 0; font-size: 13px;';
      chargeDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <strong>₹${parseFloat(charge.amount).toLocaleString('en-IN', {minimumFractionDigits: 2})}</strong>
          <span style="color: #6b7280;">${charge.trip_stage_display}</span>
        </div>
        <div style="color: #6b7280; margin-bottom: 5px;">${charge.created_at_display}</div>
        <div style="color: #374151; margin-bottom: 3px;"><strong>Reason:</strong> ${charge.reason}</div>
        <div style="color: #9ca3af; font-size: 12px;">Added by: ${charge.added_by}</div>
      `;
      chargesContainer.appendChild(chargeDiv);
    });
  }
  
  modal.style.display = 'flex';
}

function createAllChargesModal() {
  const modalHTML = `
  <div class="all-charges-modal" id="allChargesModal">
    <div class="modal-content" style="width: 90%; max-width: 600px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">Holding Charges History</h3>
        <button class="close-all-charges-modal" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
      </div>
      
      <div id="allChargesContent" style="margin-bottom: 15px; max-height: 400px; overflow-y: auto;"></div>
      
      <div style="display: flex; gap: 10px;">
        <button class="close-all-charges-modal" style="flex: 1; padding: 10px; background: #e5e7eb; color: #374151; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Close</button>
      </div>
    </div>
  </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  if (!document.getElementById('acModalStyles')) {
    const style = document.createElement('style');
    style.id = 'acModalStyles';
    style.textContent = `
      .all-charges-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      
      .all-charges-modal .modal-content {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }
    `;
    document.head.appendChild(style);
  }
  
  document.querySelectorAll('.close-all-charges-modal').forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById('allChargesModal').style.display = 'none';
    });
  });
  
  return document.getElementById('allChargesModal');
}

// Tracking image modal helpers
function showTrackingImageModal(url) {
  if (!url) {
    showToast('No tracking image available', 'error');
    return;
  }

  const modal = document.getElementById('trackingImageModal') || createTrackingModal();
  const img = document.getElementById('trackingImageContentImg');
  if (img) {
    img.src = url;
  }
  modal.style.display = 'flex';
}

function createTrackingModal() {
  const modalHTML = `
  <div class="tracking-image-modal" id="trackingImageModal">
    <div class="modal-content" style="width: 95%; max-width: 720px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <h3 style="margin:0;">Tracking Details</h3>
        <button class="close-tracking-modal" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
      </div>
      <div style="text-align:center;">
        <img id="trackingImageContentImg" src="" alt="Tracking Image" style="max-width:100%; height:auto; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.12);"/>
      </div>
      <div style="display:flex; gap:10px; margin-top:12px; justify-content:flex-end;">
        <button class="close-tracking-modal" style="padding:10px; background:#e5e7eb; color:#374151; border:none; border-radius:6px; cursor:pointer;">Close</button>
      </div>
    </div>
  </div>
  `;

  document.body.insertAdjacentHTML('beforeend', modalHTML);

  if (!document.getElementById('trackingModalStyles')) {
    const style = document.createElement('style');
    style.id = 'trackingModalStyles';
    style.textContent = `
      .tracking-image-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); align-items: center; justify-content: center; z-index: 10000; }
      .tracking-image-modal .modal-content { background: white; border-radius: 8px; padding: 16px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); }
    `;
    document.head.appendChild(style);
  }

  document.querySelectorAll('.close-tracking-modal').forEach(btn => {
    btn.addEventListener('click', () => {
      const m = document.getElementById('trackingImageModal');
      if (m) m.style.display = 'none';
    });
  });

  return document.getElementById('trackingImageModal');
}

function closeTrip() {
  if (!currentTripId) {
    showToast('No trip selected', 'error');
    return;
  }
  
  if (!confirm('Are you sure you want to close this trip? This action cannot be undone.')) {
    return;
  }
  
  fetch(`/api/trip/${currentTripId}/close/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken
    }
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      showToast('Trip closed successfully', 'success');
      closeSidebar();
      location.reload();
    } else {
      showToast('Error: ' + result.error, 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('Failed to close trip', 'error');
  });
}

function updateTableRow(tripId, newStatus, newStatusDisplay) {
  const row = document.querySelector(`[data-trip-id="${tripId}"]`);
  if (row) {
    const statusBadge = row.querySelector('.status-badge');
    if (statusBadge) {
      statusBadge.textContent = newStatusDisplay;
      statusBadge.className = 'status-badge status-' + newStatus;
    }
  }
}

// Current location update functionality
document.addEventListener('DOMContentLoaded', function () {
  const locationText = document.getElementById('currentLocationText');
  const locationInput = document.getElementById('currentLocationInput');
  const locationEditMode = document.getElementById('locationEditMode');
  const btnEdit = document.getElementById('btnEditLocation');
  const btnSave = document.getElementById('btnSaveLocation');
  const btnCancel = document.getElementById('btnCancelEditLocation');

  // Initial value - this will be updated when loadTripDetails is called
  locationText.textContent = 'Not updated';
  document.getElementById('currentLocationTimestamp').textContent = '-';

  // Switch to edit mode
  btnEdit.addEventListener('click', function () {
    if (!currentTripId) {
      showToast('No trip selected. Please select a trip first.', 'error');
      return;
    }
    
    locationInput.value = locationText.textContent === 'Not updated' ? '' : locationText.textContent;
    locationEditMode.classList.add('active');
    btnEdit.style.display = 'none';
    locationInput.focus();
  });

  // Cancel edit mode
  if (btnCancel) {
    btnCancel.addEventListener('click', function () {
      locationEditMode.classList.remove('active');
      btnEdit.style.display = 'block';
      locationInput.value = '';
    });
  }

  // Save updated location
  btnSave.addEventListener('click', async function () {
    if (!currentTripId) {
      showToast('No trip selected. Please select a trip first.', 'error');
      return;
    }
    
    const newLocation = locationInput.value.trim();
    if (!newLocation) {
      showToast('Please enter a location', 'error');
      return;
    }

    try {
      // Get CSRF token
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || csrftoken;
      
      btnSave.disabled = true;
      btnSave.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
      
      const response = await fetch(`/api/trip/${currentTripId}/update-location/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ location: newLocation })
      });

      // First check if response is JSON
      const contentType = response.headers.get("content-type");
      if (!contentType || !contentType.includes("application/json")) {
        // Handle HTML error response (like 404 page)
        throw new Error('Server returned non-JSON response. Check the API endpoint.');
      }

      const data = await response.json();

      if (data.success) {
        locationText.textContent = data.location;
        
        // Use the formatted timestamp from the API response
        if (data.formatted_updated_at) {
          document.getElementById('currentLocationTimestamp').textContent = data.formatted_updated_at;
          document.getElementById('currentLocationSidebarTimestamp').textContent = data.formatted_updated_at;
        } else if (data.updated_at) {
          const updatedDate = new Date(data.updated_at);
          const formattedTime = updatedDate.toLocaleDateString('en-IN', {
            year: 'numeric',
            month: 'short',
            day: '2-digit'
          }) + ' ' + updatedDate.toLocaleTimeString('en-IN', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
          });
          document.getElementById('currentLocationTimestamp').textContent = formattedTime;
          document.getElementById('currentLocationSidebarTimestamp').textContent = formattedTime;
        }
        
        showToast('Location updated successfully', 'success');
        
        // Back to display mode
        locationEditMode.classList.remove('active');
        btnEdit.style.display = 'block';
        btnSave.disabled = false;
        btnSave.innerHTML = '<i class="fas fa-check" style="margin-right: 4px;"></i> Save';
        locationInput.value = '';
      } else {
        showToast('Error: ' + (data.error || 'Failed to update location'), 'error');
        btnSave.disabled = false;
        btnSave.innerHTML = '<i class="fas fa-check" style="margin-right: 4px;"></i> Save';
      }
    } catch (error) {
      console.error('Error:', error);
      showToast('Error: ' + error.message, 'error');
      btnSave.disabled = false;
      btnSave.innerHTML = '<i class="fas fa-check" style="margin-right: 4px;"></i> Save';
    }
  });
});
</script>
</body>
</html>
{% endblock %}