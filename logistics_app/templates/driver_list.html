{% extends "admin_base.html" %}
{% load static %}
{% block title %}Driver Management{% endblock %}
{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Driver Management</title>

  <!-- Font Awesome -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Google Fonts: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <style>
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
      box-sizing: border-box;
    }
    
    .modal-content {
      background: white;
      border-radius: 12px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      position: relative;
    }
    
    .modal-header {
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
      padding: 20px 24px 0;
      border-radius: 12px 12px 0 0;
    }
    
    .modal-form { padding: 0 24px 24px; }

    .file-upload-area {
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      padding: 24px;
      text-align: center;
      background-color: #f9fafb;
      transition: all 0.3s ease;
      cursor: pointer;
      margin-top: 8px;
    }
    
    .file-upload-area:hover, .file-upload-area.dragover {
      border-color: #dc2626;
      background-color: #fef2f2;
    }
    
    .file-upload-area i {
      font-size: 32px;
      color: #dc2626;
      margin-bottom: 12px;
    }
    
    .file-upload-area p {
      margin: 0;
      color: #6b7280;
      font-size: 14px;
    }
    
    .browse-link {
      color: #dc2626;
      cursor: pointer;
      text-decoration: underline;
    }
    
    .file-name {
      display: block;
      margin-top: 8px;
      color: #374151;
      font-size: 14px;
      font-weight: 500;
    }

    .form-row {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .form-group {
      flex: 1;
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #374151;
      font-size: 14px;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    .required { color: #dc2626; }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
    }
    
    .save-btn {
      background: #dc2626;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .cancel-btn {
      background: #f9fafb;
      color: #6b7280;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }

    /* UPDATED SIDEBAR STYLES */
    #profileSidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: 320px;
      height: 100vh;
      background: white;
      box-shadow: -4px 0 15px rgba(0, 0, 0, 0.1);
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 1001;
      overflow-y: auto;
      -ms-overflow-style: none;
      scrollbar-width: none;
      display: flex;
      flex-direction: column;
    }

    #profileSidebar::-webkit-scrollbar {
      width: 0 !important;
    }

    .modal-content {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    
    .modal-content::-webkit-scrollbar {
      width: 0 !important;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .sidebar-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #111827;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      color: #6b7280;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    .close-btn:hover {
      background-color: #f3f4f6;
    }

    .profile-avatar {
      display: flex;
      justify-content: center;
      padding: 24px 20px 16px;
    }

    .avatar-circle {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 22px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .profile-info {
      text-align: center;
      padding: 0 20px 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .profile-name {
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin: 0 0 8px 0;
    }

    .profile-phone {
      font-size: 14px;
      color: #6b7280;
      margin: 0 0 4px 0;
    }

    .profile-id {
      font-size: 13px;
      color: #9ca3af;
      margin: 0;
    }

    .info-section {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .info-section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #111827;
      margin: 0 0 16px 0;
    }

    .info-section-title i {
      color: #6b7280;
      font-size: 16px;
    }

    .performance-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .performance-item:last-child {
      margin-bottom: 0;
    }

    .performance-label {
      font-size: 13px;
      color: #6b7280;
    }

    .performance-value {
      font-size: 13px;
      font-weight: 600;
      color: #16a34a;
    }

    .documents-section {
      padding: 20px;
      flex-grow: 1;
    }

    .document-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f3f4f6;
    }

    .document-item:last-child {
      border-bottom: none;
    }

    .document-name {
      font-size: 13px;
      color: #374151;
      font-weight: 500;
    }

    .document-status {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .document-status.uploaded {
      background-color: #dcfce7;
      color: #16a34a;
    }

    .document-status.not-uploaded {
      background-color: #fee2e2;
      color: #dc2626;
    }

    .document-status i {
      font-size: 10px;
    }

    .sidebar-actions {
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border-top: 1px solid #e5e7eb;
      background: white;
    }

    .sidebar-btn {
      width: 100%;
      padding: 12px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-view-history {
      background-color: #dc2626;
      color: white;
    }

    .btn-view-history:hover {
      background-color: #b91c1c;
    }

    .btn-edit {
      background-color: white;
      color: #374151;
      border: 1px solid #d1d5db;
    }

    .btn-edit:hover {
      background-color: #f9fafb;
    }

    .btn-deactivate {
      background-color: white;
      color: #dc2626;
      border: 1px solid #dc2626;
    }

    .btn-deactivate:hover {
      background-color: #fef2f2;
    }

    #sidebarOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
      z-index: 1000;
    }

    #sidebarOverlay.show {
      opacity: 1;
      visibility: visible;
    }
  </style>
</head>
<body>

<div class="dashboard">
  <!-- TOP BAR -->
  <div class="top-bar">
    <h2>Driver Management</h2>
    <div class="search-add-container">
      <input type="text" id="searchInput" placeholder="Search drivers..." class="search-input">
      <button class="add-button" id="openAddModal">+ Add Driver</button>
    </div>
  </div>

  <!-- TABLE -->
  <div class="table-card">
    <table id="driverTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Phone Number</th>
          <th>Owner</th>
          <th>Owner Phone</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if drivers %}
          {% for driver in drivers %}
          <tr class="clickable-row" data-driver-id="{{ driver.id }}"
              data-driver='{
                "id": {{ driver.id }},
                "name": "{{ driver.full_name|escapejs }}",
                "phone": "{{ driver.phone_number }}",
                "owner": "{{ driver.owner.full_name|escapejs }}",
                "ownerPhone": "{{ driver.owner.phone_number }}",
                "status": "{{ driver.get_status_display }}",
                "joinDate": "{{ driver.created_at|date:"M d, Y" }}",
                "hasPan": {% if driver.pan_document %}true{% else %}false{% endif %},
                "hasAadhar": {% if driver.aadhar_document %}true{% else %}false{% endif %},
                "hasRC": {% if driver.rc_document %}true{% else %}false{% endif %}
              }'>
            <td>{{ driver.full_name }}</td>
            <td>{{ driver.phone_number }}</td>
            <td>{{ driver.owner.full_name }}</td>
            <td>{{ driver.owner.phone_number }}</td>
            <td class="action-col">
              <div class="action-buttons">
                <button class="action-view" title="View"><i class="fas fa-eye"></i></button>
                <button class="action-edit" title="Edit"><i class="fas fa-edit"></i></button>
                <button class="action-delete" data-driver-id="{{ driver.id }}" title="Delete"><i class="fas fa-trash"></i></button>
              </div>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="5" style="text-align:center;padding:50px;color:#6b7280;">
              No drivers found. Click "Add Driver" to get started.
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>

    <!-- PAGINATION -->
    <div class="pagination-container">
      <div class="entries-per-page">
        <span>Show</span>
        <select id="entriesPerPage">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="25">25</option>
          <option value="50">50</option>
        </select>
        <span>entries</span>
      </div>
      <div class="pagination-info">
        Showing <span id="showingStart">0</span> to <span id="showingEnd">0</span> of <span id="totalEntries">0</span> entries
      </div>
      <div class="pagination-controls">
        <button id="prevPage">Previous</button>
        <span id="currentPageInfo">Page 1</span>
        <button id="nextPage">Next</button>
      </div>
    </div>
  </div>

  <!-- ADD DRIVER MODAL -->
  <div id="addModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Driver</h3>
        <button class="modal-close" id="closeAddModal">×</button>
      </div>

      <form id="addDriverForm" class="modal-form" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="form-group">
          <label>Full Name <span class="required">*</span></label>
          <input type="text" name="fullName" placeholder="Enter full name" required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Phone No <span class="required">*</span></label>
            <input type="tel" name="phoneNo" placeholder="Enter phone number" required>
          </div>
          <div class="form-group">
            <label>Choose Owner <span class="required">*</span></label>
            <select name="owner" required>
              <option value="" disabled selected>Select Owner</option>
              {% for vendor in vendors %}
                <option value="{{ vendor.id }}">{{ vendor.full_name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>PAN Document</label>
          <div class="file-upload-area" id="panUploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Drag & drop or <span class="browse-link" data-input="panDocument">Browse</span></p>
            <input type="file" id="panDocument" name="panDocument" accept=".pdf,.jpg,.jpeg,.png" style="display:none;">
            <span id="panFileName" class="file-name"></span>
          </div>
        </div>

        <div class="form-group">
          <label>Aadhar Document</label>
          <div class="file-upload-area" id="aadharUploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Drag & drop or <span class="browse-link" data-input="aadharDocument">Browse</span></p>
            <input type="file" id="aadharDocument" name="aadharDocument" accept=".pdf,.jpg,.jpeg,.png" style="display:none;">
            <span id="aadharFileName" class="file-name"></span>
          </div>
        </div>

        <div class="form-group">
          <label>License / RC Document</label>
          <div class="file-upload-area" id="rcUploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Drag & drop or <span class="browse-link" data-input="rcDocument">Browse</span></p>
            <input type="file" id="rcDocument" name="rcDocument" accept=".pdf,.jpg,.jpeg,.png" style="display:none;">
            <span id="rcFileName" class="file-name"></span>
          </div>
        </div>

        <div class="modal-actions">
          <button type="submit" class="save-btn">Save Driver</button>
          <button type="button" class="cancel-btn" id="cancelAddModal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- UPDATED PROFILE SIDEBAR -->
  <div id="profileSidebar">
    <div class="sidebar-header">
      <h3>Driver Profile</h3>
      <button class="close-btn" id="closeSidebar">×</button>
    </div>

    <div class="profile-avatar">
      <div class="avatar-circle" id="profileAvatar"></div>
    </div>

    <div class="profile-info">
      <h3 class="profile-name" id="profileName"></h3>
      <p class="profile-phone" id="profilePhone"></p>
      <p class="profile-id" id="profileId"></p>
    </div>

    <div class="info-section">
      <h4 class="info-section-title">
        <i class="fas fa-chart-line"></i>
        Performance
      </h4>
      <div class="performance-item">
        <span class="performance-label">Trips Completed</span>
        <span class="performance-value" id="tripsCompleted">0 trips</span>
      </div>
    </div>

    <div class="documents-section">
      <h4 class="info-section-title">
        <i class="fas fa-file-alt"></i>
        Documents
      </h4>
      <div class="document-item">
        <span class="document-name">Driving License</span>
        <div class="document-status" id="docLicense">
          <i class="fas fa-times"></i>
        </div>
      </div>
      <div class="document-item">
        <span class="document-name">Aadhar Card</span>
        <div class="document-status" id="docAadhar">
          <i class="fas fa-times"></i>
        </div>
      </div>
      <div class="document-item">
        <span class="document-name">PAN Card</span>
        <div class="document-status" id="docPan">
          <i class="fas fa-times"></i>
        </div>
      </div>
    </div>

    <div class="sidebar-actions">
      <button class="sidebar-btn btn-view-history">
        <i class="fas fa-history"></i>
        View Trip History
      </button>
      <button class="sidebar-btn btn-edit">
        <i class="fas fa-edit"></i>
        Edit
      </button>
      <button class="sidebar-btn btn-deactivate" id="toggleStatusBtn">
        <i class="fas fa-ban"></i>
        Deactivate
      </button>
    </div>
  </div>

  <div id="sidebarOverlay"></div>
</div>

<!-- Toastify -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  function showToast(text, type = 'info') {
    const colors = { success: '#16a34a', error: '#dc2626', info: '#2563eb', warning: '#d97706' };
    Toastify({ text, duration: 3500, close: true, gravity: "top", position: "right", backgroundColor: colors[type] }).showToast();
  }

  const tbody = document.querySelector('#driverTable tbody');
  const sidebar = document.getElementById('profileSidebar');
  const overlay = document.getElementById('sidebarOverlay');
  const closeSidebarBtn = document.getElementById('closeSidebar');
  const searchInput = document.getElementById('searchInput');
  const addModal = document.getElementById('addModal');
  const openAddModalBtn = document.getElementById('openAddModal');
  const closeAddModalBtn = document.getElementById('closeAddModal');
  const cancelAddModalBtn = document.getElementById('cancelAddModal');
  const addForm = document.getElementById('addDriverForm');

  const entriesSelect = document.getElementById('entriesPerPage');
  const showingStart = document.getElementById('showingStart');
  const showingEnd = document.getElementById('showingEnd');
  const totalEntries = document.getElementById('totalEntries');
  const prevBtn = document.getElementById('prevPage');
  const nextBtn = document.getElementById('nextPage');
  const currentPageInfo = document.getElementById('currentPageInfo');

  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  let currentDriverId = null;
  let currentPage = 1;
  let perPage = parseInt(entriesSelect.value, 10);
  let allRows = [];
  let filteredRows = [];

  // FILE UPLOAD HANDLING
  const fileFields = [
    { inputId: 'panDocument',     areaId: 'panUploadArea',     nameId: 'panFileName' },
    { inputId: 'aadharDocument',  areaId: 'aadharUploadArea',  nameId: 'aadharFileName' },
    { inputId: 'rcDocument',      areaId: 'rcUploadArea',      nameId: 'rcFileName' }
  ];

  fileFields.forEach(field => {
    const input = document.getElementById(field.inputId);
    const area = document.getElementById(field.areaId);
    const display = document.getElementById(field.nameId);

    if (!input || !area || !display) {
      console.error(`Missing element for ${field.inputId}`);
      return;
    }

    const updateFileName = () => {
      if (input.files && input.files[0]) {
        display.textContent = input.files[0].name;
        display.style.color = '#16a34a';
      } else {
        display.textContent = '';
        display.style.color = '';
      }
    };

    area.addEventListener('click', (e) => {
      e.stopPropagation();
      input.click();
    });

    input.addEventListener('change', updateFileName);

    area.addEventListener('dragover', e => {
      e.preventDefault();
      area.classList.add('dragover');
    });
    area.addEventListener('dragleave', () => area.classList.remove('dragover'));
    area.addEventListener('drop', e => {
      e.preventDefault();
      area.classList.remove('dragover');
      if (e.dataTransfer.files.length) {
        input.files = e.dataTransfer.files;
        updateFileName();
      }
    });
  });

  document.querySelectorAll('.browse-link').forEach(link => {
    link.addEventListener('click', (e) => {
      e.stopPropagation();
      const input = document.getElementById(link.dataset.input);
      if (input) input.click();
    });
  });

  function initRows() {
    allRows = Array.from(tbody.querySelectorAll('tr.clickable-row'));
    filteredRows = [...allRows];
    renderPage();
  }

  searchInput.addEventListener('input', () => {
    const term = searchInput.value.toLowerCase();
    filteredRows = allRows.filter(r => r.textContent.toLowerCase().includes(term));
    currentPage = 1;
    renderPage();
  });

  function getInitials(name) {
    const parts = name.trim().split(' ');
    if (parts.length >= 2) {
      return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }
    return name.substring(0, 2).toUpperCase();
  }

  function openSidebar(row) {
    const data = JSON.parse(row.dataset.driver);
    currentDriverId = data.id;

    // Update avatar with initials from backend data
    const avatarEl = document.getElementById('profileAvatar');
    avatarEl.textContent = getInitials(data.name);

    // Update profile info from backend data
    document.getElementById('profileName').textContent = data.name;
    document.getElementById('profilePhone').textContent = data.phone;
    document.getElementById('profileId').textContent = `Owner: ${data.owner}`;

    // Update performance from backend data
    document.getElementById('tripsCompleted').textContent = '0 trips';

    // Update documents from backend data
    const docLicense = document.getElementById('docLicense');
    const docAadhar = document.getElementById('docAadhar');
    const docPan = document.getElementById('docPan');

    // Driving License (using RC data from backend)
    if (data.hasRC) {
      docLicense.className = 'document-status uploaded';
      docLicense.innerHTML = '<i class="fas fa-check"></i>';
    } else {
      docLicense.className = 'document-status not-uploaded';
      docLicense.innerHTML = '<i class="fas fa-times"></i>';
    }

    // Aadhar from backend
    if (data.hasAadhar) {
      docAadhar.className = 'document-status uploaded';
      docAadhar.innerHTML = '<i class="fas fa-check"></i>';
    } else {
      docAadhar.className = 'document-status not-uploaded';
      docAadhar.innerHTML = '<i class="fas fa-times"></i>';
    }

    // PAN from backend
    if (data.hasPan) {
      docPan.className = 'document-status uploaded';
      docPan.innerHTML = '<i class="fas fa-check"></i>';
    } else {
      docPan.className = 'document-status not-uploaded';
      docPan.innerHTML = '<i class="fas fa-times"></i>';
    }

    // Update toggle button based on backend status
    const toggleBtn = document.getElementById('toggleStatusBtn');
    if (data.status === 'Active') {
      toggleBtn.innerHTML = '<i class="fas fa-ban"></i> Deactivate';
    } else {
      toggleBtn.innerHTML = '<i class="fas fa-check-circle"></i> Activate';
    }

    sidebar.style.transform = 'translateX(0)';
    overlay.classList.add('show');
    document.querySelectorAll('.clickable-row').forEach(r => r.style.backgroundColor = '');
    row.style.backgroundColor = '#f0f9ff';
  }

  function closeSidebar() {
    sidebar.style.transform = 'translateX(100%)';
    overlay.classList.remove('show');
    document.querySelectorAll('.clickable-row').forEach(r => r.style.backgroundColor = '');
    currentDriverId = null;
  }

  document.getElementById('driverTable').addEventListener('click', e => {
    if (e.target.closest('.action-col')) return;
    const row = e.target.closest('.clickable-row');
    if (row) openSidebar(row);
  });

  closeSidebarBtn.onclick = closeSidebar;
  overlay.onclick = closeSidebar;

  document.getElementById('toggleStatusBtn').onclick = function () {
    if (!currentDriverId || !confirm('Change driver status?')) return;
    fetch(`/drivers/${currentDriverId}/toggle-status/`, { method: 'POST', headers: { 'X-CSRFToken': csrftoken } })
      .then(r => r.json())
      .then(d => d.success ? (showToast(d.message, 'success'), setTimeout(() => location.reload(), 1000)) : showToast(d.error || 'Failed', 'error'));
  };

  function attachActionListeners(row) {
    row.querySelector('.action-view')?.addEventListener('click', e => { e.stopPropagation(); openSidebar(row); });
    row.querySelector('.action-edit')?.addEventListener('click', e => { 
    e.stopPropagation(); 
    window.location.href = `/drivers/${row.dataset.driverId}/edit/`;
});
    row.querySelector('.action-delete')?.addEventListener('click', e => {
      e.stopPropagation();
      if (!confirm('Delete this driver?')) return;
      fetch(`/drivers/${row.dataset.driverId}/delete/`, { method: 'POST', headers: { 'X-CSRFToken': csrftoken } })
        .then(r => r.json())
        .then(d => {
          if (d.success) {
            showToast(d.message, 'success');
            row.remove();
            allRows = allRows.filter(r => r !== row);
            filteredRows = filteredRows.filter(r => r !== row);
            renderPage();
            if (!filteredRows.length) showNoDataRow();
            closeSidebar();
          } else showToast(d.error || 'Delete failed', 'error');
        });
    });
  }

  document.querySelectorAll('#driverTable tbody tr.clickable-row').forEach(attachActionListeners);

  openAddModalBtn.onclick = () => addModal.style.display = 'flex';
  [closeAddModalBtn, cancelAddModalBtn].forEach(b => b.onclick = () => {
    addModal.style.display = 'none';
    addForm.reset();
    document.querySelectorAll('.file-name').forEach(s => { s.textContent = ''; s.style.color = ''; });
  });
  addModal.onclick = e => { if (e.target === addModal) addModal.style.display = 'none'; };

  addForm.onsubmit = function (e) {
    e.preventDefault();
    const formData = new FormData(this);

    fetch('{% url "add_driver" %}', {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken },
      body: formData
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        showToast(data.message, 'success');
        const noData = tbody.querySelector('tr td[colspan]');
        if (noData) noData.parentElement.remove();

        const tr = document.createElement('tr');
        tr.className = 'clickable-row';
        tr.dataset.driverId = data.driver.id;
        tr.dataset.driver = JSON.stringify(data.driver);

        tr.innerHTML = `
          <td>${data.driver.name}</td>
          <td>${data.driver.phone}</td>
          <td>${data.driver.owner}</td>
          <td>${data.driver.ownerPhone || data.driver.phone}</td>
          <td class="action-col">
            <div class="action-buttons">
              <button class="action-view" title="View"><i class="fas fa-eye"></i></button>
              <button class="action-edit" title="Edit"><i class="fas fa-edit"></i></button>
              <button class="action-delete" data-driver-id="${data.driver.id}" title="Delete"><i class="fas fa-trash"></i></button>
            </div>
          </td>
        `;

        tbody.prepend(tr);
        allRows.unshift(tr);
        filteredRows.unshift(tr);
        attachActionListeners(tr);
        currentPage = 1;
        renderPage();
        addModal.style.display = 'none';
        addForm.reset();
        document.querySelectorAll('.file-name').forEach(s => s.textContent = '');
      } else {
        showToast(data.error || 'Failed to add driver', 'error');
      }
    })
    .catch(() => showToast('Network error', 'error'));
  };

  function showNoDataRow() {
    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:50px;color:#6b7280;">
      No drivers found. Click "Add Driver" to get started.
    </td></tr>`;
  }

  function renderPage() {
    const start = (currentPage - 1) * perPage;
    const end = start + perPage;
    allRows.forEach(r => r.style.display = 'none');
    filteredRows.slice(start, end).forEach(r => r.style.display = '');

    const visibleEnd = Math.min(end, filteredRows.length);
    showingStart.textContent = filteredRows.length ? start + 1 : 0;
    showingEnd.textContent = visibleEnd;
    totalEntries.textContent = filteredRows.length;
    currentPageInfo.textContent = `Page ${currentPage}`;

    prevBtn.disabled = currentPage === 1;
    nextBtn.disabled = currentPage >= Math.ceil(filteredRows.length / perPage);
  }

  entriesSelect.onchange = () => { perPage = parseInt(entriesSelect.value); currentPage = 1; renderPage(); };
  prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; renderPage(); } };
  nextBtn.onclick = () => { if (currentPage < Math.ceil(filteredRows.length / perPage)) { currentPage++; renderPage(); } };

  initRows();
});
</script>

</body>
</html>

{% endblock %}